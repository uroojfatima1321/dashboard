<!DOCTYPE html>
<html lang="en">
<!--
################################################################################
#                    CONTEGRIS TEAM PERFORMANCE HUB v3.2                       #
#                    GOOGLE SHEETS API VERSION                                 #
#                    WITH LIGHT/DARK MODE SUPPORT                              #
################################################################################

================================================================================
WHAT IS THIS FILE?
================================================================================
A single HTML file that creates an interactive Team Performance Dashboard.
Contains HTML (structure), CSS (styling), and JavaScript (logic).

This version uses the Google Sheets API v4 to fetch data from a shared sheet.
Your sheet only needs "Anyone with the link can view" - NOT published to web.
Supports both Dark Mode (default) and Light Mode - toggle with the button in header.

================================================================================
HOW TO USE
================================================================================
1. Open this file in Chrome/Firefox/Edge
2. Data loads automatically from Google Sheets API
3. Click "Refresh Data" button to reload latest data
4. Toggle Light/Dark mode with the theme button
5. Excel upload is available as a backup option

================================================================================
GOOGLE SHEETS CONFIGURATION
================================================================================
This dashboard uses the Google Sheets API v4 to fetch data.
Your sheet only needs to be shared as "Anyone with the link can view" - 
it does NOT need to be published to web.

Configuration is in GOOGLE_SHEET_CONFIG:
- apiKey: Your Google Cloud API key
- spreadsheetId: The ID from your sheet URL
- sheetName: The tab name (e.g., "duration")

Current Settings:
- Spreadsheet ID: 1xmHPfZcs3iCRU4ae0XX4ffyK2FMbyCzmEWO0lAhP4GI
- Sheet Name: duration
- API Key: (configured)

================================================================================
REQUIRED COLUMNS (exact names)
================================================================================
Key, Issue Type, Summary, Assignee, Reporter, Labels, Components, Sprint,
Status, parent, Story Points, Original estimate, Time Spent, Created,
Resolved, Updated, Original Dev, Original QA, Bug Source, Dev Reopen,
QA Reopen, Required By, QA, Fix versions

================================================================================
TEAM DEFINITIONS (search these in JavaScript to edit)
================================================================================
JAFFER_TEAM: bilal, ali raza, talha, qasim, usaman, jaffer
EHSAN_TEAM: usama ashraf, faateh, zain chattha, zain ahmad, ehsan
QA_TEAM: adnan, huzaifa, touseef, haris, junaid, mahnoor

================================================================================
KPI CALCULATIONS
================================================================================
Total Tasks: Count where Issue Type NOT IN (Sub-task, QA Task)
Completed: Count where Status contains "Done" OR "Released"
Bugs: Count where Issue Type IN (Bug, Reassigned Bug)
Enhancements: Count where Issue Type = "Improvement"
Stories: Count where Issue Type = "Story"
Time Spent: SUM(Time Spent) / 3600 (converts seconds to hours)
QA Reopens: Count where QA Reopen > 0
New Features: Count where Labels contains "NewRequirement"
Bug Ratio: (Internal Bugs / Story Points Done) * 100 = %
Bug/Task Ratio: (Total Bugs / Completed Tasks) * 100

################################################################################
-->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Contegris Team Performance Hub</title>
    
    <!-- External Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    
    <style>
    /*
    ============================================================================
    CSS VARIABLES - DARK MODE (Default)
    ============================================================================
    Format: --name: #hexcolor;
    Usage: var(--name)
    */
    :root {
        --primary: #6366f1;
        --primary-dark: #4f46e5;
        --secondary: #22d3ee;
        --success: #10b981;
        --warning: #f59e0b;
        --danger: #ef4444;
        --bg-dark: #0f172a;
        --bg-card: #1e293b;
        --bg-card-hover: #334155;
        --bg-filter: #1a2332;
        --text-primary: #f1f5f9;
        --text-secondary: #94a3b8;
        --border: #334155;
        --gradient-1: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        --gradient-2: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        --gradient-3: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        --gradient-4: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        --gradient-5: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        --gradient-6: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
        --gradient-7: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        --shadow-color: rgba(0,0,0,0.3);
        --chart-text: #94a3b8;
        --chart-grid: rgba(148,163,184,0.1);
        --table-hover: rgba(99,102,241,0.1);
        --header-bg: linear-gradient(135deg, rgba(99,102,241,0.15), rgba(139,92,246,0.15));
        --kpi-value-gradient: linear-gradient(135deg, #fff, #e2e8f0);
        --logo-gradient: linear-gradient(135deg, #fff, #a5b4fc);
    }
    
    /*
    ============================================================================
    CSS VARIABLES - LIGHT MODE
    ============================================================================
    Applied when body has class "light-mode"
    */
    body.light-mode {
        --primary: #4f46e5;
        --primary-dark: #4338ca;
        --secondary: #0891b2;
        --success: #059669;
        --warning: #d97706;
        --danger: #dc2626;
        --bg-dark: #f8fafc;
        --bg-card: #ffffff;
        --bg-card-hover: #f1f5f9;
        --bg-filter: #f1f5f9;
        --text-primary: #1e293b;
        --text-secondary: #64748b;
        --border: #e2e8f0;
        --shadow-color: rgba(0,0,0,0.08);
        --chart-text: #64748b;
        --chart-grid: rgba(100,116,139,0.15);
        --table-hover: rgba(79,70,229,0.08);
        --header-bg: linear-gradient(135deg, rgba(79,70,229,0.08), rgba(139,92,246,0.08));
        --kpi-value-gradient: linear-gradient(135deg, #1e293b, #475569);
        --logo-gradient: linear-gradient(135deg, #1e293b, #4f46e5);
    }
    
    /* Light mode specific overrides */
    body.light-mode .kpi-card:hover {
        box-shadow: 0 15px 30px rgba(0,0,0,0.1);
    }
    body.light-mode .header {
        background: var(--header-bg);
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    body.light-mode .logo h1 {
        background: var(--logo-gradient);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }
    body.light-mode .kpi-value {
        background: var(--kpi-value-gradient);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }
    body.light-mode .filter-section-header {
        background: rgba(0,0,0,0.03);
    }
    body.light-mode .filter-section-header:hover {
        background: rgba(0,0,0,0.06);
    }
    body.light-mode .filters-header:hover {
        background: rgba(0,0,0,0.02);
    }
    body.light-mode .chart-card {
        box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    }
    body.light-mode .dropdown-panel {
        box-shadow: 0 10px 25px rgba(0,0,0,0.15);
    }
    body.light-mode .race-track {
        background: linear-gradient(180deg, #e2e8f0 0%, #cbd5e1 100%);
        border-color: #94a3b8;
    }
    body.light-mode .track-surface {
        background: 
            repeating-linear-gradient(
                90deg,
                transparent 0px,
                transparent 98px,
                rgba(0,0,0,0.05) 98px,
                rgba(0,0,0,0.05) 100px
            ),
            linear-gradient(180deg, #cbd5e1 0%, #94a3b8 100%);
    }
    body.light-mode .race-lane {
        background: rgba(255, 255, 255, 0.8);
    }
    body.light-mode .race-lane:hover {
        background: rgba(79, 70, 229, 0.15);
    }
    body.light-mode .welcome-state {
        background: var(--bg-card);
        border-color: var(--border);
    }
    body.light-mode .modal {
        box-shadow: 0 20px 50px rgba(0,0,0,0.2);
    }
    
    /* Theme Toggle Button */
    .theme-toggle {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 0.75rem;
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s;
        font-size: 0.85rem;
        color: var(--text-secondary);
    }
    .theme-toggle:hover {
        background: var(--bg-card-hover);
        color: var(--text-primary);
    }
    .theme-toggle .theme-icon {
        font-size: 1.1rem;
        transition: transform 0.3s;
    }
    .theme-toggle:hover .theme-icon {
        transform: rotate(20deg);
    }
    .theme-toggle .theme-label {
        font-weight: 500;
    }
    
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    html, body {
        overflow-x: hidden;
        max-width: 100vw;
    }
    
    body {
        font-family: 'Segoe UI', system-ui, sans-serif;
        background: var(--bg-dark);
        color: var(--text-primary);
        min-height: 100vh;
        line-height: 1.5;
        overflow-x: hidden;
    }
    
    /* Header */
    .header {
        background: linear-gradient(135deg, rgba(99,102,241,0.15), rgba(139,92,246,0.15));
        backdrop-filter: blur(20px);
        border-bottom: 1px solid var(--border);
        padding: 1rem 2rem;
        position: sticky;
        top: 0;
        z-index: 1000;
    }
    .header-content {
        max-width: 1920px;
        margin: 0 auto;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 1rem;
    }
    .logo { display: flex; align-items: center; gap: 0.75rem; }
    .logo-icon {
        width: 44px; height: 44px;
        background: var(--gradient-1);
        border-radius: 10px;
        display: flex; align-items: center; justify-content: center;
        font-weight: bold; font-size: 1.1rem; color: white;
    }
    .logo h1 {
        font-size: 1.4rem; font-weight: 700;
        background: linear-gradient(135deg, #fff, #a5b4fc);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }
    .header-actions { display: flex; align-items: center; gap: 1rem; flex-wrap: wrap; }
    .data-badge {
        display: flex; align-items: center; gap: 0.5rem;
        padding: 0.5rem 1rem; background: var(--bg-card);
        border-radius: 8px; font-size: 0.8rem;
        color: var(--text-secondary); border: 1px solid var(--border);
    }
    .data-badge.connected { border-color: var(--success); color: var(--success); }
    .data-badge .dot {
        width: 8px; height: 8px; border-radius: 50%;
        background: var(--text-secondary);
    }
    .data-badge.connected .dot { background: var(--success); animation: pulse 2s infinite; }
    @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.5} }
    
    /* Buttons */
    .btn {
        display: inline-flex; align-items: center; gap: 0.5rem;
        padding: 0.6rem 1.2rem; border-radius: 6px; border: none;
        cursor: pointer; font-weight: 600; font-size: 0.85rem;
        transition: all 0.2s;
    }
    .btn-primary { background: var(--primary); color: white; }
    .btn-primary:hover { background: var(--primary-dark); transform: translateY(-1px); }
    .btn-secondary { background: var(--bg-card); color: var(--text-secondary); border: 1px solid var(--border); }
    .btn-secondary:hover { background: var(--bg-card-hover); color: var(--text-primary); }
    .btn-success { background: var(--success); color: white; }
    .btn-icon { padding: 0.6rem; background: var(--bg-card); border: 1px solid var(--border); color: var(--text-secondary); border-radius: 6px; }
    .btn-icon:hover { background: var(--bg-card-hover); color: var(--text-primary); }
    #fileInput { display: none; }
    
    /* Collapsible Filters Section */
    .filters-wrapper {
        background: var(--bg-filter);
        border-bottom: 1px solid var(--border);
    }
    .filters-header {
        max-width: 1920px; margin: 0 auto;
        padding: 0.85rem 2rem;
        display: flex; justify-content: space-between; align-items: center;
        cursor: pointer;
        flex-wrap: wrap;
        gap: 0.75rem;
    }
    .filters-header:hover { background: rgba(0,0,0,0.02); }
    .filters-header-left {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        flex-wrap: wrap;
    }
    .filters-title {
        display: flex; align-items: center; gap: 0.75rem;
        font-weight: 600; font-size: 0.95rem;
    }
    .filters-title .icon { font-size: 1.2rem; }
    .filter-count {
        background: var(--primary); color: white;
        padding: 3px 10px; border-radius: 12px;
        font-size: 0.7rem; font-weight: 600;
    }
    .filter-count.zero {
        background: var(--text-secondary);
        opacity: 0.6;
    }
    
    /* Active Filter Tags in Header */
    .active-filter-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 0.4rem;
        align-items: center;
        max-width: 600px;
    }
    .active-filter-tag {
        display: inline-flex;
        align-items: center;
        gap: 0.3rem;
        background: rgba(99,102,241,0.15);
        border: 1px solid rgba(99,102,241,0.25);
        color: var(--primary);
        padding: 0.2rem 0.5rem;
        border-radius: 6px;
        font-size: 0.7rem;
        font-weight: 500;
        white-space: nowrap;
    }
    body.light-mode .active-filter-tag {
        background: rgba(79,70,229,0.1);
        border-color: rgba(79,70,229,0.2);
    }
    .active-filter-tag .tag-label {
        color: var(--text-secondary);
        font-weight: 400;
    }
    .active-filter-tag .tag-value {
        color: var(--text-primary);
        font-weight: 600;
        max-width: 100px;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    .active-filter-tag .tag-remove {
        cursor: pointer;
        color: var(--text-secondary);
        font-size: 0.9rem;
        line-height: 1;
        margin-left: 0.25rem;
        font-weight: 700;
        transition: color 0.2s;
    }
    .active-filter-tag .tag-remove:hover {
        color: #ef4444;
    }
    .active-filter-more {
        background: var(--bg-card);
        border: 1px solid var(--border);
        color: var(--text-secondary);
        padding: 0.2rem 0.5rem;
        border-radius: 6px;
        font-size: 0.7rem;
        font-weight: 500;
    }
    
    /* Info Tooltip Styles - Fixed Positioning for No Clipping */
    .info-tooltip {
        position: relative;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 14px;
        height: 14px;
        background: var(--text-secondary);
        color: var(--bg-dark);
        border-radius: 50%;
        font-size: 9px;
        font-weight: 700;
        cursor: help;
        margin-left: 4px;
        opacity: 0.6;
        transition: opacity 0.2s;
        vertical-align: middle;
    }
    .info-tooltip:hover {
        opacity: 1;
    }
    .tooltip-text {
        position: fixed;
        background: #1e293b;
        color: #f1f5f9;
        padding: 10px 14px;
        border-radius: 8px;
        font-size: 0.8rem;
        font-weight: 400;
        max-width: 280px;
        text-align: left;
        z-index: 99999;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.2s, visibility 0.2s;
        box-shadow: 0 4px 20px rgba(0,0,0,0.4);
        border: 1px solid #334155;
        line-height: 1.5;
        pointer-events: none;
        white-space: normal;
        word-wrap: break-word;
    }
    .tooltip-text.visible {
        opacity: 1;
        visibility: visible;
    }
    body.light-mode .tooltip-text {
        background: #1e293b;
        color: #f1f5f9;
        border-color: #334155;
    }
    body.light-mode .info-tooltip {
        background: #64748b;
        color: white;
    }
    
    .filters-toggle {
        display: flex; align-items: center; gap: 0.5rem;
        color: var(--text-secondary); font-size: 0.85rem;
    }
    .filters-toggle .arrow { transition: transform 0.3s; }
    .filters-wrapper.collapsed .filters-toggle .arrow { transform: rotate(-90deg); }
    .filters-wrapper.collapsed .filters-content { display: none; }
    
    .filters-content {
        max-width: 1920px; margin: 0 auto;
        padding: 0 2rem 1.5rem;
    }
    
    /* Filter Sections */
    .filter-sections {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 1rem;
    }
    .filter-section {
        background: var(--bg-card);
        border-radius: 10px;
        overflow: visible;
        border: 1px solid var(--border);
    }
    .filter-section-header {
        padding: 0.75rem 1rem;
        background: rgba(0,0,0,0.2);
        display: flex; align-items: center; gap: 0.5rem;
        font-weight: 600; font-size: 0.8rem;
        text-transform: uppercase; letter-spacing: 0.5px;
        color: var(--text-secondary);
        cursor: pointer;
        border-bottom: 1px solid var(--border);
    }
    .filter-section-header .section-icon { font-size: 1rem; }
    .filter-section-header:hover { background: rgba(0,0,0,0.3); }
    .filter-section.collapsed .filter-section-body { display: none; }
    .filter-section-header .toggle { margin-left: auto; transition: transform 0.2s; }
    .filter-section.collapsed .filter-section-header .toggle { transform: rotate(-90deg); }
    
    .filter-section-body { padding: 1rem; overflow: visible; }
    .filter-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
        gap: 0.75rem;
        overflow: visible;
    }
    .filter-group { display: flex; flex-direction: column; gap: 0.4rem; overflow: visible; }
    .filter-group label {
        font-size: 0.7rem; font-weight: 600;
        text-transform: uppercase; letter-spacing: 0.5px;
        color: var(--text-secondary);
    }
    .filter-group select, .filter-group input {
        background: var(--bg-dark);
        border: 1px solid var(--border);
        border-radius: 6px;
        padding: 0.5rem 0.75rem;
        color: var(--text-primary);
        font-size: 0.85rem;
    }
    .filter-group select:focus, .filter-group input:focus {
        outline: none; border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(99,102,241,0.2);
    }
    
    /* Custom Dropdown Multi-Select */
    .dropdown-container {
        position: relative;
        width: 100%;
    }
    .dropdown-btn {
        width: 100%;
        background: var(--bg-dark);
        border: 1px solid var(--border);
        border-radius: 6px;
        padding: 0.5rem 0.75rem;
        color: var(--text-primary);
        font-size: 0.8rem;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        min-height: 38px;
        transition: all 0.2s;
    }
    .dropdown-btn:hover {
        border-color: var(--primary);
    }
    .dropdown-btn.active {
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(99,102,241,0.2);
    }
    .dropdown-btn .text {
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        flex: 1;
        text-align: left;
    }
    .dropdown-btn .arrow {
        margin-left: 0.5rem;
        transition: transform 0.2s;
        font-size: 0.6rem;
    }
    .dropdown-btn.active .arrow {
        transform: rotate(180deg);
    }
    .dropdown-panel {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: 6px;
        margin-top: 4px;
        z-index: 9999;
        display: none;
        box-shadow: 0 10px 25px rgba(0,0,0,0.5);
    }
    .dropdown-panel.open {
        display: block;
    }
    .dropdown-search {
        padding: 0.5rem;
        border-bottom: 1px solid var(--border);
    }
    .dropdown-search input {
        width: 100%;
        background: var(--bg-dark);
        border: 1px solid var(--border);
        border-radius: 4px;
        padding: 0.4rem 0.6rem;
        color: var(--text-primary);
        font-size: 0.8rem;
    }
    .dropdown-search input::placeholder {
        color: var(--text-secondary);
    }
    .dropdown-search input:focus {
        outline: none;
        border-color: var(--primary);
    }
    .dropdown-actions {
        display: flex;
        gap: 0.5rem;
        padding: 0.4rem 0.5rem;
        border-bottom: 1px solid var(--border);
        background: var(--bg-dark);
    }
    .dropdown-actions button {
        flex: 1;
        padding: 0.3rem 0.5rem;
        font-size: 0.7rem;
        background: transparent;
        border: 1px solid var(--border);
        border-radius: 4px;
        color: var(--text-secondary);
        cursor: pointer;
        transition: all 0.2s;
    }
    .dropdown-actions button:hover {
        background: var(--primary);
        border-color: var(--primary);
        color: white;
    }
    .dropdown-list {
        max-height: 200px;
        overflow-y: auto;
        padding: 0.25rem 0;
    }
    .dropdown-item {
        display: flex;
        align-items: center;
        padding: 0.5rem 0.75rem;
        cursor: pointer;
        transition: background 0.15s;
        font-size: 0.8rem;
        gap: 0.5rem;
        background: transparent;
        border-bottom: 1px solid rgba(255,255,255,0.05);
    }
    .dropdown-item:hover {
        background: rgba(99,102,241,0.25);
    }
    .dropdown-item.hidden {
        display: none;
    }
    .dropdown-item input[type="checkbox"] {
        width: 18px;
        height: 18px;
        cursor: pointer;
        appearance: none;
        -webkit-appearance: none;
        -moz-appearance: none;
        background: var(--bg-dark);
        border: 2px solid var(--primary);
        border-radius: 4px;
        position: relative;
        flex-shrink: 0;
        transition: all 0.2s;
    }
    .dropdown-item input[type="checkbox"]:hover {
        border-color: var(--secondary);
        box-shadow: 0 0 8px rgba(99,102,241,0.4);
    }
    .dropdown-item input[type="checkbox"]:checked {
        background: var(--primary);
        border-color: var(--primary);
    }
    .dropdown-item input[type="checkbox"]:checked::after {
        content: '‚úì';
        position: absolute;
        color: white;
        font-size: 12px;
        font-weight: bold;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
    }
    .dropdown-item span {
        flex: 1;
        color: var(--text-primary);
        font-weight: 500;
    }
    .dropdown-empty {
        padding: 1rem;
        text-align: center;
        color: var(--text-secondary);
        font-size: 0.8rem;
        font-style: italic;
    }
    
    .filter-actions {
        display: flex; gap: 0.75rem; margin-top: 1rem;
        padding-top: 1rem; border-top: 1px solid var(--border);
        justify-content: flex-end;
    }
    
    /* Filter Summary */
    .filter-summary {
        margin-top: 1rem;
        border-top: 1px solid var(--border);
        padding-top: 1rem;
    }
    .filter-summary-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        cursor: pointer;
        padding: 0.5rem;
        background: var(--bg-dark);
        border-radius: 6px;
        font-size: 0.8rem;
        color: var(--text-secondary);
    }
    .filter-summary-header:hover {
        background: var(--bg-card-hover);
    }
    .filter-summary-content {
        display: none;
        margin-top: 0.75rem;
    }
    .filter-summary-content.show {
        display: block;
    }
    .filter-summary-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 0.75rem;
    }
    .filter-summary-item {
        background: var(--bg-dark);
        border-radius: 6px;
        padding: 0.75rem;
    }
    .filter-summary-item h4 {
        font-size: 0.7rem;
        text-transform: uppercase;
        color: var(--primary);
        margin-bottom: 0.5rem;
        letter-spacing: 0.5px;
    }
    .filter-summary-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 0.3rem;
    }
    .filter-tag {
        background: rgba(99,102,241,0.15);
        color: var(--text-secondary);
        padding: 0.2rem 0.5rem;
        border-radius: 4px;
        font-size: 0.7rem;
    }
    .filter-tag.more {
        background: rgba(148,163,184,0.2);
        font-style: italic;
    }
    
    /* Main Content */
    .main-content { 
        max-width: 1920px; 
        margin: 0 auto; 
        padding: 1.5rem 2rem;
        overflow-x: hidden;
    }
    
    /* Welcome/Placeholder State */
    .welcome-state {
        background: var(--bg-card);
        border-radius: 16px;
        padding: 3rem;
        text-align: center;
        border: 2px dashed var(--border);
        margin-bottom: 2rem;
    }
    .welcome-state.hidden { display: none; }
    .welcome-icon { font-size: 4rem; margin-bottom: 1rem; opacity: 0.7; }
    .welcome-state h2 { font-size: 1.5rem; margin-bottom: 0.5rem; }
    .welcome-state p { color: var(--text-secondary); margin-bottom: 1.5rem; max-width: 500px; margin-left: auto; margin-right: auto; }
    .welcome-actions { display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap; }
    
    /* Sample Data Preview */
    .sample-preview {
        margin-top: 2rem;
        padding-top: 2rem;
        border-top: 1px solid var(--border);
    }
    .sample-preview h3 {
        font-size: 0.9rem;
        color: var(--text-secondary);
        margin-bottom: 1rem;
        text-transform: uppercase;
        letter-spacing: 1px;
    }
    .sample-kpis {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 1rem;
    }
    .sample-kpi {
        background: var(--bg-dark);
        padding: 1rem;
        border-radius: 8px;
        text-align: center;
    }
    .sample-kpi .value {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--text-secondary);
    }
    .sample-kpi .label {
        font-size: 0.7rem;
        color: var(--text-secondary);
        text-transform: uppercase;
    }
    
    /* KPI Cards - Single Row - INCREASED SIZE */
    .kpi-section { margin-bottom: 2rem; }
    .section-header {
        display: flex; justify-content: space-between; align-items: center;
        margin-bottom: 1.25rem;
    }
    .section-title {
        font-size: 1.1rem; font-weight: 600;
        color: var(--text-secondary);
        text-transform: uppercase; letter-spacing: 1px;
    }
    .kpi-grid {
        display: flex;
        flex-wrap: nowrap;
        gap: 1rem;
        overflow-x: auto;
        padding-bottom: 0.5rem;
    }
    .kpi-grid::-webkit-scrollbar { height: 6px; }
    .kpi-grid::-webkit-scrollbar-track { background: var(--bg-dark); border-radius: 3px; }
    .kpi-grid::-webkit-scrollbar-thumb { background: var(--primary); border-radius: 3px; }
    .kpi-card {
        background: var(--bg-card);
        border-radius: 12px; 
        padding: 1.25rem;
        position: relative; overflow: hidden;
        transition: all 0.3s;
        animation: fadeInUp 0.5s ease forwards;
        opacity: 0;
        flex: 1 1 0;
        min-width: 160px;
        border: 1px solid var(--border);
    }
    .kpi-card.wide {
        flex: 2 1 0;
        min-width: 240px;
    }
    .kpi-card:nth-child(1){animation-delay:0.05s}
    .kpi-card:nth-child(2){animation-delay:0.1s}
    .kpi-card:nth-child(3){animation-delay:0.15s}
    .kpi-card:nth-child(4){animation-delay:0.2s}
    .kpi-card:nth-child(5){animation-delay:0.25s}
    .kpi-card:nth-child(6){animation-delay:0.3s}
    @keyframes fadeInUp { from{opacity:0;transform:translateY(20px)} to{opacity:1;transform:translateY(0)} }
    .kpi-card:hover { transform: translateY(-4px); box-shadow: 0 15px 30px var(--shadow-color); }
    .kpi-card::before { content:''; position:absolute; top:0; left:0; right:0; height:4px; }
    .kpi-card.gradient-1::before { background: var(--gradient-1); }
    .kpi-card.gradient-2::before { background: var(--gradient-2); }
    .kpi-card.gradient-3::before { background: var(--gradient-3); }
    .kpi-card.gradient-4::before { background: var(--gradient-4); }
    .kpi-card.gradient-5::before { background: var(--gradient-5); }
    .kpi-card.gradient-6::before { background: var(--gradient-6); }
    .kpi-card.gradient-7::before { background: var(--gradient-7); }
    .kpi-header { display: flex; align-items: center; gap: 0.6rem; margin-bottom: 0.5rem; }
    .kpi-icon {
        width: 40px; height: 40px; border-radius: 10px;
        display: flex; align-items: center; justify-content: center;
        font-size: 1.1rem; flex-shrink: 0;
    }
    .kpi-card.gradient-1 .kpi-icon { background: rgba(99,102,241,0.2); }
    .kpi-card.gradient-2 .kpi-icon { background: rgba(240,147,251,0.2); }
    .kpi-card.gradient-3 .kpi-icon { background: rgba(79,172,254,0.2); }
    .kpi-card.gradient-4 .kpi-icon { background: rgba(67,233,123,0.2); }
    .kpi-card.gradient-5 .kpi-icon { background: rgba(250,112,154,0.2); }
    .kpi-card.gradient-6 .kpi-icon { background: rgba(168,237,234,0.2); }
    .kpi-card.gradient-7 .kpi-icon { background: rgba(102,126,234,0.2); }
    .kpi-label { font-size: 0.7rem; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600; }
    .kpi-value {
        font-size: 1.75rem; font-weight: 700;
        background: var(--kpi-value-gradient);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }
    .kpi-subtitle { font-size: 0.65rem; color: var(--text-secondary); margin-top: 0.2rem; }
    .kpi-sub-values {
        display: flex;
        gap: 1rem;
        margin-top: 0.35rem;
    }
    .kpi-sub-item {
        text-align: center;
        flex: 1;
    }
    .kpi-sub-item .sub-value {
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--text-primary);
    }
    .kpi-sub-item .sub-label {
        font-size: 0.6rem;
        color: var(--text-secondary);
        text-transform: uppercase;
    }
    
    /* Charts */
    .charts-section {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 1.5rem;
        margin-bottom: 1.5rem;
        max-width: 100%;
        overflow: hidden;
    }
    @media (max-width: 1200px) { .charts-section { grid-template-columns: 1fr; } }
    .chart-card {
        background: var(--bg-card);
        border-radius: 12px; padding: 1.25rem;
        animation: fadeIn 0.6s ease forwards;
        opacity: 0;
        min-width: 0;
        overflow: hidden;
    }
    .chart-card.full-width { grid-column: span 2; }
    @media (max-width: 1200px) { .chart-card.full-width { grid-column: span 1; } }
    @keyframes fadeIn { from{opacity:0} to{opacity:1} }
    .chart-header {
        display: flex; justify-content: space-between; align-items: flex-start;
        margin-bottom: 1rem; flex-wrap: wrap; gap: 0.75rem;
    }
    .chart-title-group { flex: 1; min-width: 200px; }
    .chart-title { font-size: 1rem; font-weight: 600; margin-bottom: 0.25rem; }
    .chart-subtitle { font-size: 0.75rem; color: var(--text-secondary); }
    .chart-controls { display: flex; gap: 0.5rem; align-items: center; }
    .chart-controls label { font-size: 0.7rem; color: var(--text-secondary); text-transform: uppercase; }
    .chart-controls select {
        background: var(--bg-dark); border: 1px solid var(--border);
        border-radius: 4px; padding: 0.35rem 0.5rem;
        color: var(--text-primary); font-size: 0.75rem;
    }
    .ratio-tags { display: flex; gap: 0.5rem; flex-wrap: wrap; margin-bottom: 0.75rem; }
    .ratio-tag {
        background: rgba(99,102,241,0.2); color: var(--primary);
        padding: 0.3rem 0.6rem; border-radius: 4px;
        font-size: 0.7rem; font-weight: 600;
    }
    .ratio-tag.warning { background: rgba(245,158,11,0.2); color: var(--warning); }
    .ratio-tag.danger { background: rgba(239,68,68,0.2); color: var(--danger); }
    .ratio-tag.success { background: rgba(16,185,129,0.2); color: var(--success); }
    
    /* Chart Navigation Arrows */
    .chart-nav-arrows {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    .chart-nav-btn {
        background: var(--bg-dark);
        border: 1px solid var(--border);
        color: var(--text-primary);
        width: 28px;
        height: 28px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.75rem;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
    }
    .chart-nav-btn:hover {
        background: var(--primary);
        border-color: var(--primary);
        color: white;
    }
    .chart-nav-btn:disabled {
        opacity: 0.4;
        cursor: not-allowed;
    }
    .chart-nav-label {
        font-size: 0.85rem;
        font-weight: 600;
        color: var(--text-primary);
        min-width: 50px;
        text-align: center;
    }
    
    /* Applied Filters Display */
    .applied-filters-container {
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 0.75rem 1rem;
        margin-bottom: 1rem;
    }
    .applied-filters-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
    }
    .applied-filters-label {
        font-size: 0.8rem;
        font-weight: 600;
        color: var(--text-secondary);
    }
    .clear-all-filters-btn {
        background: rgba(239,68,68,0.15);
        border: 1px solid rgba(239,68,68,0.3);
        color: #ef4444;
        padding: 0.3rem 0.6rem;
        border-radius: 4px;
        font-size: 0.7rem;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    .clear-all-filters-btn:hover {
        background: rgba(239,68,68,0.25);
    }
    .applied-filters-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 0.4rem;
    }
    .filter-tag {
        background: rgba(99,102,241,0.15);
        border: 1px solid rgba(99,102,241,0.3);
        color: var(--primary);
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        font-size: 0.7rem;
        display: flex;
        align-items: center;
        gap: 0.3rem;
    }
    .filter-tag-label {
        color: var(--text-secondary);
        font-weight: 500;
    }
    .filter-tag-value {
        color: var(--text-primary);
        font-weight: 600;
    }
    .filter-tag-remove {
        cursor: pointer;
        color: var(--text-secondary);
        font-size: 0.9rem;
        line-height: 1;
        margin-left: 0.2rem;
    }
    .filter-tag-remove:hover {
        color: #ef4444;
    }
    
    .chart-container { position: relative; height: 280px; }
    .chart-container.tall { height: 350px; }
    .chart-container.short { height: 220px; }
    
    /* Tables */
    .table-container { overflow-x: auto; overflow-y: auto; }
    .table-container.scrollable { max-height: 400px; }
    .table-controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.75rem;
        gap: 0.75rem;
    }
    .table-search {
        flex: 1;
        position: relative;
    }
    .table-search input {
        width: 100%;
        background: var(--bg-dark);
        border: 1px solid var(--border);
        border-radius: 6px;
        padding: 0.5rem 0.75rem 0.5rem 2rem;
        color: var(--text-primary);
        font-size: 0.8rem;
    }
    .table-search input::placeholder {
        color: var(--text-secondary);
    }
    .table-search::before {
        content: 'üîç';
        position: absolute;
        left: 0.6rem;
        top: 50%;
        transform: translateY(-50%);
        font-size: 0.75rem;
        opacity: 0.6;
    }
    .table-toggle-btns {
        display: flex;
        gap: 0.25rem;
    }
    .table-toggle-btn {
        background: var(--bg-dark);
        border: 1px solid var(--border);
        border-radius: 4px;
        padding: 0.3rem 0.5rem;
        font-size: 0.7rem;
        color: var(--text-secondary);
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }
    .table-toggle-btn:hover {
        background: var(--primary);
        border-color: var(--primary);
        color: white;
    }
    .data-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
    .data-table th, .data-table td {
        padding: 0.6rem 0.75rem; text-align: left;
        border-bottom: 1px solid var(--border);
    }
    .data-table th {
        background: var(--bg-dark); font-weight: 600;
        text-transform: uppercase; font-size: 0.7rem;
        letter-spacing: 0.5px; color: var(--text-secondary);
        position: sticky; top: 0; z-index: 10;
    }
    .data-table tbody tr:hover { background: rgba(99,102,241,0.1); }
    .data-table td.num, .data-table th.num { text-align: right; }
    
    /* Collapsible Tables */
    .collapsible-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; table-layout: fixed; }
    .collapsible-table th {
        background: var(--bg-dark); font-weight: 600;
        text-transform: uppercase; font-size: 0.7rem;
        letter-spacing: 0.5px; color: var(--text-secondary);
        position: sticky; top: 0; z-index: 10;
        padding: 0.6rem 0.75rem; text-align: left;
        border-bottom: 1px solid var(--border);
    }
    .collapsible-table th.num { text-align: right; }
    .collapsible-table td { padding: 0.5rem 0.75rem; border-bottom: 1px solid var(--border); word-wrap: break-word; overflow-wrap: break-word; }
    .collapsible-table td.num { text-align: right; }
    .group-header {
        background: var(--bg-card-hover);
        cursor: pointer; transition: background 0.2s;
    }
    .group-header:hover { background: rgba(99,102,241,0.2); }
    .group-header td { padding: 0.75rem; font-weight: 600; }
    .group-header .toggle-icon { display: inline-block; width: 20px; text-align: center; margin-right: 0.5rem; transition: transform 0.2s; }
    .group-header.expanded .toggle-icon { transform: rotate(90deg); }
    .detail-row { display: none; background: var(--bg-dark); }
    .detail-row.visible { display: table-row; }
    .detail-row td {
        padding: 0.5rem 0.75rem;
        border-bottom: 1px solid rgba(51,65,85,0.5);
        font-size: 0.8rem; color: var(--text-secondary);
    }
    .detail-row td.num { text-align: right; }
    .summary-value {
        display: inline-block; background: rgba(99,102,241,0.15);
        padding: 0.2rem 0.5rem; border-radius: 4px;
        font-size: 0.75rem; margin-left: 0.5rem;
    }
    
    /* Table Action Buttons */
    .table-actions {
        display: flex;
        gap: 0.5rem;
        align-items: center;
    }
    .table-action-btn {
        background: var(--bg-dark);
        border: 1px solid var(--border);
        border-radius: 6px;
        padding: 0.35rem 0.6rem;
        font-size: 0.75rem;
        color: var(--text-secondary);
        cursor: pointer;
        transition: all 0.2s;
        display: inline-flex;
        align-items: center;
        gap: 0.3rem;
    }
    .table-action-btn:hover {
        background: var(--primary);
        border-color: var(--primary);
        color: white;
    }
    
    /* Scorecards */
    .scorecard-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
        gap: 0.75rem;
    }
    .scorecard-item {
        background: var(--bg-dark); border-radius: 10px;
        padding: 0.875rem; display: flex;
        align-items: center; gap: 0.875rem;
        transition: all 0.3s; border: 1px solid transparent;
    }
    .scorecard-item:hover { background: var(--bg-card-hover); border-color: var(--border); }
    .scorecard-avatar {
        width: 45px; height: 45px; border-radius: 10px;
        background: var(--gradient-1);
        display: flex; align-items: center; justify-content: center;
        font-weight: 700; font-size: 1rem; flex-shrink: 0;
    }
    .scorecard-avatar.qa { background: var(--gradient-3); }
    .scorecard-info { flex: 1; min-width: 0; }
    .scorecard-name {
        font-weight: 600; font-size: 0.9rem; margin-bottom: 0.35rem;
        white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }
    .scorecard-stats { display: flex; flex-wrap: wrap; gap: 0.35rem; }
    .scorecard-stat {
        background: var(--bg-card); padding: 0.15rem 0.4rem;
        border-radius: 3px; font-size: 0.7rem; color: var(--text-secondary);
    }
    .scorecard-stat.highlight { background: rgba(99,102,241,0.2); color: var(--primary); }
    
    /* Race Track - Realistic Animated Design */
    .race-track-container {
        display: flex;
        gap: 1.5rem;
        align-items: flex-start;
    }
    .race-track {
        flex: 1;
        background: linear-gradient(180deg, #2d3748 0%, #1a202c 100%);
        border-radius: 12px;
        padding: 0;
        position: relative;
        min-height: 350px;
        border: 3px solid #4a5568;
        overflow: hidden;
    }
    /* Grass borders */
    .race-track::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 15px;
        background: repeating-linear-gradient(
            90deg,
            #22c55e 0px,
            #22c55e 20px,
            #16a34a 20px,
            #16a34a 40px
        );
        z-index: 2;
    }
    .race-track::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 15px;
        background: repeating-linear-gradient(
            90deg,
            #22c55e 0px,
            #22c55e 20px,
            #16a34a 20px,
            #16a34a 40px
        );
        z-index: 2;
    }
    /* Track surface with asphalt texture */
    .track-surface {
        background: 
            repeating-linear-gradient(
                90deg,
                transparent 0px,
                transparent 98px,
                rgba(255,255,255,0.1) 98px,
                rgba(255,255,255,0.1) 100px
            ),
            linear-gradient(180deg, #374151 0%, #1f2937 100%);
        padding: 25px 15px;
        min-height: 320px;
        position: relative;
    }
    /* Red/white curbs on sides */
    .track-curb-left, .track-curb-right {
        position: absolute;
        top: 15px;
        bottom: 15px;
        width: 8px;
        background: repeating-linear-gradient(
            to bottom,
            #ef4444 0px,
            #ef4444 15px,
            #ffffff 15px,
            #ffffff 30px
        );
        z-index: 3;
    }
    .track-curb-left { left: 0; }
    .track-curb-right { right: 0; }
    /* Start/Finish line */
    .start-finish-line {
        position: absolute;
        left: 50px;
        top: 15px;
        bottom: 15px;
        width: 20px;
        background: repeating-linear-gradient(
            to bottom,
            #ffffff 0px,
            #ffffff 10px,
            #1f2937 10px,
            #1f2937 20px
        );
        opacity: 0.8;
        z-index: 1;
    }
    /* Checkered finish area */
    .checkered-finish {
        position: absolute;
        right: 20px;
        top: 15px;
        bottom: 15px;
        width: 40px;
        background: 
            repeating-conic-gradient(
                #ffffff 0deg 90deg,
                #1a1a2e 90deg 180deg
            );
        background-size: 20px 20px;
        opacity: 0.6;
        z-index: 1;
    }
    .track-lanes {
        display: flex;
        flex-direction: column;
        gap: 0.4rem;
        position: relative;
        z-index: 5;
        padding: 0 30px;
    }
    /* Animated Race Lane */
    .race-lane {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 0.75rem;
        background: rgba(17, 24, 39, 0.7);
        border-radius: 6px;
        position: relative;
        transition: background 0.3s;
        border-left: 4px solid transparent;
        overflow: visible;
        min-height: 50px;
    }
    .race-lane:hover {
        background: rgba(99, 102, 241, 0.2);
    }
    .race-lane.first-place {
        background: linear-gradient(90deg, rgba(250, 204, 21, 0.2) 0%, rgba(17, 24, 39, 0.85) 30%);
        border-left-color: #fbbf24;
    }
    .race-lane.second-place {
        background: linear-gradient(90deg, rgba(192, 192, 192, 0.2) 0%, rgba(17, 24, 39, 0.85) 30%);
        border-left-color: #c0c0c0;
    }
    .race-lane.third-place {
        background: linear-gradient(90deg, rgba(205, 127, 50, 0.2) 0%, rgba(17, 24, 39, 0.85) 30%);
        border-left-color: #cd7f32;
    }
    /* Race animation track line */
    .race-lane-track {
        position: absolute;
        left: 60px;
        right: 10px;
        top: 50%;
        height: 6px;
        background: linear-gradient(90deg, rgba(255,255,255,0.05), rgba(255,255,255,0.15), rgba(34,197,94,0.3));
        transform: translateY(-50%);
        border-radius: 3px;
        z-index: 0;
    }
    .racer-position {
        width: 28px;
        height: 28px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 800;
        font-size: 0.8rem;
        flex-shrink: 0;
        box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        z-index: 2;
    }
    .racer-position.gold { 
        background: linear-gradient(135deg, #fbbf24, #f59e0b, #d97706); 
        color: #1a1a2e; 
        box-shadow: 0 0 12px rgba(251, 191, 36, 0.5);
    }
    .racer-position.silver { 
        background: linear-gradient(135deg, #e5e7eb, #9ca3af, #6b7280); 
        color: #1a1a2e; 
    }
    .racer-position.bronze { 
        background: linear-gradient(135deg, #cd7f32, #b45309, #92400e); 
        color: white; 
    }
    .racer-position.other { 
        background: var(--bg-card); 
        color: var(--text-secondary);
        border: 1px solid var(--border);
    }
    /* Animated Car Container - Full width movement */
    .racer-car-container {
        position: absolute;
        left: 55px;
        right: 80px;
        top: 50%;
        transform: translateY(-50%);
        height: 40px;
        z-index: 10;
    }
    .racer-car {
        font-size: 1.8rem;
        position: absolute;
        left: 0;
        top: 50%;
        transform: translateY(-50%) scaleX(-1);
        filter: drop-shadow(2px 2px 3px rgba(0,0,0,0.6));
        transition: none;
        z-index: 10;
    }
    .racer-car.racing {
        animation: carWiggle 0.1s ease-in-out infinite;
    }
    .racer-car.finished {
        animation: carCelebrate 0.3s ease-in-out infinite;
    }
    @keyframes carWiggle {
        0%, 100% { transform: translateY(-50%) scaleX(-1) rotate(-2deg) scale(1.05); }
        50% { transform: translateY(-50%) scaleX(-1) rotate(2deg) scale(1.05); }
    }
    @keyframes carCelebrate {
        0%, 100% { transform: translateY(-50%) scaleX(-1) scale(1.1); }
        50% { transform: translateY(-50%) scaleX(-1) scale(1.3); }
    }
    /* Speed lines behind car when racing */
    .speed-lines {
        position: absolute;
        left: -25px;
        top: 50%;
        transform: translateY(-50%);
        opacity: 0;
        transition: opacity 0.2s;
    }
    .racer-car.racing ~ .speed-lines {
        opacity: 0.8;
    }
    .speed-line {
        height: 2px;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.9));
        margin: 4px 0;
        border-radius: 1px;
    }
    /* Racer info - positioned at start */
    .racer-info {
        position: absolute;
        left: 55px;
        top: 50%;
        transform: translateY(-50%);
        z-index: 1;
        opacity: 0.3;
        transition: opacity 0.3s;
    }
    .race-lane:not(.racing-active) .racer-info {
        opacity: 1;
        position: relative;
        left: auto;
        transform: none;
        flex: 1;
        min-width: 0;
    }
    .racer-name {
        font-weight: 700;
        font-size: 0.85rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        text-transform: capitalize;
    }
    .race-lane.first-place .racer-name {
        color: #fbbf24;
    }
    .racer-stats {
        font-size: 0.65rem;
        color: var(--text-secondary);
        margin-top: 2px;
    }
    /* Finish name label - shows when car reaches end */
    .finish-name {
        position: absolute;
        right: 85px;
        top: 50%;
        transform: translateY(-50%);
        font-weight: 700;
        font-size: 0.8rem;
        color: #22c55e;
        opacity: 0;
        transition: opacity 0.3s;
        white-space: nowrap;
        z-index: 15;
        text-shadow: 0 0 10px rgba(34, 197, 94, 0.5);
    }
    .finish-name.show {
        opacity: 1;
    }
    .racer-score {
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
        font-weight: 800;
        font-size: 0.95rem;
        min-width: 55px;
        text-align: right;
        font-family: 'Courier New', monospace;
        z-index: 2;
    }
    .race-lane.first-place .racer-score { color: #fbbf24; }
    .race-lane.second-place .racer-score { color: #c0c0c0; }
    .race-lane.third-place .racer-score { color: #cd7f32; }
    /* Trophy icons for podium */
    .podium-trophy {
        font-size: 1rem;
        margin-left: 0.25rem;
    }
    /* Race Controls */
    .race-controls {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 0.75rem;
        padding: 0 30px;
    }
    .race-btn {
        padding: 0.4rem 1rem;
        border: none;
        border-radius: 6px;
        font-weight: 600;
        font-size: 0.8rem;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 0.4rem;
    }
    .race-btn.start {
        background: linear-gradient(135deg, #22c55e, #16a34a);
        color: white;
    }
    .race-btn.start:hover {
        background: linear-gradient(135deg, #16a34a, #15803d);
        transform: scale(1.05);
    }
    .race-btn.stop {
        background: linear-gradient(135deg, #ef4444, #dc2626);
        color: white;
    }
    .race-btn.stop:hover {
        background: linear-gradient(135deg, #dc2626, #b91c1c);
    }
    .race-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
    }
    .race-status {
        padding: 0.4rem 0.75rem;
        background: var(--bg-dark);
        border-radius: 6px;
        font-size: 0.75rem;
        color: var(--text-secondary);
        display: flex;
        align-items: center;
        gap: 0.4rem;
    }
    .race-status.racing {
        color: #22c55e;
        background: rgba(34, 197, 94, 0.1);
    }
    .race-status.finished {
        color: #fbbf24;
        background: rgba(251, 191, 36, 0.1);
    }
    /* Winner Celebration Overlay */
    .winner-celebration {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.85);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 100;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.5s;
    }
    .winner-celebration.show {
        opacity: 1;
        pointer-events: auto;
    }
    .winner-trophy {
        font-size: 4rem;
        animation: trophyBounce 0.5s ease-in-out infinite alternate;
    }
    @keyframes trophyBounce {
        from { transform: scale(1) rotate(-5deg); }
        to { transform: scale(1.1) rotate(5deg); }
    }
    .winner-text {
        font-size: 1.5rem;
        font-weight: 800;
        color: #fbbf24;
        margin: 0.5rem 0;
        text-shadow: 0 0 20px rgba(251, 191, 36, 0.5);
    }
    .winner-name {
        font-size: 1.1rem;
        color: white;
        margin-bottom: 0.25rem;
    }
    .winner-podium {
        display: flex;
        align-items: flex-end;
        gap: 1rem;
        margin-top: 1rem;
    }
    .winner-spot {
        text-align: center;
        color: white;
    }
    .winner-spot .medal {
        font-size: 2rem;
    }
    .winner-spot .name {
        font-size: 0.8rem;
        margin-top: 0.25rem;
        max-width: 80px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    .winner-spot.first { order: 2; }
    .winner-spot.second { order: 1; }
    .winner-spot.third { order: 3; }
    .confetti {
        position: absolute;
        width: 10px;
        height: 10px;
        background: #fbbf24;
        animation: confettiFall 3s linear infinite;
    }
    @keyframes confettiFall {
        0% { transform: translateY(-100%) rotate(0deg); opacity: 1; }
        100% { transform: translateY(400px) rotate(720deg); opacity: 0; }
    }
    /* Race legend */
    .race-legend {
        background: linear-gradient(180deg, var(--bg-dark) 0%, rgba(15,23,42,0.9) 100%);
        border-radius: 10px;
        padding: 1rem;
        min-width: 190px;
        border: 1px solid var(--border);
    }
    .race-legend-title {
        font-weight: 700;
        font-size: 0.9rem;
        margin-bottom: 0.75rem;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    .race-legend-item {
        font-size: 0.75rem;
        color: var(--text-secondary);
        padding: 0.4rem 0;
        border-bottom: 1px solid var(--border);
        display: flex;
        justify-content: space-between;
    }
    .race-legend-item:last-child {
        border-bottom: none;
    }
    .race-legend-item .pts {
        color: var(--primary);
        font-weight: 600;
    }
    .race-legend-item.negative .pts {
        color: #ef4444;
    }
    /* Podium display */
    .race-podium {
        display: flex;
        justify-content: center;
        align-items: flex-end;
        gap: 0.5rem;
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid var(--border);
    }
    .podium-spot {
        text-align: center;
        font-size: 0.65rem;
    }
    .podium-spot.first { order: 2; }
    .podium-spot.second { order: 1; }
    .podium-spot.third { order: 3; }
    .podium-block {
        width: 50px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        border-radius: 4px 4px 0 0;
    }
    .podium-spot.first .podium-block {
        height: 45px;
        background: linear-gradient(180deg, #fbbf24, #d97706);
        color: #1a1a2e;
    }
    .podium-spot.second .podium-block {
        height: 35px;
        background: linear-gradient(180deg, #c0c0c0, #6b7280);
        color: #1a1a2e;
    }
    .podium-spot.third .podium-block {
        height: 25px;
        background: linear-gradient(180deg, #cd7f32, #92400e);
        color: white;
    }
    .podium-name {
        margin-top: 0.25rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 55px;
        color: var(--text-secondary);
    }
    
    /* Sprint Progress */
    .sprint-progress-item { margin-bottom: 1.25rem; }
    .sprint-header { display: flex; justify-content: space-between; margin-bottom: 0.4rem; }
    .sprint-name { font-weight: 600; font-size: 0.9rem; }
    .sprint-count { color: var(--text-secondary); font-size: 0.8rem; }
    .progress-bar { height: 10px; background: var(--bg-dark); border-radius: 5px; overflow: hidden; display: flex; }
    .progress-segment { height: 100%; transition: width 0.5s; }
    .progress-segment.done { background: var(--success); }
    .progress-segment.testing { background: var(--secondary); }
    .progress-segment.review { background: var(--warning); }
    .progress-segment.progress { background: var(--primary); }
    .progress-segment.todo { background: var(--text-secondary); }
    .sprint-stats { display: flex; gap: 1rem; margin-top: 0.4rem; font-size: 0.75rem; color: var(--text-secondary); flex-wrap: wrap; }
    .legend {
        display: flex; flex-wrap: wrap; gap: 1rem; margin-top: 1rem;
        justify-content: center; padding-top: 1rem;
        border-top: 1px solid var(--border);
    }
    .legend-item { display: flex; align-items: center; gap: 0.4rem; font-size: 0.75rem; color: var(--text-secondary); }
    .legend-color { width: 12px; height: 12px; border-radius: 3px; }
    
    /* Loading */
    .loading-overlay {
        position: fixed; top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(15,23,42,0.95);
        display: flex; flex-direction: column;
        align-items: center; justify-content: center;
        z-index: 9999; transition: opacity 0.3s;
    }
    body.light-mode .loading-overlay {
        background: rgba(248,250,252,0.95);
    }
    .loading-overlay.hidden { opacity: 0; pointer-events: none; }
    .loader { width: 50px; height: 50px; border: 4px solid var(--border); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
    .loading-text { margin-top: 1rem; color: var(--text-secondary); }
    @keyframes spin { to { transform: rotate(360deg); } }
    @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    @keyframes slideOut { from { transform: translateX(0); opacity: 1; } to { transform: translateX(100%); opacity: 0; } }
    
    /* Scrollbar */
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: var(--bg-dark); }
    ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--text-secondary); }
    
    /* Google Sheets Modal */
    .modal-overlay {
        position: fixed; top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0,0,0,0.7); z-index: 2000;
        display: flex; align-items: center; justify-content: center;
    }
    .modal-overlay.hidden { display: none; }
    .modal {
        background: var(--bg-card); border-radius: 16px;
        padding: 2rem; max-width: 500px; width: 90%;
        border: 1px solid var(--border);
    }
    .modal h2 { margin-bottom: 1rem; }
    .modal p { color: var(--text-secondary); margin-bottom: 1rem; font-size: 0.9rem; }
    .modal input[type="text"] {
        width: 100%; padding: 0.75rem; border-radius: 8px;
        border: 1px solid var(--border); background: var(--bg-dark);
        color: var(--text-primary); margin-bottom: 1rem;
    }
    .modal-actions { display: flex; gap: 1rem; justify-content: flex-end; }
    
    /* Responsive */
    @media (max-width: 768px) {
        .header-content { flex-direction: column; align-items: flex-start; }
        .filter-sections { grid-template-columns: 1fr; }
        .kpi-grid { grid-template-columns: repeat(2, 1fr); }
    }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay hidden" id="loadingOverlay">
        <div class="loader"></div>
        <div class="loading-text">Loading data...</div>
    </div>
    
    <!-- Google Sheets Modal -->
    <div class="modal-overlay hidden" id="sheetsModal">
        <div class="modal">
            <h2>üìä Connect Google Sheets</h2>
            <p>Enter your Google Sheet published CSV URL. To get this:</p>
            <ol style="color: var(--text-secondary); font-size: 0.85rem; margin-bottom: 1rem; padding-left: 1.5rem;">
                <li>Open your Google Sheet</li>
                <li>File ‚Üí Share ‚Üí Publish to web</li>
                <li>Select your sheet, choose CSV</li>
                <li>Click Publish and copy the URL</li>
            </ol>
            <input type="text" id="sheetsUrl" placeholder="https://docs.google.com/spreadsheets/d/e/...">
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeSheetsModal()">Cancel</button>
                <button class="btn btn-success" onclick="loadFromSheets()">Connect</button>
            </div>
        </div>
    </div>
    
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="logo">
                <div>
                    <h1>Contegris Team Performance Hub</h1>
                </div>
            </div>
            <div class="header-actions">
                <div class="data-badge" id="dataBadge">
                    <span class="dot"></span>
                    <span id="dataStatus">No data loaded</span>
                </div>
                <input type="file" id="fileInput" accept=".xlsx,.xls,.csv">
                <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">
                    üìÅ Upload Excel
                </button>
                <button class="btn btn-secondary" onclick="refreshFromSheets()" title="Refresh data from Google Sheets">
                    üîÑ Refresh Data
                </button>
                <button class="theme-toggle" onclick="toggleTheme()" title="Toggle light/dark mode">
                    <span class="theme-icon" id="themeIcon">üåô</span>
                    <span class="theme-label" id="themeLabel">Dark</span>
                </button>
                <button class="btn-icon" onclick="toggleFullscreen()" title="Fullscreen">‚õ∂</button>
            </div>
        </div>
    </header>
    
    <!-- Collapsible Filters -->
    <div class="filters-wrapper" id="filtersWrapper">
        <div class="filters-header" onclick="toggleFilters()">
            <div class="filters-header-left">
                <div class="filters-title">
                    <span class="icon">üîç</span>
                    <span>Filters & Controls</span>
                    <span class="filter-count" id="activeFilterCount">0 active</span>
                </div>
                <div class="active-filter-tags" id="headerFilterTags">
                    <!-- Active filter tags will be inserted here by JavaScript -->
                </div>
            </div>
            <div class="filters-toggle">
                <span>Click to expand/collapse</span>
                <span class="arrow">‚ñº</span>
            </div>
        </div>
        <div class="filters-content">
            <div class="filter-sections">
                <!-- Project Filters -->
                <div class="filter-section" id="projectFilters">
                    <div class="filter-section-header" onclick="toggleFilterSection('projectFilters')">
                        <span class="section-icon">üìã</span>
                        <span>Project Filters</span>
                        <span class="toggle">‚ñº</span>
                    </div>
                    <div class="filter-section-body">
                        <div class="filter-grid">
                            <div class="filter-group">
                                <label>Sprint</label>
                                <div class="dropdown-container" id="dropdownSprint"></div>
                            </div>
                            <div class="filter-group">
                                <label>Release</label>
                                <div class="dropdown-container" id="dropdownRelease"></div>
                            </div>
                            <div class="filter-group">
                                <label>Products</label>
                                <div class="dropdown-container" id="dropdownComponent"></div>
                            </div>
                            <div class="filter-group">
                                <label>Issue Type</label>
                                <div class="dropdown-container" id="dropdownIssueType"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Team Filters -->
                <div class="filter-section" id="teamFilters">
                    <div class="filter-section-header" onclick="toggleFilterSection('teamFilters')">
                        <span class="section-icon">üë•</span>
                        <span>Team Filters</span>
                        <span class="toggle">‚ñº</span>
                    </div>
                    <div class="filter-section-body">
                        <div class="filter-grid">
                            <div class="filter-group">
                                <label>Team</label>
                                <div class="dropdown-container" id="dropdownTeam"></div>
                            </div>
                            <div class="filter-group">
                                <label>Members</label>
                                <div class="dropdown-container" id="dropdownAssignee"></div>
                            </div>
                            <div class="filter-group">
                                <label>Status</label>
                                <div class="dropdown-container" id="dropdownStatus"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Date Filters -->
                <div class="filter-section" id="dateFilters">
                    <div class="filter-section-header" onclick="toggleFilterSection('dateFilters')">
                        <span class="section-icon">üìÖ</span>
                        <span>Date Filters</span>
                        <span class="toggle">‚ñº</span>
                    </div>
                    <div class="filter-section-body">
                        <div class="filter-grid">
                            <div class="filter-group">
                                <label>Date Type</label>
                                <select id="filterDateType">
                                    <option value="created">Created</option>
                                    <option value="updated">Updated</option>
                                    <option value="resolved">Resolved</option>
                                    <option value="none">None</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label>From</label>
                                <input type="date" id="filterDateFrom">
                            </div>
                            <div class="filter-group">
                                <label>To</label>
                                <input type="date" id="filterDateTo">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="filter-actions">
                <button class="btn btn-secondary" onclick="resetFilters()">‚Ü∫ Reset All</button>
                <button class="btn btn-primary" onclick="applyFilters()">‚úì Apply Filters</button>
            </div>
            
            <!-- Filter Summary - Shows all available options -->
            <div class="filter-summary" id="filterSummary" style="display:none;">
                <div class="filter-summary-header" onclick="toggleFilterSummary()">
                    <span>üìã Available Filter Options</span>
                    <span class="toggle" id="filterSummaryToggle">‚ñº</span>
                </div>
                <div class="filter-summary-content" id="filterSummaryContent">
                    <div class="filter-summary-grid" id="filterSummaryGrid"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Main Content -->
    <main class="main-content">
        <!-- Welcome State (shown on first load) -->
        <div class="welcome-state" id="welcomeState">
            <div class="welcome-icon">üìä</div>
            <h2>Welcome to Contegris Team Performance Hub</h2>
            <p>Your project data is loading automatically from Google Sheets...</p>
            <div class="welcome-actions">
                <button class="btn btn-primary" onclick="refreshFromSheets()">
                    üîÑ Load Data from Google Sheets
                </button>
                <button class="btn btn-secondary" onclick="document.getElementById('fileInput').click()">
                    üìÅ Upload Excel File (Backup)
                </button>
            </div>
            <div class="sample-preview">
                <h3>Preview with sample data</h3>
                <div class="sample-kpis">
                    <div class="sample-kpi"><div class="value">--</div><div class="label">Tasks</div></div>
                    <div class="sample-kpi"><div class="value">--</div><div class="label">Bugs</div></div>
                    <div class="sample-kpi"><div class="value">--</div><div class="label">Stories</div></div>
                    <div class="sample-kpi"><div class="value">--</div><div class="label">Done</div></div>
                </div>
            </div>
        </div>
        
        <!-- Dashboard Content -->
        <div id="dashboardContent" style="display:none;">
            <!-- KPIs -->
            <section class="kpi-section">
                <div class="section-header">
                    <div class="section-title">üìä Work Summary</div>
                </div>
                <div class="kpi-grid">
                    <!-- 1. Total Work Items -->
                    <div class="kpi-card gradient-1">
                        <div class="kpi-header"><div class="kpi-icon">üìã</div><div class="kpi-label">Total Work<span class="info-tooltip" data-tooltip="Count of all main tasks excluding Sub-tasks and QA Tasks">i</span></div></div>
                        <div class="kpi-value" id="kpiTotalTasks">0</div>
                        <div class="kpi-subtitle">Main tasks</div>
                    </div>
                    
                    <!-- 2. Task State Card -->
                    <div class="kpi-card gradient-3 wide">
                        <div class="kpi-header"><div class="kpi-icon">üìä</div><div class="kpi-label">Task State<span class="info-tooltip" data-tooltip="Distribution of tasks by current status: To Do, In Progress, or Done">i</span></div></div>
                        <div class="kpi-sub-values">
                            <div class="kpi-sub-item">
                                <div class="sub-value" id="kpiToDo">0</div>
                                <div class="sub-label">To Do</div>
                            </div>
                            <div class="kpi-sub-item">
                                <div class="sub-value" id="kpiInProgress">0</div>
                                <div class="sub-label">In Progress</div>
                            </div>
                            <div class="kpi-sub-item">
                                <div class="sub-value" id="kpiDone">0</div>
                                <div class="sub-label">Done</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 3. Bugs Card (Internal + Stability + Technical Debts) -->
                    <div class="kpi-card gradient-2 wide">
                        <div class="kpi-header"><div class="kpi-icon">üêõ</div><div class="kpi-label">Bugs Breakdown<span class="info-tooltip" data-tooltip="Internal: bugs found during development. Stability: items tagged for stability. Tech Debt: technical debt items.">i</span></div></div>
                        <div class="kpi-sub-values">
                            <div class="kpi-sub-item">
                                <div class="sub-value" id="kpiInternalBugs">0</div>
                                <div class="sub-label">Internal</div>
                            </div>
                            <div class="kpi-sub-item">
                                <div class="sub-value" id="kpiStabilityItems">0</div>
                                <div class="sub-label">Stability</div>
                            </div>
                            <div class="kpi-sub-item">
                                <div class="sub-value" id="kpiTechDebt">0</div>
                                <div class="sub-label">Tech Debt</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 4. Bug Ratio Card -->
                    <div class="kpi-card gradient-5">
                        <div class="kpi-header"><div class="kpi-icon">üìà</div><div class="kpi-label">Bug Ratio<span class="info-tooltip" data-tooltip="Percentage of bugs relative to completed story points. Lower is better. Formula: (Internal Bugs √∑ Story Points Done) √ó 100">i</span></div></div>
                        <div class="kpi-value" id="kpiBugRatio">0%</div>
                        <div class="kpi-subtitle">(Bugs √∑ SP) √ó 100</div>
                    </div>
                    
                    <!-- 5. Production Bugs -->
                    <div class="kpi-card gradient-6">
                        <div class="kpi-header"><div class="kpi-icon">üö®</div><div class="kpi-label">Prod Bugs<span class="info-tooltip" data-tooltip="Bugs found in production environment after release">i</span></div></div>
                        <div class="kpi-value" id="kpiProductionBugs">0</div>
                        <div class="kpi-subtitle">Production</div>
                    </div>
                    
                    <!-- 6. Story Points Card -->
                    <div class="kpi-card gradient-4 wide">
                        <div class="kpi-header"><div class="kpi-icon">üìê</div><div class="kpi-label">Story Points<span class="info-tooltip" data-tooltip="Effort estimation units. Done: completed items. Total: all estimated items.">i</span></div></div>
                        <div class="kpi-sub-values">
                            <div class="kpi-sub-item">
                                <div class="sub-value" id="kpiSPDone">0</div>
                                <div class="sub-label">Done</div>
                            </div>
                            <div class="kpi-sub-item">
                                <div class="sub-value" id="kpiTotalSP">0</div>
                                <div class="sub-label">Total</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 7. Features Card -->
                    <div class="kpi-card gradient-7 wide">
                        <div class="kpi-header"><div class="kpi-icon">‚ú®</div><div class="kpi-label">Features<span class="info-tooltip" data-tooltip="New Features: items tagged with NewRequirement. Enhancements: improvements to existing functionality.">i</span></div></div>
                        <div class="kpi-sub-values">
                            <div class="kpi-sub-item">
                                <div class="sub-value" id="kpiNewFeatures">0</div>
                                <div class="sub-label">New Features</div>
                            </div>
                            <div class="kpi-sub-item">
                                <div class="sub-value" id="kpiEnhancements">0</div>
                                <div class="sub-label">Enhancements</div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- Charts -->
            <section class="charts-section">
                <!-- 2. Sprint Progress -->
                <div class="chart-card full-width">
                    <div class="chart-header">
                        <div class="chart-title-group">
                            <div class="chart-title">üèÉ Sprint Progress</div>
                            <div class="chart-subtitle">Status distribution</div>
                        </div>
                    </div>
                    <div id="sprintProgressContainer"></div>
                    <div class="legend">
                        <div class="legend-item"><div class="legend-color" style="background:var(--success)"></div><span>Done</span></div>
                        <div class="legend-item"><div class="legend-color" style="background:var(--secondary)"></div><span>Testing</span></div>
                        <div class="legend-item"><div class="legend-color" style="background:var(--warning)"></div><span>Review</span></div>
                        <div class="legend-item"><div class="legend-color" style="background:var(--primary)"></div><span>In Progress</span></div>
                        <div class="legend-item"><div class="legend-color" style="background:var(--text-secondary)"></div><span>To Do</span></div>
                    </div>
                </div>
                
                <!-- 3. Product Features -->
                <div class="chart-card">
                    <div class="chart-header">
                        <div class="chart-title-group">
                            <div class="chart-title">üöÄ Product Features</div>
                            <div class="chart-subtitle">Deployed items</div>
                        </div>
                    </div>
                    <div class="chart-container"><canvas id="chartProductionFeatures"></canvas></div>
                </div>
                
                <!-- 4. Work Items by Source -->
                <div class="chart-card">
                    <div class="chart-header">
                        <div class="chart-title-group">
                            <div class="chart-title">üìã Work Items by Source</div>
                            <div class="chart-subtitle">Required By</div>
                        </div>
                    </div>
                    <div class="chart-container"><canvas id="chartReleaseBySource"></canvas></div>
                </div>
                
                <!-- 5. Time by Category -->
                <div class="chart-card">
                    <div class="chart-header">
                        <div class="chart-title-group">
                            <div class="chart-title">‚è∞ Time by Category</div>
                            <div class="chart-subtitle">Hours per type</div>
                        </div>
                    </div>
                    <div class="chart-container"><canvas id="chartTimeByCategory"></canvas></div>
                </div>
                
                <!-- 6. Product Team -->
                <div class="chart-card full-width">
                    <div class="chart-header">
                        <div class="chart-title-group">
                            <div class="chart-title">üì¶ Product Team</div>
                            <div class="chart-subtitle">Members per product with task summaries</div>
                        </div>
                        <div class="table-actions">
                            <span class="table-action-btn" onclick="expandAllGroups('tableProductTeam')" title="Expand All">üìÇ</span>
                            <span class="table-action-btn" onclick="collapseAllGroups('tableProductTeam')" title="Collapse All">üìÅ</span>
                        </div>
                    </div>
                    <div class="table-search">
                        <input type="text" placeholder="Search products or members..." oninput="searchTable('tableProductTeam', this.value)">
                    </div>
                    <div class="table-container">
                        <table class="collapsible-table" id="tableProductTeam" style="table-layout:fixed;width:100%">
                            <thead><tr><th style="width:15%">Product / Member</th><th style="width:8%">Role<span class="info-tooltip" data-tooltip="Developer or QA role">i</span></th><th class="num" style="width:6%">Tasks<span class="info-tooltip" data-tooltip="Number of tasks assigned">i</span></th><th class="num" style="width:8%">Est.<span class="info-tooltip" data-tooltip="Total original time estimate in hours">i</span></th><th class="num" style="width:8%">Spent<span class="info-tooltip" data-tooltip="Total actual time logged in hours">i</span></th><th style="width:55%">Task Summary</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
                
                <!-- 7. Stability Line Chart -->
                <div class="chart-card full-width">
                    <div class="chart-header">
                        <div class="chart-title-group">
                            <div class="chart-title">üõ°Ô∏è Stability Overview</div>
                            <div class="chart-subtitle">Stability items over time (showing last 12 months)</div>
                        </div>
                        <div class="chart-nav-arrows">
                            <button class="chart-nav-btn" onclick="navigateStabilityChart(-1)" title="Previous Year">‚óÄ</button>
                            <span id="stabilityYearLabel" class="chart-nav-label">2025</span>
                            <button class="chart-nav-btn" onclick="navigateStabilityChart(1)" title="Next Year">‚ñ∂</button>
                        </div>
                    </div>
                    <div class="chart-container"><canvas id="chartStabilityOverview"></canvas></div>
                </div>
                
                <!-- 8. Developer Tasks -->
                <div class="chart-card">
                    <div class="chart-header">
                        <div class="chart-title-group">
                            <div class="chart-title">üë®‚Äçüíª Developer Tasks</div>
                            <div class="chart-subtitle">Tasks assigned by developer</div>
                        </div>
                        <div class="table-actions">
                            <span class="table-action-btn" onclick="expandAllGroups('tableDevWork')" title="Expand All">üìÇ</span>
                            <span class="table-action-btn" onclick="collapseAllGroups('tableDevWork')" title="Collapse All">üìÅ</span>
                        </div>
                    </div>
                    <div class="table-search">
                        <input type="text" placeholder="Search developers..." oninput="searchTable('tableDevWork', this.value)">
                    </div>
                    <div class="table-container scrollable" style="max-height:350px">
                        <table class="collapsible-table" id="tableDevWork">
                            <thead><tr><th style="width:20%">Developer / Issue</th><th style="width:24%">Summary</th><th class="num" style="width:10%">Type<span class="info-tooltip" data-tooltip="Issue type: Bug, Story, Improvement, etc.">i</span></th><th class="num" style="width:10%">Status<span class="info-tooltip" data-tooltip="Current workflow status">i</span></th><th class="num" style="width:8%">SP<span class="info-tooltip" data-tooltip="Story Points - effort estimation">i</span></th><th class="num" style="width:10%">Committed<span class="info-tooltip" data-tooltip="Original time estimate in hours">i</span></th><th class="num" style="width:10%">Spent<span class="info-tooltip" data-tooltip="Actual time logged in hours">i</span></th><th class="num" style="width:8%">Total</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
                
                <!-- 10. Bug Ratio ‚Äì Team Jaffer -->
                <div class="chart-card">
                    <div class="chart-header">
                        <div class="chart-title-group">
                            <div class="chart-title">üë®‚Äçüíª Bug Ratio ‚Äì Team Jaffer</div>
                            <div class="chart-subtitle">TL: Jaffer</div>
                        </div>
                    </div>
                    <div class="ratio-tags" id="jafferRatioTags"></div>
                    <div class="chart-container"><canvas id="chartJafferBugRatio"></canvas></div>
                </div>
                
                <!-- 11. Bug Ratio ‚Äì Team Ehsan -->
                <div class="chart-card">
                    <div class="chart-header">
                        <div class="chart-title-group">
                            <div class="chart-title">üë®‚Äçüíª Bug Ratio ‚Äì Team Ehsan</div>
                            <div class="chart-subtitle">TL: Ehsan</div>
                        </div>
                    </div>
                    <div class="ratio-tags" id="ehsanRatioTags"></div>
                    <div class="chart-container"><canvas id="chartEhsanBugRatio"></canvas></div>
                </div>
                
                <!-- Dev Estimation vs Logged Table -->
                <div class="chart-card full-width">
                    <div class="chart-header">
                        <div class="chart-title-group">
                            <div class="chart-title">‚è±Ô∏è Dev Estimation vs Logged</div>
                            <div class="chart-subtitle">Work Ratio = Logged / Estimate</div>
                        </div>
                        <div class="table-actions">
                            <span class="table-action-btn" onclick="expandAllGroups('tableDevEstimation')" title="Expand All">üìÇ Expand</span>
                            <span class="table-action-btn" onclick="collapseAllGroups('tableDevEstimation')" title="Collapse All">üìÅ Collapse</span>
                        </div>
                    </div>
                    <div class="table-search">
                        <input type="text" placeholder="Search developers..." oninput="searchTable('tableDevEstimation', this.value)">
                    </div>
                    <div class="table-container" style="max-height:400px">
                        <table class="collapsible-table" id="tableDevEstimation">
                            <thead><tr><th>Dev / Key</th><th>Summary</th><th>Type<span class="info-tooltip" data-tooltip="Issue type: Bug, Story, Improvement, etc.">i</span></th><th class="num">SP<span class="info-tooltip" data-tooltip="Story Points - effort estimation">i</span></th><th class="num">Est (h)<span class="info-tooltip" data-tooltip="Original time estimate in hours">i</span></th><th class="num">Log (h)<span class="info-tooltip" data-tooltip="Actual time logged in hours">i</span></th><th class="num">Ratio<span class="info-tooltip" data-tooltip="Logged √∑ Estimated ratio. Below 1 = under estimate, above 1 = over estimate">i</span></th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
                
                <!-- 12. QA Work Assigned Details -->
                <div class="chart-card full-width">
                    <div class="chart-header">
                        <div class="chart-title-group">
                            <div class="chart-title">üìã QA Work Assigned Details</div>
                            <div class="chart-subtitle">Click rows to expand</div>
                        </div>
                        <div class="table-actions">
                            <span class="table-action-btn" onclick="expandAllGroups('tableQADetail')" title="Expand All">üìÇ Expand</span>
                            <span class="table-action-btn" onclick="collapseAllGroups('tableQADetail')" title="Collapse All">üìÅ Collapse</span>
                        </div>
                    </div>
                    <div class="table-search">
                        <input type="text" placeholder="Search details..." oninput="searchTable('tableQADetail', this.value)">
                    </div>
                    <div class="table-container" style="max-height:400px">
                        <table class="collapsible-table" id="tableQADetail">
                            <thead><tr><th style="width:15%">QA / Key</th><th style="width:30%">Summary</th><th style="width:12%">Type<span class="info-tooltip" data-tooltip="Issue type: Bug, Story, Improvement, etc.">i</span></th><th style="width:13%">Status<span class="info-tooltip" data-tooltip="Current workflow status">i</span></th><th class="num" style="width:10%">Est (h)<span class="info-tooltip" data-tooltip="Original time estimate in hours">i</span></th><th class="num" style="width:10%">Logged (h)<span class="info-tooltip" data-tooltip="Actual time logged in hours">i</span></th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Work Assigned to QA -->
                <div class="chart-card">
                    <div class="chart-header">
                        <div class="chart-title-group">
                            <div class="chart-title">üß™ Work Assigned to QA</div>
                            <div class="chart-subtitle">By QA member (count)</div>
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="data-table" id="tableQAWork">
                            <thead><tr><th>QA</th><th class="num">Stability<span class="info-tooltip" data-tooltip="Items tagged with stability label">i</span></th><th class="num">Internal Bugs<span class="info-tooltip" data-tooltip="Bugs found during development (includes unspecified)">i</span></th><th class="num">Enhancements<span class="info-tooltip" data-tooltip="Improvements to existing functionality">i</span></th><th class="num">New Features<span class="info-tooltip" data-tooltip="Story type items">i</span></th><th class="num">Other</th><th class="num">Committed<span class="info-tooltip" data-tooltip="Total original time estimate in hours">i</span></th><th class="num">Spent<span class="info-tooltip" data-tooltip="Total actual time logged in hours">i</span></th><th class="num">Total</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Work Status by Category -->
                <div class="chart-card">
                    <div class="chart-header">
                        <div class="chart-title-group">
                            <div class="chart-title">üìä Work Status by Category</div>
                            <div class="chart-subtitle">Status distribution across task types</div>
                        </div>
                    </div>
                    <div class="chart-container"><canvas id="chartQAProgress"></canvas></div>
                </div>
                
                <!-- QA Reopen Summary -->
                <div class="chart-card full-width">
                    <div class="chart-header">
                        <div class="chart-title-group">
                            <div class="chart-title">üîÑ QA Reopen Summary</div>
                            <div class="chart-subtitle">Click rows to expand</div>
                        </div>
                        <div class="table-actions">
                            <span class="table-action-btn" onclick="expandAllGroups('tableQAReopen')" title="Expand All">üìÇ Expand</span>
                            <span class="table-action-btn" onclick="collapseAllGroups('tableQAReopen')" title="Collapse All">üìÅ Collapse</span>
                        </div>
                    </div>
                    <div class="table-search">
                        <input type="text" placeholder="Search QA reopens..." oninput="searchTable('tableQAReopen', this.value)">
                    </div>
                    <div class="table-container" style="max-height:350px">
                        <table class="collapsible-table" id="tableQAReopen">
                            <thead><tr><th style="width:20%">QA / Issue</th><th style="width:35%">Summary</th><th class="num" style="width:15%">Reopens<span class="info-tooltip" data-tooltip="Number of times issue was reopened by QA">i</span></th><th class="num" style="width:15%">Est (h)<span class="info-tooltip" data-tooltip="Original time estimate in hours">i</span></th><th class="num" style="width:15%">Logged (h)<span class="info-tooltip" data-tooltip="Actual time logged in hours">i</span></th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
                
                <!-- 13. Developer Scorecard -->
                <div class="chart-card full-width">
                    <div class="chart-header">
                        <div class="chart-title-group">
                            <div class="chart-title">üë®‚Äçüíª Developer Scorecard</div>
                            <div class="chart-subtitle">Dev Team Performance</div>
                        </div>
                    </div>
                    <div class="scorecard-grid" id="devScorecardGrid"></div>
                </div>
                
                <!-- 13. QA Scorecard -->
                <div class="chart-card full-width">
                    <div class="chart-header">
                        <div class="chart-title-group">
                            <div class="chart-title">üß™ QA Scorecard</div>
                            <div class="chart-subtitle">QA Team Performance</div>
                        </div>
                    </div>
                    <div class="scorecard-grid" id="qaScorecardGrid"></div>
                </div>
                
                <!-- 14. Developer Race Track -->
                <div class="chart-card full-width">
                    <div class="chart-header">
                        <div class="chart-title-group">
                            <div class="chart-title">üèéÔ∏è Developer Race</div>
                            <div class="chart-subtitle">Performance Race - Who's Leading the Pack?</div>
                        </div>
                    </div>
                    <div class="race-track-container">
                        <div class="race-track" id="devRaceTrack">
                            <div class="track-curb-left"></div>
                            <div class="track-curb-right"></div>
                            <div class="start-finish-line"></div>
                            <div class="checkered-finish"></div>
                            <div class="track-surface">
                                <div class="race-controls">
                                    <button class="race-btn start" id="devRaceStart" onclick="startDevRace()">
                                        üèÅ Start Race
                                    </button>
                                    <button class="race-btn stop" id="devRaceStop" onclick="stopDevRace()" disabled>
                                        ‚èπÔ∏è Stop
                                    </button>
                                    <div class="race-status" id="devRaceStatus">
                                        <span>‚è∏Ô∏è</span> Ready
                                    </div>
                                </div>
                                <div class="track-lanes" id="devTrackLanes"></div>
                            </div>
                            <div class="winner-celebration" id="devWinnerCelebration">
                                <div class="winner-trophy">üèÜ</div>
                                <div class="winner-text">RACE COMPLETE!</div>
                                <div class="winner-podium" id="devWinnerPodium"></div>
                            </div>
                        </div>
                        <div class="race-legend">
                            <div class="race-legend-title">üèÜ Scoring</div>
                            <div class="race-legend-item">‚úÖ Done Tasks <span class="pts">+10</span></div>
                            <div class="race-legend-item">üìê Story Points <span class="pts">+5</span></div>
                            <div class="race-legend-item negative">üêõ Bugs <span class="pts">-15</span></div>
                            <div class="race-legend-item negative">üîÑ Reopens <span class="pts">-10</span></div>
                            <div class="race-podium" id="devPodium"></div>
                        </div>
                    </div>
                </div>
                
                <!-- 15. QA Race Track -->
                <div class="chart-card full-width">
                    <div class="chart-header">
                        <div class="chart-title-group">
                            <div class="chart-title">üèéÔ∏è QA Race</div>
                            <div class="chart-subtitle">QA Performance Race - Who's Leading the Pack?</div>
                        </div>
                    </div>
                    <div class="race-track-container">
                        <div class="race-track" id="qaRaceTrack">
                            <div class="track-curb-left"></div>
                            <div class="track-curb-right"></div>
                            <div class="start-finish-line"></div>
                            <div class="checkered-finish"></div>
                            <div class="track-surface">
                                <div class="race-controls">
                                    <button class="race-btn start" id="qaRaceStart" onclick="startQARace()">
                                        üèÅ Start Race
                                    </button>
                                    <button class="race-btn stop" id="qaRaceStop" onclick="stopQARace()" disabled>
                                        ‚èπÔ∏è Stop
                                    </button>
                                    <div class="race-status" id="qaRaceStatus">
                                        <span>‚è∏Ô∏è</span> Ready
                                    </div>
                                </div>
                                <div class="track-lanes" id="qaTrackLanes"></div>
                            </div>
                            <div class="winner-celebration" id="qaWinnerCelebration">
                                <div class="winner-trophy">üèÜ</div>
                                <div class="winner-text">RACE COMPLETE!</div>
                                <div class="winner-podium" id="qaWinnerPodium"></div>
                            </div>
                        </div>
                        <div class="race-legend">
                            <div class="race-legend-title">üèÜ Scoring</div>
                            <div class="race-legend-item">üêõ Bugs Found <span class="pts">+5</span></div>
                            <div class="race-legend-item">‚úÖ Verified <span class="pts">+10</span></div>
                            <div class="race-legend-item">üí° Enhancements <span class="pts">+8</span></div>
                            <div class="race-legend-item">‚è±Ô∏è Hours Logged <span class="pts">+2</span></div>
                            <div class="race-podium" id="qaPodium"></div>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </main>
    <script>
    /*
    ################################################################################
    #                           JAVASCRIPT SECTION                                 #
    #                    All Dashboard Logic and Calculations                      #
    ################################################################################
    
    This section contains ALL the code that makes the dashboard work:
    - Loading data from Excel or Google Sheets
    - Processing and filtering data
    - Calculating metrics (KPIs)
    - Creating charts and tables
    
    ================================================================================
    HOW TO FIND THINGS IN THIS CODE:
    ================================================================================
    Use Ctrl+F (or Cmd+F on Mac) to search for:
    
    - "TEAM DEFINITIONS" - To edit team member lists
    - "STATUS GROUPS" - To change how statuses are categorized
    - "updateKPIs" - To modify KPI calculations
    - "updateGraph1" through "updateGraph14" - Individual chart functions
    - "GOOGLE SHEETS" - For Sheets integration settings
    
    ================================================================================
    DATA FLOW EXPLANATION:
    ================================================================================
    1. User uploads Excel file OR connects Google Sheets
    2. Data is parsed into 'rawData' array (all rows from spreadsheet)
    3. When filters are applied, 'filteredData' is created (subset of rawData)
    4. Each chart/table function reads from filteredData
    5. Charts are rendered using Chart.js library
    
    ================================================================================
    */
    
    /*
    ============================================================================
    SECTION: GLOBAL VARIABLES
    ============================================================================
    These variables store data that is used throughout the dashboard.
    They are "global" meaning any function can access them.
    */
    
    /*
    rawData: Array that holds ALL rows from the Excel/Sheets file
    - Each item in the array is one row (one Jira issue)
    - Each row is an object with column names as properties
    - Example: rawData[0].Assignee = "John Smith"
    */
    let rawData = [];
    
    /*
    filteredData: Array that holds rows AFTER filters are applied
    - This is what charts actually display
    - Updated every time you click "Apply Filters"
    */
    let filteredData = [];
    
    /*
    charts: Object that stores all Chart.js chart instances
    - Used to destroy old charts before creating new ones
    - Prevents memory leaks and duplicate charts
    */
    let charts = {};
    
    /*
    ============================================================================
    SECTION: TEAM DEFINITIONS
    ============================================================================
    IMPORTANT: Edit these arrays to change team members!
    
    HOW MATCHING WORKS:
    - Names are matched using "includes" (partial match)
    - Names are converted to lowercase for comparison
    - Example: If you add "john", it will match "John Smith", "Johnny", etc.
    
    TO ADD A MEMBER:
    1. Add their name (lowercase) inside the brackets
    2. Use a portion of their name that's unique to them
    
    TO REMOVE A MEMBER:
    1. Delete their name from the array
    2. Make sure to keep the commas correct
    */
    
    // Jaffer's Development Team
    // Team Lead: Jaffer
    // These names are matched against the "Assignee" column
    const JAFFER_TEAM = [
        'bilal',        // Matches any assignee containing "bilal"
        'ali raza',     // Matches "Ali Raza" (use full name if needed)
        'talha',        // Matches any assignee containing "talha"
        'qasim',        // Matches any assignee containing "qasim"
        'usman',        // Matches any assignee containing "usman"
        'jaffer'        // Matches any assignee containing "jaffer"
    ];
    
    // Ehsan's Development Team
    // Team Lead: Ehsan
    const EHSAN_TEAM = [
        'usama ashraf', // Use full name to distinguish from other Usamas
        'faateh',       // Matches any assignee containing "faateh"
        'zain chattha', // Full name to distinguish from other Zains
        'zain ahmad',   // Another Zain - use full name
        'ehsan'         // Matches any assignee containing "ehsan"
    ];
    
    // QA Team
    // Team Lead: Adnan
    // These names are matched against the "QA" column
    const QA_TEAM = [
        'adnan',        // Matches any QA containing "adnan"
        'huzaifa',      // Matches any QA containing "huzaifa"
        'touseef',      // Matches any QA containing "touseef"
        'haris',        // Matches any QA containing "haris"
        'junaid',       // Matches any QA containing "junaid"
        'mahnoor'       // Matches any QA containing "mahnoor"
    ];
    
    /*
    ============================================================================
    SECTION: STATUS GROUP DEFINITIONS
    ============================================================================
    These define how different Jira statuses are categorized for charts.
    
    HOW IT WORKS:
    - Each group is an array of status keywords (lowercase)
    - A status matches if it CONTAINS any of these keywords
    - Example: "Deployed for Testing" contains "testing" ‚Üí matches testing group
    
    TO ADD A NEW STATUS:
    1. Find the appropriate group
    2. Add the status keyword (lowercase) to the array
    
    TO CREATE A NEW GROUP:
    1. Add a new property to STATUS_GROUPS
    2. Update the chart functions that use these groups
    */
    const STATUS_GROUPS = {
        // "In Progress" - Developer is actively working
        // Column checked: Status
        inProgress: ['in progress'],
        
        // "Code Review" - Code written, waiting for review
        codeReview: ['code review', 'reviewed'],
        
        // "Testing" - QA is testing the work
        testing: [
            'deployed for testing',
            'testing',
            'test review',
            'staging',
            'stagging'  // Common typo in some Jira setups
        ],
        
        // "Done" - Work is complete
        done: [
            'staging done',
            'stagging done',  // Common typo
            'done',
            'released'
        ]
    };
    
    /*
    ============================================================================
    SECTION: GOOGLE SHEETS CONFIGURATION
    ============================================================================
    Settings for connecting to Google Sheets instead of uploading Excel.
    
    HOW TO USE GOOGLE SHEETS:
    1. In Google Sheets: File ‚Üí Share ‚Üí Publish to web
    2. Select your sheet tab
    3. Choose "Comma-separated values (.csv)"
    4. Click "Publish"
    5. Copy the URL that appears
    6. Paste it below OR use the "Google Sheets" button in the dashboard
    
    LIMITATIONS:
    - Sheet must be publicly accessible (anyone with link can view)
    - Changes in Sheet require clicking "Refresh" in dashboard
    - No automatic sync - it's a one-time fetch
    */
    const GOOGLE_SHEET_CONFIG = {
        // Set to true to enable Google Sheets as default data source
        enabled: true,
        
        // Google Sheets API Configuration
        // This uses the Sheets API with an API key (sheet must be shared as "anyone with link can view")
        apiKey: 'AIzaSyAKAot7OY5jtWoEll-w07tEYxFXT1dQfzM',
        spreadsheetId: '1xmHPfZcs3iCRU4ae0XX4ffyK2FMbyCzmEWO0lAhP4GI',
        sheetName: 'duration',
        
        // Constructed API URL (automatically built from above values)
        get url() {
            return `https://sheets.googleapis.com/v4/spreadsheets/${this.spreadsheetId}/values/${this.sheetName}?key=${this.apiKey}`;
        },
        
        // How often to auto-refresh (in milliseconds)
        // 0 = disabled, 300000 = 5 minutes, 600000 = 10 minutes
        autoRefreshInterval: 0
    };
    
    /*
    ============================================================================
    SECTION: INITIALIZATION
    ============================================================================
    Code that runs when the page first loads.
    */
    
    // Register the datalabels plugin for Chart.js
    // This allows showing values directly on charts
    Chart.register(ChartDataLabels);
    
    // Hide the loading overlay initially
    document.getElementById('loadingOverlay').classList.add('hidden');
    
    // Set up file input listener
    // When user selects a file, this triggers the upload process
    document.getElementById('fileInput').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            document.getElementById('loadingOverlay').classList.remove('hidden');
            loadExcelFile(file);
        }
    });
    
    // Check if Google Sheets is configured to load automatically
    if (GOOGLE_SHEET_CONFIG.enabled && GOOGLE_SHEET_CONFIG.url) {
        loadFromConfiguredSheets();
    }
    
    /*
    ============================================================================
    SECTION: DATA LOADING FUNCTIONS
    ============================================================================
    Functions that load data from various sources.
    */
    
    /*
    loadExcelFile(file)
    -------------------
    PURPOSE: Reads an Excel file and loads data into the dashboard
    
    PARAMETERS:
    - file: The file object from the file input
    
    HOW IT WORKS:
    1. FileReader reads the file as binary
    2. SheetJS (XLSX library) parses the Excel format
    3. Data is converted to JSON array
    4. Dates and numbers are properly converted
    5. Filters are populated and dashboard updates
    
    COLUMNS PROCESSED:
    - Created, Resolved, Updated ‚Üí Converted to Date objects
    - Time Spent, Original estimate ‚Üí Converted to numbers (stored in seconds)
    - QA Reopen, Dev Reopen, Story Points ‚Üí Converted to numbers
    */
    function loadExcelFile(file) {
        const reader = new FileReader();
        
        reader.onload = function(e) {
            try {
                // Parse Excel file using SheetJS library
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array', cellDates: true });
                
                // Get first sheet (usually contains all data)
                const sheetName = workbook.SheetNames[0];
                const sheet = workbook.Sheets[sheetName];
                
                // Convert sheet to JSON array
                rawData = XLSX.utils.sheet_to_json(sheet, { raw: false, dateNF: 'yyyy-mm-dd' });
                
                // Process each row to ensure correct data types
                rawData = rawData.map(row => processRow(row));
                
                // Update UI
                onDataLoaded(file.name);
                
            } catch (error) {
                console.error('Error loading Excel file:', error);
                alert('Error loading file. Please check the format and try again.\n\nError: ' + error.message);
                document.getElementById('loadingOverlay').classList.add('hidden');
            }
        };
        
        reader.readAsArrayBuffer(file);
    }
    
    /*
    processRow(row)
    ---------------
    PURPOSE: Converts raw spreadsheet values to proper JavaScript types
    
    WHY THIS IS NEEDED:
    - Excel stores dates as numbers, we need Date objects
    - Time values in Jira are in SECONDS, we keep them that way for calculations
    - Some fields might be empty, we need to handle that
    
    COLUMN MAPPINGS:
    - row.Created ‚Üí JavaScript Date object
    - row.Resolved ‚Üí JavaScript Date object (or null if not resolved)
    - row.Updated ‚Üí JavaScript Date object
    - row['Time Spent'] ‚Üí Number (seconds) - divide by 3600 for hours
    - row['Original estimate'] ‚Üí Number (seconds) - divide by 3600 for hours
    - row['QA Reopen'] ‚Üí Number (count of reopens)
    - row['Dev Reopen'] ‚Üí Number (count of reopens)
    - row['Story Points'] ‚Üí Number (story point value)
    */
    function processRow(row) {
        return {
            ...row,  // Keep all original columns
            
            // Convert date strings to Date objects
            // new Date() parses date strings like "2024-01-15"
            Created: row.Created ? new Date(row.Created) : null,
            Resolved: row.Resolved ? new Date(row.Resolved) : null,
            Updated: row.Updated ? new Date(row.Updated) : null,
            
            // Convert time values to numbers (stored in seconds in Jira)
            // parseFloat converts string "3600" to number 3600
            // || 0 means "if parsing fails, use 0"
            'Time Spent': parseFloat(row['Time Spent']) || 0,
            'Original estimate': parseFloat(row['Original estimate']) || 0,
            
            // Convert count fields to numbers
            'QA Reopen': parseFloat(row['QA Reopen']) || 0,
            'Dev Reopen': parseFloat(row['Dev Reopen']) || 0,
            'Story Points': parseFloat(row['Story Points']) || 0
        };
    }
    
    /*
    loadFromSheets()
    ----------------
    PURPOSE: Loads data from Google Sheets using URL entered in modal
    
    HOW IT WORKS:
    1. Gets URL from input field
    2. Fetches CSV data from Google Sheets
    3. PapaParse library converts CSV to JSON
    4. Data is processed same as Excel
    */
    function loadFromSheets() {
        const url = document.getElementById('sheetsUrl').value.trim();
        
        if (!url) {
            alert('Please enter a Google Sheets URL');
            return;
        }
        
        // Close modal and show loading
        closeSheetsModal();
        document.getElementById('loadingOverlay').classList.remove('hidden');
        
        // Fetch data from Google Sheets
        fetch(url)
            .then(response => {
                if (!response.ok) throw new Error('Failed to fetch from Google Sheets');
                return response.text();
            })
            .then(csvData => {
                // Parse CSV using PapaParse
                const parsed = Papa.parse(csvData, {
                    header: true,      // First row is headers
                    skipEmptyLines: true
                });
                
                if (parsed.errors.length > 0) {
                    console.warn('CSV parsing warnings:', parsed.errors);
                }
                
                // Process each row
                rawData = parsed.data.map(row => processRow(row));
                
                // Update UI
                onDataLoaded('Google Sheets');
                
            })
            .catch(error => {
                console.error('Error loading from Google Sheets:', error);
                alert('Error loading from Google Sheets.\n\nMake sure:\n1. The sheet is published to web\n2. The URL is correct\n3. Format is set to CSV\n\nError: ' + error.message);
                document.getElementById('loadingOverlay').classList.add('hidden');
            });
    }
    
    /*
    onDataLoaded(sourceName)
    ------------------------
    PURPOSE: Called after data is successfully loaded from any source
    
    ACTIONS:
    1. Updates the data status badge
    2. Populates filter dropdowns
    3. Hides welcome screen, shows dashboard
    4. Applies filters and updates all charts
    */
    function onDataLoaded(sourceName) {
        // Update status badge with row count and timestamp
        const badge = document.getElementById('dataBadge');
        badge.classList.add('connected');
        const now = new Date().toLocaleTimeString();
        document.getElementById('dataStatus').textContent = `${rawData.length} rows ‚Ä¢ Updated ${now}`;
        badge.title = `Data from: ${sourceName}\nLast updated: ${now}`;
        
        // Populate all filter dropdowns
        populateFilters();
        
        // Hide welcome, show dashboard
        document.getElementById('welcomeState').classList.add('hidden');
        document.getElementById('dashboardContent').style.display = 'block';
        
        // Apply filters (this also updates all charts)
        applyFilters();
        
        // Hide loading overlay
        document.getElementById('loadingOverlay').classList.add('hidden');
        
        // Save source name for refresh
        window.lastDataSource = sourceName;
    }
    
    /*
    loadSampleData()
    ----------------
    PURPOSE: Loads demo data so users can see how the dashboard looks
    
    This creates fake Jira data to demonstrate the dashboard.
    Useful when you don't have a real export file handy.
    */
    function loadSampleData() {
        document.getElementById('loadingOverlay').classList.remove('hidden');
        
        // Generate sample data
        const sampleIssueTypes = ['Story', 'Bug', 'Improvement', 'Reassigned Bug', 'Task', 'QA Task'];
        const sampleStatuses = ['Done', 'In Progress', 'Testing', 'Code Review', 'To Do', 'Released'];
        const sampleAssignees = ['Bilal Ahmed', 'Ali Raza', 'Talha Khan', 'Shehroz Ali', 'Usama Ashraf', 'Faateh Khan'];
        const sampleQA = ['Adnan', 'Huzaifa', 'Touseef', 'Haris', 'Mahnoor'];
        const sampleComponents = ['Intellicon', 'LiveChat', 'CRM', 'Reporting', 'API'];
        const sampleSprints = ['Sprint 45', 'Sprint 46', 'Sprint 47', 'Sprint 48'];
        
        rawData = [];
        for (let i = 1; i <= 500; i++) {
            const issueType = sampleIssueTypes[Math.floor(Math.random() * sampleIssueTypes.length)];
            const daysAgo = Math.floor(Math.random() * 90);
            const created = new Date();
            created.setDate(created.getDate() - daysAgo);
            
            rawData.push({
                Key: `DEMO-${i}`,
                'Issue Type': issueType,
                Summary: `Sample ${issueType} #${i}`,
                Assignee: sampleAssignees[Math.floor(Math.random() * sampleAssignees.length)],
                QA: sampleQA[Math.floor(Math.random() * sampleQA.length)],
                Status: sampleStatuses[Math.floor(Math.random() * sampleStatuses.length)],
                Components: sampleComponents[Math.floor(Math.random() * sampleComponents.length)],
                Sprint: sampleSprints[Math.floor(Math.random() * sampleSprints.length)],
                Labels: Math.random() > 0.8 ? 'NewRequirement' : '',
                'Story Points': Math.floor(Math.random() * 8) + 1,
                'Time Spent': Math.floor(Math.random() * 28800), // 0-8 hours in seconds
                'Original estimate': Math.floor(Math.random() * 28800),
                'QA Reopen': Math.floor(Math.random() * 3),
                'Bug Source': Math.random() > 0.7 ? 'Production Bug' : 'Internal',
                'Required By': ['CTO', 'Support', 'Internal', 'Client'][Math.floor(Math.random() * 4)],
                Created: created,
                Updated: created,
                Resolved: Math.random() > 0.3 ? created : null
            });
        }
        
        onDataLoaded('Sample Data');
    }
    
    /*
    ============================================================================
    SECTION: FILTER FUNCTIONS
    ============================================================================
    Functions that populate and apply filters.
    */
    
    /*
    populateFilters()
    -----------------
    PURPOSE: Fills all filter dropdowns with unique values from the data
    
    HOW IT WORKS:
    1. Extract unique values from each relevant column
    2. Sort them alphabetically
    3. Add as options to the corresponding select element
    
    COLUMNS USED FOR EACH FILTER:
    - Sprint filter ‚Üí Sprint column
    - Release filter ‚Üí Fix versions column
    - Products filter ‚Üí Components column (split by semicolon)
    - Issue Type filter ‚Üí Issue Type column
    - Members filter ‚Üí Assignee column (combined members filter)
    - Status filter ‚Üí Status column
    */
    function populateFilters() {
        console.log('populateFilters called, rawData length:', rawData.length);
        
        // Get unique values for each filter
        const sprints = [...new Set(rawData.map(r => r.Sprint || r.sprint || r.SPRINT).filter(Boolean))].sort();
        const releases = [...new Set(rawData.map(r => r['Fix versions'] || r['Fix Versions'] || r['FixVersions'] || r.Release || r.release).filter(Boolean))].sort();
        const components = [...new Set(
            rawData.flatMap(r => {
                const comp = r.Components || r.components || r.Component || r.component || '';
                return comp.split(/[;,]/).map(c => c.trim());
            }).filter(Boolean)
        )].sort();
        const issueTypes = [...new Set(rawData.map(r => r['Issue Type'] || r['IssueType'] || r['Issue type'] || r.Type).filter(Boolean))].sort();
        const assignees = [...new Set(rawData.map(r => r.Assignee || r.assignee || r.ASSIGNEE).filter(Boolean))].sort();
        const statuses = [...new Set(rawData.map(r => r.Status || r.status || r.STATUS).filter(Boolean))].sort();
        
        // Team options (predefined)
        const teamOptions = [
            { value: 'jaffer', label: 'Jaffer Team' },
            { value: 'ehsan', label: 'Ehsan Team' },
            { value: 'qa', label: 'QA Team' }
        ];
        
        // Create dropdowns
        createDropdown('dropdownSprint', 'filterSprint', sprints, 'All Sprints');
        createDropdown('dropdownRelease', 'filterRelease', releases, 'All Releases');
        createDropdown('dropdownComponent', 'filterComponent', components, 'All Products');
        createDropdown('dropdownIssueType', 'filterIssueType', issueTypes, 'All Types');
        createDropdown('dropdownTeam', 'filterTeam', teamOptions, 'All Teams', true);
        createDropdown('dropdownAssignee', 'filterAssignee', assignees, 'All Members');
        createDropdown('dropdownStatus', 'filterStatus', statuses, 'All Statuses');
        
        // Set default date range
        const dates = rawData.map(r => r.Created || r.created || r.CREATED).filter(Boolean);
        if (dates.length) {
            const minDate = new Date(Math.min(...dates));
            const maxDate = new Date(Math.max(...dates));
            document.getElementById('filterDateFrom').value = formatDate(minDate);
            document.getElementById('filterDateTo').value = formatDate(maxDate);
        }
        
        console.log('Filters populated:', {
            sprints: sprints.length,
            releases: releases.length,
            components: components.length,
            issueTypes: issueTypes.length,
            assignees: assignees.length,
            statuses: statuses.length
        });
    }
    
    /*
    ============================================================================
    DROPDOWN MULTI-SELECT SYSTEM
    ============================================================================
    */
    const dropdownState = {};
    
    function createDropdown(containerId, filterId, options, placeholder, isLabelValue = false) {
        const container = document.getElementById(containerId);
        if (!container) {
            console.error('Container not found:', containerId);
            return;
        }
        
        // Initialize state
        dropdownState[filterId] = {
            selected: new Set(),
            options: options,
            placeholder: placeholder,
            isLabelValue: isLabelValue
        };
        
        // Build HTML
        let optionsHtml = '';
        if (options.length === 0) {
            optionsHtml = '<div class="dropdown-empty">No options available</div>';
        } else {
            options.forEach((opt, i) => {
                const value = isLabelValue ? opt.value : String(opt);
                const label = isLabelValue ? opt.label : String(opt);
                optionsHtml += `
                    <div class="dropdown-item" data-value="${escapeHtml(value)}">
                        <input type="checkbox" id="${filterId}_opt_${i}" data-value="${escapeHtml(value)}">
                        <span>${escapeHtml(label)}</span>
                    </div>`;
            });
        }
        
        container.innerHTML = `
            <div class="dropdown-btn" onclick="toggleDropdown('${filterId}')">
                <span class="text">${placeholder}</span>
                <span class="arrow">‚ñº</span>
            </div>
            <div class="dropdown-panel" id="${filterId}_panel">
                <div class="dropdown-search">
                    <input type="text" placeholder="üîç Search..." oninput="searchDropdown('${filterId}', this.value)">
                </div>
                <div class="dropdown-actions">
                    <button type="button" onclick="event.stopPropagation(); selectAllDropdown('${filterId}')">Select All</button>
                    <button type="button" onclick="event.stopPropagation(); clearAllDropdown('${filterId}')">Clear All</button>
                </div>
                <div class="dropdown-list" id="${filterId}_list">
                    ${optionsHtml}
                </div>
            </div>
        `;
        
        // Add checkbox event listeners
        container.querySelectorAll('.dropdown-item input[type="checkbox"]').forEach(cb => {
            cb.addEventListener('change', function(e) {
                e.stopPropagation();
                const value = this.dataset.value;
                if (this.checked) {
                    dropdownState[filterId].selected.add(value);
                } else {
                    dropdownState[filterId].selected.delete(value);
                }
                updateDropdownDisplay(filterId);
            });
        });
        
        // Make entire item clickable
        container.querySelectorAll('.dropdown-item').forEach(item => {
            item.addEventListener('click', function(e) {
                if (e.target.tagName !== 'INPUT') {
                    const cb = this.querySelector('input[type="checkbox"]');
                    cb.checked = !cb.checked;
                    cb.dispatchEvent(new Event('change'));
                }
            });
        });
        
        console.log(`Dropdown ${filterId} created with ${options.length} options`);
    }
    
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    function toggleDropdown(filterId) {
        const panel = document.getElementById(filterId + '_panel');
        if (!panel) return;
        
        const btn = panel.previousElementSibling;
        const isOpen = panel.classList.contains('open');
        
        // Close all other dropdowns
        document.querySelectorAll('.dropdown-panel.open').forEach(p => {
            p.classList.remove('open');
            p.previousElementSibling.classList.remove('active');
        });
        
        if (!isOpen) {
            panel.classList.add('open');
            btn.classList.add('active');
            const searchInput = panel.querySelector('input[type="text"]');
            if (searchInput) {
                searchInput.value = '';
                searchDropdown(filterId, '');
                searchInput.focus();
            }
        }
    }
    
    function searchDropdown(filterId, searchText) {
        const list = document.getElementById(filterId + '_list');
        if (!list) return;
        
        const search = searchText.toLowerCase().trim();
        
        list.querySelectorAll('.dropdown-item').forEach(item => {
            const text = item.querySelector('span').textContent.toLowerCase();
            if (search === '' || text.includes(search)) {
                item.classList.remove('hidden');
            } else {
                item.classList.add('hidden');
            }
        });
    }
    
    function selectAllDropdown(filterId) {
        const state = dropdownState[filterId];
        if (!state) return;
        
        const list = document.getElementById(filterId + '_list');
        if (!list) return;
        
        list.querySelectorAll('.dropdown-item:not(.hidden)').forEach(item => {
            const cb = item.querySelector('input[type="checkbox"]');
            const value = cb.dataset.value;
            cb.checked = true;
            state.selected.add(value);
        });
        
        updateDropdownDisplay(filterId);
    }
    
    function clearAllDropdown(filterId) {
        const state = dropdownState[filterId];
        if (!state) return;
        
        state.selected.clear();
        
        const list = document.getElementById(filterId + '_list');
        if (list) {
            list.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                cb.checked = false;
            });
        }
        
        updateDropdownDisplay(filterId);
    }
    
    function updateDropdownDisplay(filterId) {
        const state = dropdownState[filterId];
        if (!state) return;
        
        const container = document.getElementById('dropdown' + filterId.replace('filter', ''));
        if (!container) return;
        
        const textSpan = container.querySelector('.dropdown-btn .text');
        if (!textSpan) return;
        
        const count = state.selected.size;
        
        if (count === 0) {
            textSpan.textContent = state.placeholder;
        } else if (count === 1) {
            const value = [...state.selected][0];
            // Find the label
            if (state.isLabelValue) {
                const opt = state.options.find(o => o.value === value);
                textSpan.textContent = opt ? opt.label : value;
            } else {
                textSpan.textContent = value;
            }
        } else {
            textSpan.textContent = `${count} selected`;
        }
    }
    
    function getSelectedValues(filterId) {
        const state = dropdownState[filterId];
        return state ? [...state.selected] : [];
    }
    
    // Close dropdowns when clicking outside
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.dropdown-container')) {
            document.querySelectorAll('.dropdown-panel.open').forEach(panel => {
                panel.classList.remove('open');
                panel.previousElementSibling.classList.remove('active');
            });
        }
    });
    
    /*
    matchesTeam(assignee, team)
    ---------------------------
    PURPOSE: Checks if an assignee belongs to a team
    
    HOW IT WORKS:
    - Converts assignee name to lowercase
    - Checks if any team member name is contained in the assignee
    - Uses partial matching (e.g., "bilal" matches "Bilal Ahmed")
    
    PARAMETERS:
    - assignee: The assignee name from the data (e.g., "Bilal Ahmed")
    - team: Array of team member names (e.g., JAFFER_TEAM)
    
    RETURNS: true if assignee is on the team, false otherwise
    */
    function matchesTeam(assignee, team) {
        if (!assignee) return false;
        const nameLower = assignee.toLowerCase();
        return team.some(member => nameLower.includes(member));
    }
    
    /*
    matchesFilter(value, filterValues)
    ----------------------------------
    PURPOSE: Checks if a value matches any of the filter selections
    
    HOW IT WORKS:
    - If no filters selected (empty array), everything matches
    - Otherwise, checks if value contains any filter value (case-insensitive)
    
    PARAMETERS:
    - value: The value from the data (e.g., "Sprint 45")
    - filterValues: Array of selected filter values
    
    RETURNS: true if matches or no filter applied, false otherwise
    */
    function matchesFilter(value, filterValues) {
        if (!filterValues.length) return true;  // No filter = show all
        if (!value) return false;  // No value = no match
        
        const valueLower = value.toLowerCase();
        return filterValues.some(f => valueLower.includes(f.toLowerCase()));
    }
    
    /*
    matchesSingleFilter(value, filterValue)
    ---------------------------------------
    PURPOSE: Checks if a value matches a single filter selection (for dropdown filters)
    
    HOW IT WORKS:
    - If no filter selected (empty string), everything matches
    - Otherwise, checks if value contains the filter value (case-insensitive)
    
    PARAMETERS:
    - value: The value from the data (e.g., "Sprint 45")
    - filterValue: The selected filter value (single string)
    
    RETURNS: true if matches or no filter applied, false otherwise
    */
    function matchesSingleFilter(value, filterValue) {
        if (!filterValue) return true;  // No filter = show all
        if (!value) return false;  // No value = no match
        
        const valueLower = value.toLowerCase();
        return valueLower.includes(filterValue.toLowerCase());
    }
    
    /*
    filterDataByChartDate(data, dateType)
    -------------------------------------
    PURPOSE: Filters data for individual chart date controls
    
    Each chart has its own date type selector. This function
    applies that chart-specific date filter.
    
    PARAMETERS:
    - data: Array of rows to filter
    - dateType: 'created', 'updated', 'resolved', or 'none'
    
    RETURNS: Filtered array of rows
    */
    function filterDataByChartDate(data, dateType) {
        if (dateType === 'none') return data;
        
        const dateFrom = document.getElementById('filterDateFrom').value ? 
            new Date(document.getElementById('filterDateFrom').value) : null;
        const dateTo = document.getElementById('filterDateTo').value ? 
            new Date(document.getElementById('filterDateTo').value + 'T23:59:59') : null;
        
        return data.filter(row => {
            let dateField;
            switch (dateType) {
                case 'created': dateField = row.Created; break;
                case 'updated': dateField = row.Updated; break;
                case 'resolved': dateField = row.Resolved; break;
                default: return true;
            }
            
            if (!dateField) return false;
            if (dateFrom && dateField < dateFrom) return false;
            if (dateTo && dateField > dateTo) return false;
            return true;
        });
    }
    
    /*
    applyFilters()
    --------------
    PURPOSE: Main function that applies all filters and updates dashboard
    
    HOW IT WORKS:
    1. Reads all filter selections
    2. Filters rawData based on selections
    3. Stores result in filteredData
    4. Updates active filter count
    5. Calls updateDashboard() to refresh all charts
    
    FILTER LOGIC:
    - All filters use AND logic (row must match ALL applied filters)
    - Within multi-select, uses OR logic (match ANY selected value)
    */
    function applyFilters() {
        // Read all filter values (multi-select dropdowns)
        const sprintFilter = getSelectedValues('filterSprint');
        const releaseFilter = getSelectedValues('filterRelease');
        const componentFilter = getSelectedValues('filterComponent');
        const issueTypeFilter = getSelectedValues('filterIssueType');
        const teamFilter = getSelectedValues('filterTeam');
        const assigneeFilter = getSelectedValues('filterAssignee');
        const statusFilter = getSelectedValues('filterStatus');
        const dateType = document.getElementById('filterDateType').value;
        const dateFrom = document.getElementById('filterDateFrom').value ? 
            new Date(document.getElementById('filterDateFrom').value) : null;
        const dateTo = document.getElementById('filterDateTo').value ? 
            new Date(document.getElementById('filterDateTo').value + 'T23:59:59') : null;
        
        // Count active filters for badge
        let activeCount = 0;
        if (sprintFilter.length) activeCount++;
        if (releaseFilter.length) activeCount++;
        if (componentFilter.length) activeCount++;
        if (issueTypeFilter.length) activeCount++;
        if (teamFilter.length) activeCount++;
        if (assigneeFilter.length) activeCount++;
        if (statusFilter.length) activeCount++;
        if ((dateFrom || dateTo) && dateType !== 'none') activeCount++;
        
        document.getElementById('activeFilterCount').textContent = `${activeCount} active`;
        
        // Filter the data
        filteredData = rawData.filter(row => {
            // Sprint filter
            if (sprintFilter.length && !matchesFilter(row.Sprint, sprintFilter)) return false;
            
            // Release filter
            if (releaseFilter.length && !matchesFilter(row['Fix versions'], releaseFilter)) return false;
            
            // Component filter
            if (componentFilter.length && !matchesFilter(row.Components, componentFilter)) return false;
            
            // Issue Type filter
            if (issueTypeFilter.length && !matchesFilter(row['Issue Type'], issueTypeFilter)) return false;
            
            // Team filter (multiple teams can be selected)
            if (teamFilter.length) {
                let matchesAnyTeam = false;
                teamFilter.forEach(team => {
                    if (team === 'jaffer' && matchesTeam(row.Assignee, JAFFER_TEAM)) matchesAnyTeam = true;
                    if (team === 'ehsan' && matchesTeam(row.Assignee, EHSAN_TEAM)) matchesAnyTeam = true;
                    if (team === 'qa' && matchesTeam(row.Assignee, QA_TEAM)) matchesAnyTeam = true;
                });
                if (!matchesAnyTeam) return false;
            }
            
            // Assignee filter
            if (assigneeFilter.length && !matchesFilter(row.Assignee, assigneeFilter)) return false;
            
            // Status filter
            if (statusFilter.length && !matchesFilter(row.Status, statusFilter)) return false;
            
            // Date filter (uses selected date type)
            if ((dateFrom || dateTo) && dateType !== 'none') {
                let dateField;
                switch (dateType) {
                    case 'created': dateField = row.Created; break;
                    case 'updated': dateField = row.Updated; break;
                    case 'resolved': dateField = row.Resolved; break;
                    default: dateField = row.Created;
                }
                if (dateField) {
                    if (dateFrom && dateField < dateFrom) return false;
                    if (dateTo && dateField > dateTo) return false;
                } else {
                    return false;  // No date = filtered out when date filter is on
                }
            }
            
            return true;  // Row passes all filters
        });
        
        // Update applied filters display
        updateAppliedFiltersDisplay();
        
        // Update all charts with filtered data
        updateDashboard();
    }
    
    /*
    updateAppliedFiltersDisplay()
    -----------------------------
    PURPOSE: Updates the applied filters display section showing active filter tags
    Also updates the header filter tags next to "Filters & Controls"
    */
    function updateAppliedFiltersDisplay() {
        const container = document.getElementById('appliedFiltersContainer');
        const tagsContainer = document.getElementById('appliedFiltersTags');
        const headerTagsContainer = document.getElementById('headerFilterTags');
        const filterCountBadge = document.getElementById('activeFilterCount');
        
        // Collect all active filters
        const activeFilters = [];
        
        // Check each filter dropdown
        const filterConfigs = [
            { id: 'filterSprint', label: 'Sprint' },
            { id: 'filterRelease', label: 'Release' },
            { id: 'filterComponent', label: 'Product' },
            { id: 'filterIssueType', label: 'Type' },
            { id: 'filterTeam', label: 'Team' },
            { id: 'filterAssignee', label: 'Member' },
            { id: 'filterStatus', label: 'Status' }
        ];
        
        filterConfigs.forEach(config => {
            const selected = getSelectedValues(config.id);
            if (selected.length > 0) {
                // Show up to 3 values, then "and X more"
                let displayValue;
                let shortValue;
                if (selected.length === 1) {
                    displayValue = selected[0];
                    shortValue = selected[0].length > 15 ? selected[0].substring(0, 12) + '...' : selected[0];
                } else if (selected.length <= 3) {
                    displayValue = selected.join(', ');
                    shortValue = `${selected.length} items`;
                } else {
                    displayValue = selected.slice(0, 2).join(', ') + ` +${selected.length - 2} more`;
                    shortValue = `${selected.length} items`;
                }
                activeFilters.push({
                    filterId: config.id,
                    label: config.label,
                    value: displayValue,
                    shortValue: shortValue,
                    count: selected.length
                });
            }
        });
        
        // Check date filter
        const dateType = document.getElementById('filterDateType').value;
        const dateFrom = document.getElementById('filterDateFrom').value;
        const dateTo = document.getElementById('filterDateTo').value;
        
        if ((dateFrom || dateTo) && dateType !== 'none') {
            let dateLabel = dateType.charAt(0).toUpperCase() + dateType.slice(1);
            let dateValue = '';
            let shortDateValue = '';
            if (dateFrom && dateTo) {
                dateValue = `${dateFrom} to ${dateTo}`;
                shortDateValue = `${dateFrom.slice(5)} - ${dateTo.slice(5)}`;
            } else if (dateFrom) {
                dateValue = `From ${dateFrom}`;
                shortDateValue = `From ${dateFrom.slice(5)}`;
            } else if (dateTo) {
                dateValue = `Until ${dateTo}`;
                shortDateValue = `Until ${dateTo.slice(5)}`;
            }
            activeFilters.push({
                filterId: 'filterDate',
                label: `Date`,
                value: dateValue,
                shortValue: shortDateValue,
                count: 1
            });
        }
        
        // Update filter count badge
        const totalCount = activeFilters.length;
        filterCountBadge.textContent = totalCount > 0 ? `${totalCount} active` : '0 active';
        filterCountBadge.classList.toggle('zero', totalCount === 0);
        
        // Update header filter tags (show up to 4 tags, then "+X more")
        if (headerTagsContainer) {
            if (activeFilters.length === 0) {
                headerTagsContainer.innerHTML = '';
            } else {
                const maxHeaderTags = 4;
                const visibleFilters = activeFilters.slice(0, maxHeaderTags);
                const remainingCount = activeFilters.length - maxHeaderTags;
                
                let headerTagsHtml = visibleFilters.map(filter => `
                    <span class="active-filter-tag">
                        <span class="tag-label">${filter.label}:</span>
                        <span class="tag-value">${filter.shortValue}</span>
                        <span class="tag-remove" onclick="event.stopPropagation(); clearFilter('${filter.filterId}')" title="Remove filter">√ó</span>
                    </span>
                `).join('');
                
                if (remainingCount > 0) {
                    headerTagsHtml += `<span class="active-filter-more">+${remainingCount} more</span>`;
                }
                
                headerTagsContainer.innerHTML = headerTagsHtml;
            }
        }
        
        // Since we removed the main container, just return after updating header tags
        return;
    }
    
    /*
    clearFilter(filterId)
    ---------------------
    PURPOSE: Clears a specific filter and reapplies remaining filters
    */
    function clearFilter(filterId) {
        if (filterId === 'filterDate') {
            // Clear date filters
            document.getElementById('filterDateType').value = 'created';
            document.getElementById('filterDateFrom').value = '';
            document.getElementById('filterDateTo').value = '';
        } else {
            // Clear dropdown filter
            if (dropdownState[filterId]) {
                dropdownState[filterId].selected.clear();
            }
            
            const list = document.getElementById(filterId + '_list');
            if (list) {
                list.querySelectorAll('.dropdown-item input[type="checkbox"]').forEach(cb => {
                    cb.checked = false;
                });
            }
            
            updateDropdownDisplay(filterId);
        }
        
        applyFilters();
    }
    
    /*
    resetFilters()
    --------------
    PURPOSE: Resets all filters to default (show all data)
    */
    function resetFilters() {
        const filterIds = ['filterSprint', 'filterRelease', 'filterComponent', 'filterIssueType', 'filterTeam', 'filterAssignee', 'filterStatus'];
        
        filterIds.forEach(filterId => {
            // Clear dropdown state
            if (dropdownState[filterId]) {
                dropdownState[filterId].selected.clear();
            }
            
            // Uncheck all checkboxes and show all items
            const list = document.getElementById(filterId + '_list');
            if (list) {
                list.querySelectorAll('.dropdown-item').forEach(item => {
                    item.classList.remove('hidden');
                    const cb = item.querySelector('input[type="checkbox"]');
                    if (cb) cb.checked = false;
                });
            }
            
            // Reset display text
            updateDropdownDisplay(filterId);
        });
        
        // Clear all search inputs
        document.querySelectorAll('.dropdown-search input').forEach(input => {
            input.value = '';
        });
        
        // Reset date type to Created
        document.getElementById('filterDateType').value = 'created';
        
        // Reset dates to full range
        if (rawData.length) {
            const dates = rawData.map(r => r.Created).filter(Boolean);
            if (dates.length) {
                document.getElementById('filterDateFrom').value = formatDate(new Date(Math.min(...dates)));
                document.getElementById('filterDateTo').value = formatDate(new Date(Math.max(...dates)));
            }
        }
        
        // Apply the reset
        applyFilters();
    }
    
    /*
    ============================================================================
    SECTION: DASHBOARD UPDATE FUNCTIONS
    ============================================================================
    Functions that update all dashboard components.
    */
    
    /*
    updateDashboard()
    -----------------
    PURPOSE: Master function that updates all dashboard components
    
    Called whenever:
    - Data is first loaded
    - Filters are applied
    - Chart date selector changes
    */
    function updateDashboard() {
        updateKPIs();
        updateGraph2(); updateGraph3(); updateGraph4();
        updateGraph5(); updateGraph6(); updateQADetailTable();
        updateGraph7(); updateGraph8(); updateDevEstimationTable();
        updateGraph9(); updateDevWorkTable(); updateGraph10();
        updateGraph11(); updateGraph12(); updateGraph13(); updateGraph14();
        updateDevRaceTrack(); updateQARaceTrack();
    }
    
    /*
    ============================================================================
    SECTION: KPI CALCULATIONS
    ============================================================================
    
    updateKPIs()
    ------------
    PURPOSE: Calculates and displays all KPI card values
    
    CALCULATIONS:
    
    1. TOTAL TASKS
       - Count all rows where Issue Type is NOT "Sub-task" AND NOT "QA Task"
       - Column: Issue Type
       - WHY: We exclude subtasks and QA tasks because they're child items
    
    2. COMPLETED
       - Count rows where Status contains "Done" OR "Released" OR "Staging Done"
       - Column: Status
       - WHY: These statuses indicate finished work
    
    3. TOTAL BUGS
       - Count rows where Issue Type = "Bug" OR "Reassigned Bug"
       - Column: Issue Type
       - WHY: Both are bugs, "Reassigned Bug" means it was sent to another dev
    
    4. IMPROVEMENTS
       - Count rows where Issue Type = "Improvement"
       - Column: Issue Type
    
    5. STORIES
       - Count rows where Issue Type = "Story"
       - Column: Issue Type
    
    6. TIME SPENT
       - Sum all Time Spent values, then divide by 3600 to convert to hours
       - Column: Time Spent (stored in SECONDS in Jira)
       - Formula: SUM(Time Spent) / 3600
    
    7. QA REOPENS
       - Count rows where QA Reopen > 0
       - Column: QA Reopen
       - WHY: This counts issues that QA sent back to developers
    
    8. NEW FEATURES
       - Count rows where Labels contains "NewRequirement"
       - Column: Labels
       - WHY: This label marks new feature requests
    
    9. STORY POINTS
       - Sum Story Points from COMPLETED items only
       - Columns: Story Points, Status
       - Formula: SUM(Story Points) WHERE Status is done
    
    10. BUG RATIO (%)
        - Internal Bugs divided by Story Points Done, multiplied by 100
        - Formula: (Internal Bugs / Story Points Done) * 100
        - Story Points from: Status = Done, Released, Staging Done
        - INTERPRETATION: Lower percentage is better
    
    11. BUG/TASK RATIO
        - Percentage of bugs relative to completed tasks
        - Formula: (Total Bugs / Completed Tasks) * 100
        - INTERPRETATION: Lower percentage is better
    */
    function updateKPIs() {
        // DEDUPLICATION: Remove duplicate rows based on unique Key
        // This ensures each issue is only counted once even if it appears in multiple sprints/exports
        const data = getUniqueByKey(filteredData);
        
        console.log(`KPIs: ${filteredData.length} total rows ‚Üí ${data.length} unique keys`);
        
        // 1. TOTAL WORK ITEMS: Exclude Sub-task and QA Task
        const mainTasks = data.filter(row => 
            !['Sub-task', 'QA Task'].includes(row['Issue Type'])
        );
        document.getElementById('kpiTotalTasks').textContent = mainTasks.length.toLocaleString();
        
        // 2. TASK STATE: To Do, In Progress, Done
        // Done statuses: Staging Done, Stagging Done, Done, Released
        const DONE_STATUSES = ['staging done', 'stagging done', 'done', 'released'];
        
        // To Do: ONLY items with status "To Do" (exact match, case-insensitive)
        const toDo = mainTasks.filter(row => {
            const status = (row.Status || '').toLowerCase().trim();
            return status === 'to do';
        });
        document.getElementById('kpiToDo').textContent = toDo.length.toLocaleString();
        
        // Done: Status contains Staging Done, Done, or Released
        const done = mainTasks.filter(row => {
            const status = (row.Status || '').toLowerCase();
            return DONE_STATUSES.some(s => status.includes(s));
        });
        document.getElementById('kpiDone').textContent = done.length.toLocaleString();
        
        // In Progress: ALL states EXCEPT To Do and Done statuses
        const inProgress = mainTasks.filter(row => {
            const status = (row.Status || '').toLowerCase().trim();
            // Not "To Do"
            if (status === 'to do') return false;
            // Not any of the Done statuses
            if (DONE_STATUSES.some(s => status.includes(s))) return false;
            // Everything else is In Progress
            return true;
        });
        document.getElementById('kpiInProgress').textContent = inProgress.length.toLocaleString();
        
        // 3. BUGS BREAKDOWN
        // All bugs (Bug or Reassigned Bug)
        const allBugs = data.filter(row => 
            ['Bug', 'Reassigned Bug'].includes(row['Issue Type'])
        );
        
        // Production Bugs: Bug Source contains "production"
        const productionBugs = allBugs.filter(row => 
            (row['Bug Source'] || '').toLowerCase().includes('production')
        );
        
        // Internal Bugs: Bug Source contains "internal" OR is empty/unspecified (merged)
        const internalBugs = allBugs.filter(row => {
            const source = (row['Bug Source'] || '').toLowerCase().trim();
            return source.includes('internal') || source === '' || source === 'unspecified';
        });
        
        document.getElementById('kpiInternalBugs').textContent = internalBugs.length.toLocaleString();
        
        // Stability Items: Any issue tagged with "stability" label
        const stabilityItems = data.filter(row => 
            (row.Labels || '').toLowerCase().includes('stability')
        );
        document.getElementById('kpiStabilityItems').textContent = stabilityItems.length.toLocaleString();
        
        // Technical Debts: Any issue tagged with "technicaldebt" or "technical-debt" label
        const techDebtItems = data.filter(row => {
            const labels = (row.Labels || '').toLowerCase();
            return labels.includes('technicaldebt') || labels.includes('technical-debt') || labels.includes('tech-debt') || labels.includes('techdebt');
        });
        document.getElementById('kpiTechDebt').textContent = techDebtItems.length.toLocaleString();
        
        // 4. BUG RATIO: (Internal Bugs / Story Points Done) * 100 = %
        // Story Points from completed items (Done, Released, Staging Done)
        const completed = data.filter(row => 
            ['Done', 'Released', 'Staging Done', 'Stagging Done'].some(status => 
                (row.Status || '').toLowerCase().includes(status.toLowerCase())
            )
        );
        const storyPointsDone = completed.reduce((sum, row) => sum + (row['Story Points'] || 0), 0);
        
        // Bug Ratio = (Internal Bugs / Story Points Done) * 100
        const bugRatio = storyPointsDone > 0 ? ((internalBugs.length / storyPointsDone) * 100) : 0;
        document.getElementById('kpiBugRatio').textContent = bugRatio.toFixed(1) + '%';
        
        // 5. PRODUCTION BUGS
        document.getElementById('kpiProductionBugs').textContent = productionBugs.length.toLocaleString();
        
        // 6. STORY POINTS CARD
        // Total Story Points (all tasks)
        const totalSP = mainTasks.reduce((sum, row) => sum + (row['Story Points'] || 0), 0);
        document.getElementById('kpiSPDone').textContent = storyPointsDone.toLocaleString();
        document.getElementById('kpiTotalSP').textContent = totalSP.toLocaleString();
        
        // 7. FEATURES CARD
        // New Features: Stories with "NewRequirement" label
        const newFeatures = mainTasks.filter(row => 
            (row.Labels || '').toLowerCase().includes('newrequirement')
        );
        document.getElementById('kpiNewFeatures').textContent = newFeatures.length.toLocaleString();
        
        // Enhancements: Issue Type = "Improvement"
        const enhancements = mainTasks.filter(row => 
            row['Issue Type'] === 'Improvement'
        );
        document.getElementById('kpiEnhancements').textContent = enhancements.length.toLocaleString();
    }
    
    /*
    ============================================================================
    SECTION: CHART FUNCTIONS
    ============================================================================
    Each function creates/updates one chart or table.
    
    CHART NAMING CONVENTION:
    - updateGraph1() through updateGraph14() - Main charts
    - updateQADetailTable(), updateDevEstimationTable() - Tables
    
    COMMON PATTERN:
    1. Get date type from chart's own selector
    2. Filter data based on date
    3. Group/aggregate data as needed
    4. Destroy old chart if exists
    5. Create new chart with Chart.js
    */
    
    /*
    updateGraph1() - ESTIMATES VS TIME SPENT (DEV TEAM ONLY)
    --------------------------------------------------------
    CHART TYPE: Clustered Bar Chart
    X-AXIS: Dev Team member names (first name or first+second for 3-word names)
    Y-AXIS: Hours
    
    BARS:
    - Blue: Original Estimate (hours)
    - Cyan: Time Spent (hours)
    
    DATA SOURCE:
    - Assignee column for X-axis labels (Dev Team members only)
    - Original estimate column for estimate bars (divide by 3600)
    - Time Spent column for spent bars (divide by 3600)
    
    EXCLUDES: Epics and QA Tasks, Non-Dev team members
    */
    function updateGraph1() {
        // All Dev Team members combined
        const allDevTeam = [...JAFFER_TEAM, ...EHSAN_TEAM];
        
        // Deduplicate by Key first
        let data = getUniqueByKey(filteredData).filter(row => {
            if (['Epic', 'QA Task'].includes(row['Issue Type'])) return false;
            // Only include Dev Team members
            const assignee = (row.Assignee || '').toLowerCase();
            return allDevTeam.some(member => assignee.includes(member));
        });
        
        // Group by assignee
        const byAssignee = {};
        data.forEach(row => {
            const assignee = row.Assignee || 'Unassigned';
            if (!byAssignee[assignee]) byAssignee[assignee] = { est: 0, spent: 0 };
            byAssignee[assignee].est += row['Original estimate'] || 0;
            byAssignee[assignee].spent += row['Time Spent'] || 0;
        });
        
        // Sort by time spent
        const sorted = Object.entries(byAssignee)
            .sort((a, b) => b[1].spent - a[1].spent);
        
        // Store full names for tooltip
        const fullNames = sorted.map(([name]) => name);
        
        // Use first name (or first+second for 3-word names or if first word is Muhammad)
        const labels = sorted.map(([name]) => {
            const parts = name.split(' ').filter(p => p.length > 0);
            if (parts.length === 1) return parts[0];
            if (parts.length === 2) return parts[0];
            // For 3+ word names or if first word is Muhammad/Mohammad
            if (parts[0].toLowerCase().startsWith('muhammad') || parts[0].toLowerCase().startsWith('mohammad')) {
                return parts.length > 1 ? parts[1] : parts[0];
            }
            return parts.slice(0, 2).join(' ');
        });
        const estData = sorted.map(([, v]) => Math.round(v.est / 3600));
        const spentData = sorted.map(([, v]) => Math.round(v.spent / 3600));
        
        // Destroy old chart
        if (charts.estimatesVsSpent) charts.estimatesVsSpent.destroy();
        
        // Create new chart
        charts.estimatesVsSpent = new Chart(document.getElementById('chartEstimatesVsSpent'), {
            type: 'bar',
            data: {
                labels,
                datasets: [
                    { label: 'Estimate (h)', data: estData, backgroundColor: 'rgba(99,102,241,0.8)', borderRadius: 4 },
                    { label: 'Spent (h)', data: spentData, backgroundColor: 'rgba(34,211,238,0.8)', borderRadius: 4 }
                ]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: {
                    legend: { labels: { color: '#94a3b8' } },
                    tooltip: {
                        callbacks: {
                            title: function(context) {
                                return fullNames[context[0].dataIndex];
                            }
                        }
                    },
                    datalabels: { color: '#fff', font: { size: 9, weight: 'bold' }, anchor: 'end', align: 'top', formatter: v => v > 0 ? v + 'h' : '' }
                },
                scales: {
                    x: { 
                        ticks: { 
                            color: '#94a3b8',
                            maxRotation: 45,
                            minRotation: 0,
                            font: { size: 10 }
                        }, 
                        grid: { color: 'rgba(148,163,184,0.1)' } 
                    },
                    y: { ticks: { color: '#94a3b8', callback: v => v + 'h' }, grid: { color: 'rgba(148,163,184,0.1)' } }
                }
            }
        });
    }
    
    /*
    updateGraph2() - WORK ASSIGNED TO QA (TABLE)
    --------------------------------------------
    TABLE showing task distribution by QA member.
    
    COLUMNS:
    - QA: From QA column
    - Stability Items: Tagged with "stability"
    - Internal Bugs: Bug Source = Internal
    - Improvements: Issue Type = Improvement
    - New Features: All Stories
    - Other: Everything else
    - Time Committed: Original estimate in hours
    - Time Spent: Logged time in hours
    - Total: Sum of all categories
    */
    function updateGraph2() {
        // Deduplicate by Key first
        let data = getUniqueByKey(filteredData).filter(row => row.QA);
        
        const byQA = {};
        data.forEach(row => {
            const qa = row.QA;
            if (!byQA[qa]) byQA[qa] = { stability: 0, internal: 0, imp: 0, newFeatures: 0, other: 0, committed: 0, spent: 0 };
            
            const type = row['Issue Type'];
            const labels = (row.Labels || '').toLowerCase();
            let bugSource = (row['Bug Source'] || '').toLowerCase().trim();
            
            // Merge Unspecified with Internal
            if (bugSource === '' || bugSource === 'unspecified') bugSource = 'internal';
            
            // Add time data
            byQA[qa].committed += row['Original estimate'] || 0;
            byQA[qa].spent += row['Time Spent'] || 0;
            
            // Check for stability items first (tagged with stability)
            if (labels.includes('stability')) {
                byQA[qa].stability++;
            }
            // Internal Bugs: Bug Source contains "internal" (including merged unspecified)
            else if (['Bug', 'Reassigned Bug'].includes(type) && bugSource.includes('internal')) {
                byQA[qa].internal++;
            }
            // Improvements
            else if (type === 'Improvement') {
                byQA[qa].imp++;
            }
            // New Features (all Stories)
            else if (type === 'Story') {
                byQA[qa].newFeatures++;
            }
            // Other
            else {
                byQA[qa].other++;
            }
        });
        
        const total = Object.values(byQA).reduce((s, v) => s + v.stability + v.internal + v.imp + v.newFeatures + v.other, 0);
        
        document.querySelector('#tableQAWork tbody').innerHTML = Object.entries(byQA)
            .sort((a, b) => {
                const aTotal = a[1].stability + a[1].internal + a[1].imp + a[1].newFeatures + a[1].other;
                const bTotal = b[1].stability + b[1].internal + b[1].imp + b[1].newFeatures + b[1].other;
                return bTotal - aTotal;
            })
            .map(([qa, c]) => {
                const t = c.stability + c.internal + c.imp + c.newFeatures + c.other;
                const pct = total > 0 ? ((t / total) * 100).toFixed(1) : 0;
                const committedHrs = Math.round(c.committed / 3600);
                const spentHrs = Math.round(c.spent / 3600);
                return `<tr><td>${qa}</td><td class="num">${c.stability}</td><td class="num">${c.internal}</td><td class="num">${c.imp}</td><td class="num">${c.newFeatures}</td><td class="num">${c.other}</td><td class="num">${committedHrs}h</td><td class="num">${spentHrs}h</td><td class="num"><strong>${t}</strong> (${pct}%)</td></tr>`;
            }).join('');
    }
    
    /*
    updateGraph3() - STABILITY OVERVIEW
    ------------------------------------
    LINE CHART showing stability trends by month.
    Shows only 12 months at a time with year navigation.
    
    LINES:
    - Purple: Stability Items (tagged with "stability")
    - Red: Production bugs
    - Yellow: Internal bugs
    
    X-AXIS: Months (YYYY-MM format)
    Y-AXIS: Count
    */
    
    // Track current stability chart year (default to current year)
    let stabilityChartYear = new Date().getFullYear();
    
    function navigateStabilityChart(direction) {
        stabilityChartYear += direction;
        updateGraph3();
    }
    
    function updateGraph3() {
        // Stability chart uses rawData (ignores filters) to show full historical trend
        let data = getUniqueByKey(rawData);
        
        // Get all available years from data
        const availableYears = new Set();
        data.forEach(row => {
            if (row.Created) {
                availableYears.add(row.Created.getFullYear());
            }
        });
        const yearsArray = [...availableYears].sort();
        const minYear = yearsArray[0] || stabilityChartYear;
        const maxYear = yearsArray[yearsArray.length - 1] || stabilityChartYear;
        
        // Clamp stabilityChartYear to available range
        if (stabilityChartYear < minYear) stabilityChartYear = minYear;
        if (stabilityChartYear > maxYear) stabilityChartYear = maxYear;
        
        // Update year label and button states
        const yearLabel = document.getElementById('stabilityYearLabel');
        if (yearLabel) yearLabel.textContent = stabilityChartYear;
        
        // Disable/enable navigation buttons based on available data
        const prevBtn = document.querySelector('.chart-nav-btn[onclick*="-1"]');
        const nextBtn = document.querySelector('.chart-nav-btn[onclick*="1"]');
        if (prevBtn) prevBtn.disabled = stabilityChartYear <= minYear;
        if (nextBtn) nextBtn.disabled = stabilityChartYear >= maxYear;
        
        const byMonth = {};
        data.forEach(row => {
            const df = row.Created;
            if (!df) return;
            
            // Only include data from the selected year
            if (df.getFullYear() !== stabilityChartYear) return;
            
            const month = df.toISOString().slice(0, 7); // YYYY-MM
            if (!byMonth[month]) byMonth[month] = { stability: 0, prod: 0, internal: 0 };
            
            const type = row['Issue Type'];
            const labels = (row.Labels || '').toLowerCase();
            let source = (row['Bug Source'] || '').toLowerCase();
            
            // Merge Unspecified with Internal
            if (!source || source === 'unspecified') source = 'internal';
            
            // Stability items (tagged with stability)
            if (labels.includes('stability')) {
                byMonth[month].stability++;
            }
            // Production bugs
            else if (['Bug', 'Reassigned Bug'].includes(type) && source.includes('production')) {
                byMonth[month].prod++;
            }
            // Internal bugs: Bug Source contains "internal" (including merged unspecified)
            else if (['Bug', 'Reassigned Bug'].includes(type) && source.includes('internal')) {
                byMonth[month].internal++;
            }
        });
        
        // Generate all 12 months for the selected year (even if no data)
        const allMonths = [];
        for (let m = 1; m <= 12; m++) {
            const monthStr = `${stabilityChartYear}-${String(m).padStart(2, '0')}`;
            allMonths.push(monthStr);
        }
        
        // Map data to all months (use 0 for missing months)
        const monthLabels = allMonths.map(m => {
            const date = new Date(m + '-01');
            return date.toLocaleDateString('en-US', { month: 'short' });
        });
        
        if (charts.stabilityOverview) charts.stabilityOverview.destroy();
        
        const stabilityData = allMonths.map(m => (byMonth[m] || {}).stability || 0);
        const prodData = allMonths.map(m => (byMonth[m] || {}).prod || 0);
        const internalData = allMonths.map(m => (byMonth[m] || {}).internal || 0);
        
        charts.stabilityOverview = new Chart(document.getElementById('chartStabilityOverview'), {
            type: 'line',
            data: {
                labels: monthLabels,
                datasets: [
                    { label: `Stability Items (${stabilityData.reduce((a,b) => a+b, 0)})`, data: stabilityData, borderColor: '#6366f1', backgroundColor: 'rgba(99,102,241,0.1)', fill: true, tension: 0.4 },
                    { label: `Production Bugs (${prodData.reduce((a,b) => a+b, 0)})`, data: prodData, borderColor: '#ef4444', backgroundColor: 'rgba(239,68,68,0.1)', fill: true, tension: 0.4 },
                    { label: `Internal Bugs (${internalData.reduce((a,b) => a+b, 0)})`, data: internalData, borderColor: '#f59e0b', backgroundColor: 'rgba(245,158,11,0.1)', fill: true, tension: 0.4 }
                ]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: { labels: { color: '#94a3b8' } }, datalabels: { display: false } },
                scales: {
                    x: { ticks: { color: '#94a3b8' }, grid: { color: 'rgba(148,163,184,0.1)' } },
                    y: { ticks: { color: '#94a3b8' }, grid: { color: 'rgba(148,163,184,0.1)' } }
                }
            }
        });
    }
    
    /*
    updateGraph4() - TIME BY CATEGORY (DONUT)
    -----------------------------------------
    DONUT CHART showing time distribution by issue category.
    
    CATEGORIES:
    - Internal Bugs: Bug Source = Internal
    - Stability Items: Tagged with "stability" (includes Production Bugs)
    - New Features: All Stories
    - Enhancements: Issue Type = Improvement
    
    VALUES: Time Spent in hours (divide by 3600)
    */
    function updateGraph4() {
        // Deduplicate by Key first
        let data = getUniqueByKey(filteredData);
        
        const categories = { 'Internal Bugs': 0, 'Stability Items': 0, 'New Features': 0, 'Enhancements': 0 };
        
        data.forEach(row => {
            const type = row['Issue Type'];
            const labels = (row.Labels || '').toLowerCase();
            let source = (row['Bug Source'] || '').toLowerCase().trim();
            const time = row['Time Spent'] || 0;
            
            // Merge Unspecified with Internal
            if (source === '' || source === 'unspecified') source = 'internal';
            
            // Stability Items (tagged with stability, includes production bugs)
            if (labels.includes('stability') || source.includes('production')) {
                categories['Stability Items'] += time;
            }
            // Internal Bugs: Bug Source contains "internal" (including merged unspecified)
            else if (['Bug', 'Reassigned Bug'].includes(type) && source.includes('internal')) {
                categories['Internal Bugs'] += time;
            }
            // Enhancements
            else if (type === 'Improvement') {
                categories['Enhancements'] += time;
            }
            // New Features (all Stories)
            else if (type === 'Story') {
                categories['New Features'] += time;
            }
        });
        
        const vals = Object.values(categories).map(v => Math.round(v / 3600));
        const total = vals.reduce((a, b) => a + b, 0);
        
        if (charts.timeByCategory) charts.timeByCategory.destroy();
        
        charts.timeByCategory = new Chart(document.getElementById('chartTimeByCategory'), {
            type: 'doughnut',
            data: {
                labels: Object.keys(categories).map((k, i) => `${k} (${vals[i]}h)`),
                datasets: [{ data: vals, backgroundColor: ['#ef4444', '#f59e0b', '#6366f1', '#10b981'], borderWidth: 0 }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'right', labels: { color: '#94a3b8', font: { size: 11 } } },
                    datalabels: { color: '#fff', font: { size: 10, weight: 'bold' }, formatter: v => { const pct = total > 0 ? ((v / total) * 100).toFixed(0) : 0; return pct > 5 ? pct + '%' : ''; } }
                }
            }
        });
    }
    
    /*
    updateGraph5() - QA REOPEN SUMMARY (COLLAPSIBLE TABLE)
    ------------------------------------------------------
    Shows QA reopens grouped by QA member.
    */
    function updateGraph5() {
        // Deduplicate by Key first
        let data = getUniqueByKey(filteredData);
        
        // Build parent lookup map
        const parentMap = {};
        rawData.forEach(row => { parentMap[row.Key] = row; });
        
        const qaGroups = {};
        
        data.forEach(row => {
            if (row['Issue Type'] === 'QA Task') {
                const qa = row.Assignee || 'Unknown';
                const parent = parentMap[row.parent];
                
                if (!qaGroups[qa]) qaGroups[qa] = { items: [], reopens: 0, est: 0, logged: 0 };
                
                qaGroups[qa].items.push({
                    key: row.parent || row.Key,
                    summary: parent ? parent.Summary : row.Summary,
                    reopens: parent ? (parent['QA Reopen'] || 0) : 0,
                    est: row['Original estimate'] || 0,
                    logged: row['Time Spent'] || 0
                });
                
                qaGroups[qa].reopens += parent ? (parent['QA Reopen'] || 0) : 0;
                qaGroups[qa].est += row['Original estimate'] || 0;
                qaGroups[qa].logged += row['Time Spent'] || 0;
            }
        });
        
        let html = '', idx = 0;
        const jiraBaseUrl = 'https://contegris.atlassian.net/browse/';
        Object.entries(qaGroups).sort((a, b) => b[1].reopens - a[1].reopens).forEach(([qa, g]) => {
            const gid = `qaReopen${idx++}`;
            html += `<tr class="group-header" onclick="toggleGroup('${gid}', this)"><td colspan="5"><span class="toggle-icon">‚ñ∂</span>${qa}<span class="summary-value">${g.items.length} tasks | ${g.reopens} reopens</span></td></tr>`;
            g.items.forEach(i => {
                html += `<tr class="detail-row ${gid}"><td style="padding-left:2.5rem"><a href="${jiraBaseUrl}${i.key}" target="_blank" style="color:var(--secondary);text-decoration:none">${i.key}</a></td><td>${i.summary ? i.summary.substring(0, 35) + '...' : '-'}</td><td class="num">${i.reopens}</td><td class="num">${(i.est / 3600).toFixed(1)}</td><td class="num">${(i.logged / 3600).toFixed(1)}</td></tr>`;
            });
        });
        document.querySelector('#tableQAReopen tbody').innerHTML = html || '<tr><td colspan="5" style="text-align:center;color:#94a3b8">No data</td></tr>';
    }
    
    /*
    updateGraph6() - QA PROGRESS (HORIZONTAL BAR)
    ------------------------------------------------
    Shows completion progress per QA member.
    
    Horizontal bars showing completion percentage.
    */
    function updateGraph6() {
        // Deduplicate by Key first
        let data = getUniqueByKey(filteredData);
        
        // Categories for Y-axis
        const categories = {
            'All Tasks': { todo: 0, progress: 0, testing: 0, done: 0 },
            'New Features': { todo: 0, progress: 0, testing: 0, done: 0 },
            'Bugs': { todo: 0, progress: 0, testing: 0, done: 0 },
            'Enhancements': { todo: 0, progress: 0, testing: 0, done: 0 }
        };
        
        data.forEach(row => {
            if (['Epic', 'Sub-task', 'QA Task'].includes(row['Issue Type'])) return;
            
            const status = (row.Status || '').toLowerCase();
            const type = row['Issue Type'];
            
            // Determine status category
            let statusCat = 'todo';
            if (STATUS_GROUPS.done.some(s => status.includes(s))) {
                statusCat = 'done';
            } else if (STATUS_GROUPS.testing.some(s => status.includes(s))) {
                statusCat = 'testing';
            } else if (STATUS_GROUPS.inProgress.some(s => status.includes(s)) || STATUS_GROUPS.codeReview.some(s => status.includes(s))) {
                statusCat = 'progress';
            }
            
            // Add to All Tasks
            categories['All Tasks'][statusCat]++;
            
            // Add to specific category
            if (type === 'Story') {
                categories['New Features'][statusCat]++;
            } else if (['Bug', 'Reassigned Bug'].includes(type)) {
                categories['Bugs'][statusCat]++;
            } else if (type === 'Improvement') {
                categories['Enhancements'][statusCat]++;
            }
        });
        
        const labels = ['All Tasks', 'New Features', 'Bugs', 'Enhancements'];
        const todoData = labels.map(l => categories[l].todo);
        const progressData = labels.map(l => categories[l].progress);
        const testingData = labels.map(l => categories[l].testing);
        const doneData = labels.map(l => categories[l].done);
        
        if (charts.qaProgress) charts.qaProgress.destroy();
        
        charts.qaProgress = new Chart(document.getElementById('chartQAProgress'), {
            type: 'bar',
            data: {
                labels,
                datasets: [
                    { label: 'To Do', data: todoData, backgroundColor: 'rgba(148,163,184,0.6)', borderRadius: 2 },
                    { label: 'In Progress', data: progressData, backgroundColor: 'rgba(99,102,241,0.8)', borderRadius: 2 },
                    { label: 'Testing', data: testingData, backgroundColor: 'rgba(6,182,212,0.8)', borderRadius: 2 },
                    { label: 'Done', data: doneData, backgroundColor: 'rgba(16,185,129,0.8)', borderRadius: 2 }
                ]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: {
                    legend: { 
                        position: 'top',
                        labels: { color: '#94a3b8', boxWidth: 12, padding: 8, font: { size: 10 } } 
                    },
                    datalabels: { 
                        display: ctx => ctx.dataset.data[ctx.dataIndex] > 0,
                        color: '#fff', 
                        font: { size: 9, weight: 'bold' },
                        formatter: v => v > 0 ? v : ''
                    }
                },
                scales: {
                    x: { stacked: true, ticks: { color: '#94a3b8', font: { size: 10 } }, grid: { display: false } },
                    y: { stacked: true, ticks: { color: '#94a3b8' }, grid: { color: 'rgba(148,163,184,0.1)' } }
                }
            }
        });
    }
    
    /*
    updateQADetailTable() - QA DETAILED WORK TABLE
    ----------------------------------------------
    Collapsible table showing detailed QA work.
    Groups by QA member, shows individual issues when expanded.
    */
    function updateQADetailTable() {
        // Deduplicate by Key first
        let data = getUniqueByKey(filteredData);
        
        const parentMap = {};
        rawData.forEach(row => { parentMap[row.Key] = row; });
        
        const qaGroups = {};
        
        data.filter(row => row['Issue Type'] === 'QA Task').forEach(row => {
            const qa = row.Assignee || 'Unknown';
            const parent = parentMap[row.parent];
            
            if (!qaGroups[qa]) qaGroups[qa] = { items: [], est: 0, logged: 0 };
            
            qaGroups[qa].items.push({
                key: row.parent || row.Key,
                summary: parent ? parent.Summary : row.Summary,
                type: parent ? parent['Issue Type'] : 'N/A',
                status: parent ? parent.Status : row.Status,
                est: row['Original estimate'] || 0,
                logged: row['Time Spent'] || 0
            });
            
            qaGroups[qa].est += row['Original estimate'] || 0;
            qaGroups[qa].logged += row['Time Spent'] || 0;
        });
        
        let html = '', idx = 0;
        Object.entries(qaGroups).sort((a, b) => b[1].items.length - a[1].items.length).forEach(([qa, g]) => {
            const gid = `qaDetail${idx++}`;
            html += `<tr class="group-header" onclick="toggleGroup('${gid}', this)"><td colspan="4"><span class="toggle-icon">‚ñ∂</span>${qa}<span class="summary-value">${g.items.length}</span></td><td class="num">${(g.est / 3600).toFixed(1)}</td><td class="num">${(g.logged / 3600).toFixed(1)}</td></tr>`;
            g.items.forEach(i => {
                const jiraLink = `https://contegris.atlassian.net/browse/${i.key}`;
                html += `<tr class="detail-row ${gid}"><td style="padding-left:2.5rem"><a href="${jiraLink}" target="_blank" style="color:var(--secondary);text-decoration:none">${i.key}</a></td><td>${i.summary ? i.summary.substring(0, 40) + '...' : '-'}</td><td>${i.type}</td><td>${i.status || '-'}</td><td class="num">${(i.est / 3600).toFixed(1)}</td><td class="num">${(i.logged / 3600).toFixed(1)}</td></tr>`;
            });
        });
        document.querySelector('#tableQADetail tbody').innerHTML = html || '<tr><td colspan="6" style="text-align:center;color:#94a3b8">No data</td></tr>';
    }
    
    /*
    updateGraph7() & updateGraph8() - TEAM BUG RATIO CHARTS
    -------------------------------------------------------
    Bar + Line combo chart showing team quality metrics.
    
    BARS:
    - Blue: Story Points Completed
    - Red: Bugs reported
    
    LINE:
    - Orange: Bug ratio percentage
    
    RATIO TAGS (above chart):
    - Bug/SP: Bugs √∑ Story Points Done
    - Bug/Tasks: (Bugs √∑ Completed) √ó 100
    
    HOW BUGS ARE ATTRIBUTED:
    - First checks "Original Dev" column (for reassigned bugs)
    - Falls back to "Assignee" column
    */
    function updateGraph7() { updateBugRatioChart('chartJafferBugRatio', JAFFER_TEAM, 'jafferBugRatio', 'jafferRatioTags'); }
    function updateGraph8() { updateBugRatioChart('chartEhsanBugRatio', EHSAN_TEAM, 'ehsanBugRatio', 'ehsanRatioTags'); }
    
    function updateBugRatioChart(canvasId, team, chartKey, tagsId) {
        // Deduplicate by Key first
        let data = getUniqueByKey(filteredData);
        
        const teamData = {};
        team.forEach(m => { teamData[m] = { tasks: 0, done: 0, bugs: 0, sp: 0 }; });
        
        // Count completed tasks and story points
        data.forEach(row => {
            if (!row.Assignee) return;
            const name = row.Assignee.toLowerCase();
            const member = team.find(m => name.includes(m));
            
            if (member) {
                teamData[member].tasks++;
                if (['Done', 'Released', 'Staging Done', 'Stagging Done'].some(s => (row.Status || '').toLowerCase().includes(s.toLowerCase()))) {
                    if (!['Epic', 'QA Task', 'Sub-task'].includes(row['Issue Type'])) {
                        teamData[member].done++;
                        teamData[member].sp += row['Story Points'] || 0;
                    }
                }
            }
        });
        
        // Count bugs - check Original Dev first, then Assignee (only Internal bugs)
        data.filter(row => ['Bug', 'Reassigned Bug'].includes(row['Issue Type'])).forEach(row => {
            // Only count Internal bugs for ratio
            const bugSource = (row['Bug Source'] || '').toLowerCase();
            if (!bugSource.includes('internal')) return;
            
            const origDev = row['Original Dev'] || row.Assignee || '';
            const name = origDev.toLowerCase();
            const member = team.find(m => name.includes(m));
            if (member) teamData[member].bugs++;
        });
        
        // Calculate totals
        let totalBugs = 0, totalDone = 0, totalSP = 0;
        team.forEach(m => {
            totalBugs += teamData[m].bugs;
            totalDone += teamData[m].done;
            totalSP += teamData[m].sp;
        });
        
        // Update ratio tags
        const bugSP = totalSP > 0 ? (totalBugs / totalSP).toFixed(2) : 'N/A';
        const bugDone = totalDone > 0 ? ((totalBugs / totalDone) * 100).toFixed(1) : 'N/A';
        
        document.getElementById(tagsId).innerHTML = `
            <span class="ratio-tag ${bugSP > 0.5 ? 'danger' : 'success'}">Bug/SP: ${bugSP} (${totalBugs}/${totalSP.toFixed(0)})</span>
            <span class="ratio-tag ${bugDone > 30 ? 'danger' : bugDone > 15 ? 'warning' : 'success'}">Bug/Tasks: ${bugDone}% (${totalBugs}/${totalDone})</span>
        `;
        
        // Chart data - use Story Points instead of Tasks
        const labels = team.map(m => m.charAt(0).toUpperCase() + m.slice(1));
        const spData = team.map(m => teamData[m].sp);
        const bugsData = team.map(m => teamData[m].bugs);
        const ratioData = team.map(m => teamData[m].sp ? ((teamData[m].bugs / teamData[m].sp) * 100).toFixed(1) : 0);
        
        if (charts[chartKey]) charts[chartKey].destroy();
        
        charts[chartKey] = new Chart(document.getElementById(canvasId), {
            type: 'bar',
            data: {
                labels,
                datasets: [
                    { label: 'SP Completed', data: spData, backgroundColor: 'rgba(99,102,241,0.8)', borderRadius: 4, yAxisID: 'y' },
                    { label: 'Bugs', data: bugsData, backgroundColor: 'rgba(239,68,68,0.8)', borderRadius: 4, yAxisID: 'y' },
                    { label: 'Ratio (%)', data: ratioData, type: 'line', borderColor: '#f59e0b', backgroundColor: 'rgba(245,158,11,0.2)', yAxisID: 'y1', tension: 0.4, pointRadius: 4, pointBackgroundColor: '#f59e0b' }
                ]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: {
                    legend: { labels: { color: '#94a3b8' } },
                    datalabels: { display: ctx => ctx.datasetIndex < 2, color: '#fff', font: { size: 9, weight: 'bold' }, anchor: 'end', align: 'top', formatter: v => v > 0 ? v : '' }
                },
                scales: {
                    x: { ticks: { color: '#94a3b8' }, grid: { color: 'rgba(148,163,184,0.1)' } },
                    y: { position: 'left', ticks: { color: '#94a3b8' }, grid: { color: 'rgba(148,163,184,0.1)' }, title: { display: true, text: 'Count', color: '#94a3b8' } },
                    y1: { position: 'right', ticks: { color: '#f59e0b', callback: v => v + '%' }, grid: { display: false }, title: { display: true, text: 'Ratio %', color: '#f59e0b' } }
                }
            }
        });
    }
    
    /*
    updateDevEstimationTable() - DEVELOPER ESTIMATION TABLE
    -------------------------------------------------------
    Collapsible table showing estimate vs actual time per developer.
    Only shows Dev team members (JAFFER_TEAM + EHSAN_TEAM).
    */
    function updateDevEstimationTable() {
        // Deduplicate by Key first
        let data = getUniqueByKey(filteredData).filter(row => !['QA Task', 'Epic'].includes(row['Issue Type']));
        
        // Combine dev teams for filtering
        const DEV_TEAMS = [...JAFFER_TEAM, ...EHSAN_TEAM];
        
        const devGroups = {};
        
        data.forEach(row => {
            const dev = row.Assignee || 'Unassigned';
            // Only include if assignee is in dev teams (skip Unassigned)
            if (dev === 'Unassigned' || !matchesTeam(dev, DEV_TEAMS)) return;
            
            if (!devGroups[dev]) devGroups[dev] = { items: [], sp: 0, est: 0, logged: 0 };
            
            devGroups[dev].items.push({
                key: row.Key,
                summary: row.Summary,
                type: row['Issue Type'],
                sp: row['Story Points'] || 0,
                est: row['Original estimate'] || 0,
                logged: row['Time Spent'] || 0
            });
            
            devGroups[dev].sp += row['Story Points'] || 0;
            devGroups[dev].est += row['Original estimate'] || 0;
            devGroups[dev].logged += row['Time Spent'] || 0;
        });
        
        let html = '', idx = 0;
        const jiraBaseUrl = 'https://contegris.atlassian.net/browse/';
        Object.entries(devGroups).sort((a, b) => b[1].logged - a[1].logged).slice(0, 20).forEach(([dev, g]) => {
            const gid = `devEst${idx++}`;
            const ratio = g.est > 0 ? ((g.logged / g.est) * 100).toFixed(0) : 'N/A';
            const ratioStyle = ratio !== 'N/A' ? (ratio > 150 ? 'color:var(--danger)' : ratio > 100 ? 'color:var(--warning)' : 'color:var(--success)') : '';
            
            html += `<tr class="group-header" onclick="toggleGroup('${gid}', this)"><td colspan="3"><span class="toggle-icon">‚ñ∂</span>${dev}<span class="summary-value">${g.items.length}</span></td><td class="num">${g.sp.toFixed(0)}</td><td class="num">${(g.est / 3600).toFixed(1)}</td><td class="num">${(g.logged / 3600).toFixed(1)}</td><td class="num" style="${ratioStyle}">${ratio}%</td></tr>`;
            
            g.items.slice(0, 15).forEach(i => {
                const ir = i.est > 0 ? ((i.logged / i.est) * 100).toFixed(0) : 'N/A';
                html += `<tr class="detail-row ${gid}"><td style="padding-left:2.5rem"><a href="${jiraBaseUrl}${i.key}" target="_blank" style="color:var(--secondary);text-decoration:none">${i.key}</a></td><td>${i.summary ? i.summary.substring(0, 40) + '...' : '-'}</td><td>${i.type}</td><td class="num">${i.sp || '-'}</td><td class="num">${(i.est / 3600).toFixed(1)}</td><td class="num">${(i.logged / 3600).toFixed(1)}</td><td class="num">${ir}%</td></tr>`;
            });
            
            if (g.items.length > 15) {
                html += `<tr class="detail-row ${gid}"><td colspan="7" style="text-align:center;font-style:italic;color:#94a3b8">...+${g.items.length - 15} more</td></tr>`;
            }
        });
        
        document.querySelector('#tableDevEstimation tbody').innerHTML = html || '<tr><td colspan="7" style="text-align:center;color:#94a3b8">No data</td></tr>';
    }
    
    /*
    updateGraph9() - SPRINT PROGRESS
    --------------------------------
    Visual progress bars for recent sprints.
    
    STATUS MAPPING:
    - Done (Green): Status contains "done" or "released"
    - Testing (Cyan): Status contains "testing", "staging"
    - Review (Yellow): Status contains "code review", "reviewed"
    - Progress (Purple): Status contains "in progress"
    - To Do (Gray): Everything else
    */
    function updateGraph9() {
        // Deduplicate by Key first
        let data = getUniqueByKey(filteredData);
        
        const container = document.getElementById('sprintProgressContainer');
        const sprints = [...new Set(data.map(row => row.Sprint).filter(Boolean))].sort().slice(-5);
        
        if (!sprints.length) {
            container.innerHTML = '<p style="text-align:center;color:#94a3b8;padding:2rem">No sprint data</p>';
            return;
        }
        
        container.innerHTML = sprints.map(sprint => {
            const sprintData = data.filter(row => (row.Sprint || '').includes(sprint));
            const total = sprintData.length;
            
            const statusCounts = { done: 0, testing: 0, review: 0, progress: 0, todo: 0 };
            
            sprintData.forEach(row => {
                const status = (row.Status || '').toLowerCase();
                if (STATUS_GROUPS.done.some(s => status.includes(s))) statusCounts.done++;
                else if (STATUS_GROUPS.testing.some(s => status.includes(s))) statusCounts.testing++;
                else if (STATUS_GROUPS.codeReview.some(s => status.includes(s))) statusCounts.review++;
                else if (STATUS_GROUPS.inProgress.some(s => status.includes(s))) statusCounts.progress++;
                else statusCounts.todo++;
            });
            
            const pct = c => total ? (c / total * 100).toFixed(1) : 0;
            const donePct = total > 0 ? ((statusCounts.done / total) * 100).toFixed(0) : 0;
            
            return `
                <div class="sprint-progress-item">
                    <div class="sprint-header">
                        <span class="sprint-name">${sprint}</span>
                        <span class="sprint-count">${total} items | ${donePct}% done</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-segment done" style="width:${pct(statusCounts.done)}%"></div>
                        <div class="progress-segment testing" style="width:${pct(statusCounts.testing)}%"></div>
                        <div class="progress-segment review" style="width:${pct(statusCounts.review)}%"></div>
                        <div class="progress-segment progress" style="width:${pct(statusCounts.progress)}%"></div>
                        <div class="progress-segment todo" style="width:${pct(statusCounts.todo)}%"></div>
                    </div>
                    <div class="sprint-stats">
                        <span>Done: ${statusCounts.done} (${pct(statusCounts.done)}%)</span>
                        <span>Testing: ${statusCounts.testing} (${pct(statusCounts.testing)}%)</span>
                        <span>Review: ${statusCounts.review} (${pct(statusCounts.review)}%)</span>
                        <span>Progress: ${statusCounts.progress} (${pct(statusCounts.progress)}%)</span>
                        <span>To Do: ${statusCounts.todo} (${pct(statusCounts.todo)}%)</span>
                    </div>
                </div>
            `;
        }).join('');
    }
    
    /*
    updateDevWorkTable() - PRODUCT TEAM TABLE
    ------------------------------------------
    Collapsible table showing task distribution by developer.
    Only shows Dev team members (JAFFER_TEAM + EHSAN_TEAM).
    Includes Time Committed (Original estimate) and Time Spent columns.
    */
    function updateDevWorkTable() {
        // Deduplicate by Key first, filter to non-QA issue types
        let data = getUniqueByKey(filteredData).filter(row => row.Assignee && !['QA Task', 'Epic', 'Sub-task'].includes(row['Issue Type']));
        
        // Combine dev teams for filtering
        const DEV_TEAMS = [...JAFFER_TEAM, ...EHSAN_TEAM];
        
        const byDev = {};
        data.forEach(row => {
            const dev = row.Assignee;
            // Only include if assignee is in dev teams
            if (!matchesTeam(dev, DEV_TEAMS)) return;
            
            if (!byDev[dev]) byDev[dev] = { items: [], totalSP: 0, totalCommitted: 0, totalSpent: 0 };
            
            const committed = row['Original estimate'] || 0;
            const spent = row['Time Spent'] || 0;
            
            byDev[dev].items.push({
                key: row.Key,
                summary: row.Summary || '',
                type: row['Issue Type'],
                status: row.Status || '',
                sp: row['Story Points'] || 0,
                committed: committed,
                spent: spent
            });
            byDev[dev].totalSP += row['Story Points'] || 0;
            byDev[dev].totalCommitted += committed;
            byDev[dev].totalSpent += spent;
        });
        
        let html = '', idx = 0;
        Object.entries(byDev)
            .sort((a, b) => b[1].items.length - a[1].items.length)
            .slice(0, 15)
            .forEach(([dev, g]) => {
                const gid = `devWork${idx++}`;
                const jiraBaseUrl = 'https://contegris.atlassian.net/browse/';
                const committedHrs = Math.round(g.totalCommitted / 3600);
                const spentHrs = Math.round(g.totalSpent / 3600);
                html += `<tr class="group-header" onclick="toggleGroup('${gid}', this)"><td colspan="8"><span class="toggle-icon">‚ñ∂</span>${dev}<span class="summary-value">${g.items.length} items | ${g.totalSP} SP | ${committedHrs}h committed | ${spentHrs}h spent</span></td></tr>`;
                g.items.forEach(i => {
                    const itemCommittedHrs = Math.round(i.committed / 3600);
                    const itemSpentHrs = Math.round(i.spent / 3600);
                    html += `<tr class="detail-row ${gid}"><td style="padding-left:2.5rem"><a href="${jiraBaseUrl}${i.key}" target="_blank" style="color:var(--secondary);text-decoration:none">${i.key}</a></td><td>${i.summary.substring(0, 30)}${i.summary.length > 30 ? '...' : ''}</td><td class="num">${i.type}</td><td class="num">${i.status}</td><td class="num">${i.sp}</td><td class="num">${itemCommittedHrs}h</td><td class="num">${itemSpentHrs}h</td><td></td></tr>`;
                });
            });
        
        document.querySelector('#tableDevWork tbody').innerHTML = html || '<tr><td colspan="8" style="text-align:center;color:#94a3b8">No data</td></tr>';
    }
    
    /*
    updateGraph10() - PRODUCT TEAM MEMBERS
    --------------------------------------
    Collapsible table showing team members per product/component.
    Now includes task summaries, time estimated and time spent for each member.
    Group headers show total time spent for the product.
    */
    function updateGraph10() {
        // Deduplicate by Key first
        let data = getUniqueByKey(filteredData);
        
        const jiraBaseUrl = 'https://contegris.atlassian.net/browse/';
        const productTeams = {};
        
        data.forEach(row => {
            const components = (row.Components || '').split(';').map(c => c.trim()).filter(Boolean);
            components.forEach(comp => {
                if (!productTeams[comp]) productTeams[comp] = { 
                    devs: new Set(), 
                    qas: new Set(), 
                    devTasks: {}, 
                    qaTasks: {},
                    devSummaries: {},
                    qaSummaries: {},
                    devTimeEst: {},
                    devTimeSpent: {},
                    qaTimeEst: {},
                    qaTimeSpent: {},
                    totalTimeSpent: 0  // Track total time for the product
                };
                // Add time spent to product total (only once per row to avoid double counting)
                productTeams[comp].totalTimeSpent += (row['Time Spent'] || 0);
                
                if (row.Assignee) {
                    productTeams[comp].devs.add(row.Assignee);
                    productTeams[comp].devTasks[row.Assignee] = (productTeams[comp].devTasks[row.Assignee] || 0) + 1;
                    productTeams[comp].devTimeEst[row.Assignee] = (productTeams[comp].devTimeEst[row.Assignee] || 0) + (row['Original estimate'] || 0);
                    productTeams[comp].devTimeSpent[row.Assignee] = (productTeams[comp].devTimeSpent[row.Assignee] || 0) + (row['Time Spent'] || 0);
                    if (!productTeams[comp].devSummaries[row.Assignee]) {
                        productTeams[comp].devSummaries[row.Assignee] = [];
                    }
                    productTeams[comp].devSummaries[row.Assignee].push({
                        key: row.Key,
                        summary: row.Summary || 'No summary'
                    });
                }
                if (row.QA) {
                    productTeams[comp].qas.add(row.QA);
                    productTeams[comp].qaTasks[row.QA] = (productTeams[comp].qaTasks[row.QA] || 0) + 1;
                    productTeams[comp].qaTimeEst[row.QA] = (productTeams[comp].qaTimeEst[row.QA] || 0) + (row['Original estimate'] || 0);
                    productTeams[comp].qaTimeSpent[row.QA] = (productTeams[comp].qaTimeSpent[row.QA] || 0) + (row['Time Spent'] || 0);
                    if (!productTeams[comp].qaSummaries[row.QA]) {
                        productTeams[comp].qaSummaries[row.QA] = [];
                    }
                    productTeams[comp].qaSummaries[row.QA].push({
                        key: row.Key,
                        summary: row.Summary || 'No summary'
                    });
                }
            });
        });
        
        let html = '', idx = 0;
        Object.entries(productTeams)
            .sort((a, b) => (b[1].devs.size + b[1].qas.size) - (a[1].devs.size + a[1].qas.size))
            .slice(0, 15)
            .forEach(([product, teams]) => {
                const gid = `prodTeam${idx++}`;
                const totalTimeHrs = Math.round(teams.totalTimeSpent / 3600);
                html += `<tr class="group-header" onclick="toggleGroup('${gid}', this)"><td colspan="6"><span class="toggle-icon">‚ñ∂</span>${product}<span class="summary-value">${teams.devs.size} devs | ${teams.qas.size} QA | ${totalTimeHrs}h spent</span></td></tr>`;
                
                // Add dev members with ALL task summaries
                [...teams.devs].forEach(dev => {
                    const tasks = teams.devTasks[dev] || 0;
                    const summaries = teams.devSummaries[dev] || [];
                    const estHrs = Math.round((teams.devTimeEst[dev] || 0) / 3600);
                    const spentHrs = Math.round((teams.devTimeSpent[dev] || 0) / 3600);
                    const summaryHtml = summaries.map(t => 
                        `<a href="${jiraBaseUrl}${t.key}" target="_blank" style="color:var(--secondary);text-decoration:none" title="${t.summary}">${t.key}</a>: ${t.summary.substring(0, 50)}${t.summary.length > 50 ? '...' : ''}`
                    ).join('<br>');
                    html += `<tr class="detail-row ${gid}"><td style="padding-left:2.5rem;vertical-align:top">${dev}</td><td style="vertical-align:top">Developer</td><td class="num" style="vertical-align:top">${tasks}</td><td class="num" style="vertical-align:top">${estHrs}h</td><td class="num" style="vertical-align:top">${spentHrs}h</td><td style="font-size:0.75rem;line-height:1.4;vertical-align:top;word-break:break-word">${summaryHtml || '-'}</td></tr>`;
                });
                
                // Add QA members with ALL task summaries
                [...teams.qas].forEach(qa => {
                    const tasks = teams.qaTasks[qa] || 0;
                    const summaries = teams.qaSummaries[qa] || [];
                    const estHrs = Math.round((teams.qaTimeEst[qa] || 0) / 3600);
                    const spentHrs = Math.round((teams.qaTimeSpent[qa] || 0) / 3600);
                    const summaryHtml = summaries.map(t => 
                        `<a href="${jiraBaseUrl}${t.key}" target="_blank" style="color:var(--secondary);text-decoration:none" title="${t.summary}">${t.key}</a>: ${t.summary.substring(0, 50)}${t.summary.length > 50 ? '...' : ''}`
                    ).join('<br>');
                    html += `<tr class="detail-row ${gid}"><td style="padding-left:2.5rem;vertical-align:top">${qa}</td><td style="vertical-align:top">QA</td><td class="num" style="vertical-align:top">${tasks}</td><td class="num" style="vertical-align:top">${estHrs}h</td><td class="num" style="vertical-align:top">${spentHrs}h</td><td style="font-size:0.75rem;line-height:1.4;vertical-align:top;word-break:break-word">${summaryHtml || '-'}</td></tr>`;
                });
            });
        
        document.querySelector('#tableProductTeam tbody').innerHTML = html || '<tr><td colspan="6" style="text-align:center;color:#94a3b8">No data</td></tr>';
    }
    
    /*
    updateGraph11() - PRODUCTION FEATURES (POLAR AREA)
    --------------------------------------------------
    Shows completed items by category.
    Only includes items with Done/Released status.
    */
    function updateGraph11() {
        // Deduplicate by Key first
        let data = getUniqueByKey(filteredData);
        
        const categories = { 'New Features': 0, 'Enhancements': 0, 'Internal Bugs': 0, 'Production Bugs': 0 };
        
        const doneData = data.filter(row => 
            ['Done', 'Released', 'Staging Done', 'Stagging Done'].some(s => 
                (row.Status || '').toLowerCase().includes(s.toLowerCase())
            )
        );
        
        doneData.forEach(row => {
            const type = row['Issue Type'];
            const labels = (row.Labels || '').toLowerCase();
            let source = (row['Bug Source'] || '').toLowerCase().trim();
            
            // Merge Unspecified with Internal
            if (source === '' || source === 'unspecified') source = 'internal';
            
            if (labels.includes('newrequirement')) categories['New Features']++;
            else if (type === 'Improvement') categories['Enhancements']++;
            else if (['Bug', 'Reassigned Bug'].includes(type)) {
                if (source.includes('production')) categories['Production Bugs']++;
                else if (source.includes('internal')) categories['Internal Bugs']++;
            }
        });
        
        const total = Object.values(categories).reduce((a, b) => a + b, 0);
        
        if (charts.productionFeatures) charts.productionFeatures.destroy();
        
        charts.productionFeatures = new Chart(document.getElementById('chartProductionFeatures'), {
            type: 'polarArea',
            data: {
                labels: Object.keys(categories).map((k, i) => `${k} (${Object.values(categories)[i]})`),
                datasets: [{ data: Object.values(categories), backgroundColor: ['rgba(99,102,241,0.8)', 'rgba(16,185,129,0.8)', 'rgba(245,158,11,0.8)', 'rgba(239,68,68,0.8)'], borderWidth: 0 }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'right', labels: { color: '#94a3b8' } },
                    datalabels: { color: '#fff', font: { size: 10, weight: 'bold' }, formatter: v => { const pct = total > 0 ? ((v / total) * 100).toFixed(0) : 0; return pct > 5 ? `${v}\n(${pct}%)` : ''; } }
                },
                scales: { r: { ticks: { color: '#94a3b8', backdropColor: 'transparent' }, grid: { color: 'rgba(148,163,184,0.2)' } } }
            }
        });
    }
    
    /*
    updateGraph12() - WORK ITEMS BY SOURCE (DONUT)
    ----------------------------------------------
    Shows distribution of issues by Required By field.
    Unspecified items are merged into Internal.
    */
    function updateGraph12() {
        // Deduplicate by Key first
        let data = getUniqueByKey(filteredData);
        
        const byRequired = {};
        data.forEach(row => {
            let req = (row['Required By'] || '').trim();
            // Merge Unspecified/empty into Internal
            if (!req || req.toLowerCase() === 'unspecified') {
                req = 'Internal';
            }
            if (!byRequired[req]) byRequired[req] = 0;
            byRequired[req]++;
        });
        
        const sorted = Object.entries(byRequired).sort((a, b) => b[1] - a[1]);
        const labels = sorted.map(([name, count]) => `${name} (${count})`);
        const values = sorted.map(([, count]) => count);
        const total = values.reduce((a, b) => a + b, 0);
        const colors = ['#6366f1', '#22d3ee', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#14b8a6', '#f97316', '#84cc16'];
        
        if (charts.releaseBySource) charts.releaseBySource.destroy();
        
        charts.releaseBySource = new Chart(document.getElementById('chartReleaseBySource'), {
            type: 'doughnut',
            data: {
                labels,
                datasets: [{ data: values, backgroundColor: colors.slice(0, labels.length), borderWidth: 0 }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'right', labels: { color: '#94a3b8', font: { size: 10 } } },
                    datalabels: { color: '#fff', font: { size: 10, weight: 'bold' }, formatter: v => { const pct = total > 0 ? ((v / total) * 100).toFixed(0) : 0; return pct > 5 ? pct + '%' : ''; } }
                }
            }
        });
    }
    
    /*
    updateGraph13() - DEVELOPER SCORECARD
    =====================================
    Card grid showing Dev Team member performance metrics.
    
    INCLUSION CRITERIA:
    - Only includes developers from JAFFER_TEAM and EHSAN_TEAM arrays
    - Excludes Epic and QA Task issue types from counting
    
    METRICS DISPLAYED:
    
    1. ‚úÖ Done (Completed Tasks)
       - Count of issues assigned to developer with Status containing:
         "Done", "Released", "Staging Done", or "Stagging Done"
       - Excludes Epics and QA Tasks
    
    2. ‚è±Ô∏è Time (Hours Logged)
       - Sum of "Time Spent" column for all issues assigned to developer
       - Converted from seconds to hours (√∑ 3600)
       - Includes all issue types except Epics and QA Tasks
    
    3. üêõ Bugs (Bug Count)
       - Count of Bug/Reassigned Bug issues attributed to developer
       - First checks "Original Dev" column (for reassigned bugs)
       - Falls back to "Assignee" column if no Original Dev
       - This tracks bugs created by developer's code
    
    4. üìä Ratio (Bug Percentage)
       - Formula: (Bugs / Done Tasks) √ó 100
       - Lower percentage = better quality
       - Interpretation:
         * < 10%: Excellent
         * 10-20%: Good
         * > 20%: Needs attention
    
    5. üîÑ Reopens (QA Reopen Count)
       - Sum of "QA Reopen" column for issues assigned to developer
       - Tracks how many times QA sent issues back for fixes
       - Lower = better quality first-time
    
    SORTING: Developers sorted by Done count (highest first)
    */
    function updateGraph13() {
        // Deduplicate by Key first
        let data = getUniqueByKey(filteredData);
        
        // Only track Dev Team members
        const allDevTeam = [...JAFFER_TEAM, ...EHSAN_TEAM];
        const devStats = {};
        
        data.forEach(row => {
            if (['Epic', 'QA Task'].includes(row['Issue Type'])) return;
            
            const assignee = row.Assignee;
            if (!assignee) return;
            
            // Only include Dev Team members
            const assigneeLower = assignee.toLowerCase();
            if (!allDevTeam.some(member => assigneeLower.includes(member))) return;
            
            if (!devStats[assignee]) devStats[assignee] = { tasks: 0, done: 0, sp: 0, time: 0, bugs: 0, reopens: 0 };
            
            devStats[assignee].tasks++;
            if (['Done', 'Released', 'Staging Done', 'Stagging Done'].some(s => (row.Status || '').toLowerCase().includes(s.toLowerCase()))) {
                devStats[assignee].done++;
            }
            devStats[assignee].sp += row['Story Points'] || 0;
            devStats[assignee].time += row['Time Spent'] || 0;
            devStats[assignee].reopens += row['QA Reopen'] || 0;
        });
        
        // Count bugs
        data.filter(row => ['Bug', 'Reassigned Bug'].includes(row['Issue Type'])).forEach(row => {
            const origDev = row['Original Dev'] || row.Assignee || '';
            if (devStats[origDev]) devStats[origDev].bugs++;
        });
        
        document.getElementById('devScorecardGrid').innerHTML = Object.entries(devStats)
            .sort((a, b) => b[1].done - a[1].done)
            .map(([name, stats]) => {
                const bugRatio = stats.done ? ((stats.bugs / stats.done) * 100).toFixed(1) : 0;
                const initials = name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
                return `
                    <div class="scorecard-item">
                        <div class="scorecard-avatar">${initials}</div>
                        <div class="scorecard-info">
                            <div class="scorecard-name">${name}</div>
                            <div class="scorecard-stats">
                                <span class="scorecard-stat">‚úÖ Done: ${stats.done}</span>
                                <span class="scorecard-stat">‚è±Ô∏è Time: ${Math.round(stats.time / 3600)}h</span>
                                <span class="scorecard-stat">üêõ Bugs: ${stats.bugs}</span>
                                <span class="scorecard-stat highlight">üìä Ratio: ${bugRatio}%</span>
                                <span class="scorecard-stat">üîÑ Reopens: ${stats.reopens}</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('') || '<p style="text-align:center;color:#94a3b8;grid-column:span 3">No data</p>';
    }
    
    /*
    updateGraph14() - QA SCORECARD
    ==============================
    Card grid showing QA Team member performance metrics.
    
    INCLUSION CRITERIA:
    - Only includes QA members from QA_TEAM array
    - Tracks issues where the "QA" column matches team member
    
    METRICS DISPLAYED:
    
    1. üêõ Found (Bugs Found)
       - Count of Bug/Reassigned Bug issues where QA column matches member
       - Tracks how many bugs this QA person is assigned to test
    
    2. ‚úÖ Verified (Bugs Verified)
       - Count of Bug/Reassigned Bug issues where:
         * QA column matches member
         * Status contains "Done" or "Released"
       - Tracks bugs that QA has verified as fixed
    
    3. üí° Enhancements (Improvements Tested)
       - Count of Improvement type issues where QA column matches member
       - Tracks enhancement work tested by this QA
    
    4. üîÑ Reopens (Reopen Count)
       - Sum of "QA Reopen" column for issues assigned to QA member
       - Tracks how many times QA sent issues back to dev
       - Higher = more thorough testing OR recurring issues
    
    5. ‚è±Ô∏è Time (Hours Logged)
       - Sum of "Time Spent" from QA Task issues assigned to member
       - Looks at QA Task issue types where Assignee matches
       - Converted from seconds to hours (√∑ 3600)
    
    SORTING: QA members sorted by Bugs Found count (highest first)
    
    NOTE: Time is calculated from QA Task subtasks, not from the parent
    issues. This ensures accurate QA-specific time tracking.
    */
    function updateGraph14() {
        // Deduplicate by Key first
        let data = getUniqueByKey(filteredData);
        
        const qaStats = {};
        
        // Only track QA Team members
        data.forEach(row => {
            const qa = row.QA;
            if (!qa) return;
            
            // Only include QA Team members
            const qaLower = qa.toLowerCase();
            if (!QA_TEAM.some(member => qaLower.includes(member))) return;
            
            if (!qaStats[qa]) qaStats[qa] = { found: 0, verified: 0, imp: 0, reopens: 0, time: 0 };
            
            const type = row['Issue Type'];
            if (['Bug', 'Reassigned Bug'].includes(type)) qaStats[qa].found++;
            if (type === 'Improvement') qaStats[qa].imp++;
            if (['Done', 'Released'].some(s => (row.Status || '').includes(s)) && ['Bug', 'Reassigned Bug'].includes(type)) {
                qaStats[qa].verified++;
            }
            qaStats[qa].reopens += row['QA Reopen'] || 0;
        });
        
        // Get time from QA Tasks
        data.filter(row => row['Issue Type'] === 'QA Task').forEach(row => {
            const assignee = row.Assignee;
            if (qaStats[assignee]) qaStats[assignee].time += row['Time Spent'] || 0;
        });
        
        document.getElementById('qaScorecardGrid').innerHTML = Object.entries(qaStats)
            .sort((a, b) => b[1].found - a[1].found)
            .map(([name, stats]) => {
                const initials = name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
                return `
                    <div class="scorecard-item">
                        <div class="scorecard-avatar qa">${initials}</div>
                        <div class="scorecard-info">
                            <div class="scorecard-name">${name}</div>
                            <div class="scorecard-stats">
                                <span class="scorecard-stat">üêõ Found: ${stats.found}</span>
                                <span class="scorecard-stat">‚úÖ Verified: ${stats.verified}</span>
                                <span class="scorecard-stat">üí° Enhancements: ${stats.imp}</span>
                                <span class="scorecard-stat highlight">üîÑ Reopens: ${stats.reopens}</span>
                                <span class="scorecard-stat">‚è±Ô∏è Time: ${Math.round(stats.time / 3600)}h</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('') || '<p style="text-align:center;color:#94a3b8;grid-column:span 3">No data</p>';
    }
    
    /*
    ============================================================================
    SECTION: RACE TRACK VISUALIZATIONS
    ============================================================================
    Fun, gamified performance visualizations for Dev and QA teams.
    */
    
    /*
    updateDevRaceTrack()
    --------------------
    PURPOSE: Creates a race track visualization for Developer performance
    
    SCORING FORMULA:
    - Done Tasks √ó 10 points (rewards completing work)
    - Story Points √ó 5 points (rewards tackling bigger items)
    - Bugs √ó -15 points (penalty for bugs attributed)
    - Reopens √ó -10 points (penalty for QA returns)
    
    INTERPRETATION:
    - Higher score = further ahead in the race
    - Position 1 = Gold medal (best performer)
    - Position 2 = Silver medal
    - Position 3 = Bronze medal
    */
    // Race animation state
    let devRaceInterval = null;
    let qaRaceInterval = null;
    let devRacers = [];
    let qaRacers = [];
    
    function updateDevRaceTrack() {
        const data = getUniqueByKey(filteredData);
        const allDevTeam = [...JAFFER_TEAM, ...EHSAN_TEAM];
        const devStats = {};
        
        // Collect stats for each developer
        data.forEach(row => {
            if (['Epic', 'QA Task'].includes(row['Issue Type'])) return;
            
            const assignee = row.Assignee;
            if (!assignee) return;
            
            const assigneeLower = assignee.toLowerCase();
            if (!allDevTeam.some(member => assigneeLower.includes(member))) return;
            
            if (!devStats[assignee]) devStats[assignee] = { done: 0, sp: 0, bugs: 0, reopens: 0 };
            
            // Count done tasks
            if (['Done', 'Released', 'Staging Done', 'Stagging Done'].some(s => 
                (row.Status || '').toLowerCase().includes(s.toLowerCase()))) {
                devStats[assignee].done++;
            }
            devStats[assignee].sp += row['Story Points'] || 0;
            devStats[assignee].reopens += row['QA Reopen'] || 0;
        });
        
        // Count bugs (attributed to Original Dev or Assignee)
        data.filter(row => ['Bug', 'Reassigned Bug'].includes(row['Issue Type'])).forEach(row => {
            const dev = row['Original Dev'] || row.Assignee || '';
            if (devStats[dev]) devStats[dev].bugs++;
        });
        
        // Calculate scores and store globally for animation
        devRacers = Object.entries(devStats).map(([name, stats]) => {
            const score = (stats.done * 10) + (stats.sp * 5) - (stats.bugs * 15) - (stats.reopens * 10);
            return {
                name,
                score: Math.max(score, 1), // Minimum 1 point for animation
                stats,
                statsText: `‚úÖ${stats.done} üìê${stats.sp} üêõ${stats.bugs} üîÑ${stats.reopens}`,
                position: 0 // Current race position (0-100%)
            };
        });
        
        // Sort by score descending
        devRacers.sort((a, b) => b.score - a.score);
        
        // Racing car emojis
        const cars = ['üèéÔ∏è', 'üöó', 'üèçÔ∏è', 'üöï', 'üöô', 'üöì', 'üõª', 'üöê', 'üöå', 'üöë', 'üöé'];
        const trophies = ['ü•á', 'ü•à', 'ü•â'];
        
        // Render race lanes with animation elements
        const lanesHtml = devRacers.map((racer, index) => {
            const position = index + 1;
            const positionClass = position === 1 ? 'gold' : position === 2 ? 'silver' : position === 3 ? 'bronze' : 'other';
            const laneClass = position === 1 ? 'first-place' : position === 2 ? 'second-place' : position === 3 ? 'third-place' : '';
            const car = cars[index % cars.length];
            const trophy = position <= 3 ? `<span class="podium-trophy">${trophies[position-1]}</span>` : '';
            
            return `
                <div class="race-lane ${laneClass}" data-racer-index="${index}">
                    <div class="race-lane-track"></div>
                    <div class="racer-position ${positionClass}">${position}</div>
                    <div class="racer-car-container">
                        <span class="racer-car" id="devCar${index}">${car}</span>
                        <div class="speed-lines">
                            <div class="speed-line" style="width: 15px;"></div>
                            <div class="speed-line" style="width: 20px;"></div>
                            <div class="speed-line" style="width: 12px;"></div>
                        </div>
                    </div>
                    <div class="racer-info">
                        <div class="racer-name">${racer.name}${trophy}</div>
                        <div class="racer-stats">${racer.statsText}</div>
                    </div>
                    <div class="finish-name" id="devFinish${index}">${racer.name} üèÅ</div>
                    <div class="racer-score">${racer.score} pts</div>
                </div>
            `;
        }).join('');
        
        document.getElementById('devTrackLanes').innerHTML = lanesHtml || 
            '<p style="text-align:center;color:#94a3b8;padding:2rem">No developer data available</p>';
        
        // Update podium display
        const podiumHtml = devRacers.slice(0, 3).map((racer, index) => {
            const spotClass = index === 0 ? 'first' : index === 1 ? 'second' : 'third';
            const firstName = racer.name.split(' ')[0];
            return `
                <div class="podium-spot ${spotClass}">
                    <div class="podium-block">${trophies[index]}</div>
                    <div class="podium-name">${firstName}</div>
                </div>
            `;
        }).join('');
        
        document.getElementById('devPodium').innerHTML = podiumHtml;
        
        // Reset race state
        document.getElementById('devWinnerCelebration').classList.remove('show');
        document.getElementById('devRaceStatus').innerHTML = '<span>‚è∏Ô∏è</span> Ready';
        document.getElementById('devRaceStatus').className = 'race-status';
    }
    
    function startDevRace() {
        if (devRacers.length === 0) return;
        
        // Reset positions
        devRacers.forEach(r => {
            r.position = 0;
            r.finished = false;
        });
        
        // Update UI
        document.getElementById('devRaceStart').disabled = true;
        document.getElementById('devRaceStop').disabled = false;
        document.getElementById('devRaceStatus').innerHTML = '<span>üèÅ</span> Racing...';
        document.getElementById('devRaceStatus').className = 'race-status racing';
        document.getElementById('devWinnerCelebration').classList.remove('show');
        
        // Add racing class to cars and lanes, hide finish names
        devRacers.forEach((_, i) => {
            const car = document.getElementById(`devCar${i}`);
            const lane = document.querySelector(`[data-racer-index="${i}"]`);
            const finishName = document.getElementById(`devFinish${i}`);
            if (car) {
                car.classList.add('racing');
                car.style.left = '0%';
            }
            if (lane) lane.classList.add('racing-active');
            if (finishName) finishName.classList.remove('show');
        });
        
        // Calculate speeds based on scores - make differences MORE pronounced
        const maxScore = Math.max(...devRacers.map(r => r.score));
        const minScore = Math.min(...devRacers.map(r => r.score));
        const scoreRange = maxScore - minScore || 1;
        
        // Speed formula: normalize score to 0.3-1.0 range (faster cars are 3x faster than slowest)
        const speeds = devRacers.map(r => {
            const normalized = (r.score - minScore) / scoreRange; // 0 to 1
            return 0.3 + (normalized * 0.7); // 0.3 to 1.0
        });
        
        // Start animation
        devRaceInterval = setInterval(() => {
            let allFinished = true;
            
            devRacers.forEach((racer, index) => {
                if (racer.position < 100) {
                    // Small random variation (¬±10% of base speed) for excitement
                    const randomFactor = 0.9 + (Math.random() * 0.2);
                    racer.position = Math.min(100, racer.position + (speeds[index] * randomFactor));
                    
                    // Update car position visually - move across full container width
                    const car = document.getElementById(`devCar${index}`);
                    const container = car?.parentElement;
                    if (car && container) {
                        const containerWidth = container.offsetWidth - 40; // Leave room for car emoji
                        car.style.left = `${(racer.position / 100) * containerWidth}px`;
                    }
                    
                    // Show finish name when car reaches 90%
                    if (racer.position >= 90 && !racer.finished) {
                        racer.finished = true;
                        const finishName = document.getElementById(`devFinish${index}`);
                        if (finishName) finishName.classList.add('show');
                    }
                    
                    if (racer.position < 100) allFinished = false;
                }
            });
            
            // Check if race is complete
            if (allFinished) {
                finishDevRace();
            }
        }, 30); // Faster interval for smoother animation
    }
    
    function stopDevRace() {
        if (devRaceInterval) {
            clearInterval(devRaceInterval);
            devRaceInterval = null;
        }
        
        document.getElementById('devRaceStart').disabled = false;
        document.getElementById('devRaceStop').disabled = true;
        document.getElementById('devRaceStatus').innerHTML = '<span>‚èπÔ∏è</span> Stopped';
        document.getElementById('devRaceStatus').className = 'race-status';
        
        // Remove racing class
        devRacers.forEach((_, i) => {
            const car = document.getElementById(`devCar${i}`);
            const lane = document.querySelector(`[data-racer-index="${i}"]`);
            if (car) car.classList.remove('racing');
            if (lane) lane.classList.remove('racing-active');
        });
    }
    
    function finishDevRace() {
        clearInterval(devRaceInterval);
        devRaceInterval = null;
        
        // Update status
        document.getElementById('devRaceStatus').innerHTML = '<span>üèÜ</span> Finished!';
        document.getElementById('devRaceStatus').className = 'race-status finished';
        
        // Mark cars as finished, remove racing-active from lanes
        devRacers.forEach((_, i) => {
            const car = document.getElementById(`devCar${i}`);
            const lane = document.querySelector(`[data-racer-index="${i}"]`);
            if (car) {
                car.classList.remove('racing');
                car.classList.add('finished');
            }
            if (lane) lane.classList.remove('racing-active');
        });
        
        // Show winner celebration with FULL NAMES
        const trophies = ['ü•á', 'ü•à', 'ü•â'];
        const podiumHtml = devRacers.slice(0, 3).map((racer, i) => `
            <div class="winner-spot ${i === 0 ? 'first' : i === 1 ? 'second' : 'third'}">
                <div class="medal">${trophies[i]}</div>
                <div class="name">${racer.name}</div>
            </div>
        `).join('');
        
        document.getElementById('devWinnerPodium').innerHTML = podiumHtml;
        
        // Add confetti
        const celebration = document.getElementById('devWinnerCelebration');
        const colors = ['#fbbf24', '#22c55e', '#3b82f6', '#ef4444', '#a855f7'];
        for (let i = 0; i < 30; i++) {
            const confetti = document.createElement('div');
            confetti.className = 'confetti';
            confetti.style.left = `${Math.random() * 100}%`;
            confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
            confetti.style.animationDelay = `${Math.random() * 2}s`;
            confetti.style.animationDuration = `${2 + Math.random() * 2}s`;
            celebration.appendChild(confetti);
        }
        
        celebration.classList.add('show');
        
        // Auto restart after 5 seconds
        setTimeout(() => {
            // Remove confetti
            celebration.querySelectorAll('.confetti').forEach(c => c.remove());
            celebration.classList.remove('show');
            
            // Reset cars and hide finish names
            devRacers.forEach((racer, i) => {
                racer.position = 0;
                racer.finished = false;
                const car = document.getElementById(`devCar${i}`);
                const finishName = document.getElementById(`devFinish${i}`);
                if (car) {
                    car.style.left = '0px';
                    car.classList.remove('finished');
                }
                if (finishName) finishName.classList.remove('show');
            });
            
            document.getElementById('devRaceStart').disabled = false;
            document.getElementById('devRaceStop').disabled = true;
            document.getElementById('devRaceStatus').innerHTML = '<span>‚è∏Ô∏è</span> Ready';
            document.getElementById('devRaceStatus').className = 'race-status';
        }, 5000);
    }
    
    /*
    updateQARaceTrack()
    -------------------
    PURPOSE: Creates a race track visualization for QA team performance
    
    SCORING FORMULA:
    - Bugs Found √ó 5 points (rewards finding issues)
    - Verified √ó 10 points (rewards completing verification)
    - Enhancements √ó 8 points (rewards testing improvements)
    - Hours Logged √ó 2 points (rewards effort/time investment)
    
    INTERPRETATION:
    - Higher score = further ahead in the race
    - All metrics are positive (QA work is all valuable)
    */
    function updateQARaceTrack() {
        const data = getUniqueByKey(filteredData);
        const qaStats = {};
        
        // Collect stats for each QA member
        data.forEach(row => {
            const qa = row.QA;
            if (!qa) return;
            
            const qaLower = qa.toLowerCase();
            if (!QA_TEAM.some(member => qaLower.includes(member))) return;
            
            if (!qaStats[qa]) qaStats[qa] = { found: 0, verified: 0, imp: 0, time: 0 };
            
            const type = row['Issue Type'];
            if (['Bug', 'Reassigned Bug'].includes(type)) {
                qaStats[qa].found++;
                if (['Done', 'Released'].some(s => (row.Status || '').includes(s))) {
                    qaStats[qa].verified++;
                }
            }
            if (type === 'Improvement') qaStats[qa].imp++;
        });
        
        // Get time from QA Tasks
        data.filter(row => row['Issue Type'] === 'QA Task').forEach(row => {
            const assignee = row.Assignee;
            if (qaStats[assignee]) qaStats[assignee].time += row['Time Spent'] || 0;
        });
        
        // Calculate scores and store globally for animation
        qaRacers = Object.entries(qaStats).map(([name, stats]) => {
            const hours = Math.round(stats.time / 3600);
            const score = (stats.found * 5) + (stats.verified * 10) + (stats.imp * 8) + (hours * 2);
            return {
                name,
                score: Math.max(score, 1), // Minimum 1 point for animation
                stats,
                statsText: `üêõ${stats.found} ‚úÖ${stats.verified} üí°${stats.imp} ‚è±Ô∏è${hours}h`,
                position: 0 // Current race position (0-100%)
            };
        });
        
        // Sort by score descending
        qaRacers.sort((a, b) => b.score - a.score);
        
        // Vehicle emojis for QA
        const cars = ['üöÄ', '‚úàÔ∏è', 'üöÅ', 'üõ∏', 'üöÇ', '‚õµ', 'üö§', 'üõ∂'];
        const trophies = ['ü•á', 'ü•à', 'ü•â'];
        
        // Render race lanes with animation elements
        const lanesHtml = qaRacers.map((racer, index) => {
            const position = index + 1;
            const positionClass = position === 1 ? 'gold' : position === 2 ? 'silver' : position === 3 ? 'bronze' : 'other';
            const laneClass = position === 1 ? 'first-place' : position === 2 ? 'second-place' : position === 3 ? 'third-place' : '';
            const car = cars[index % cars.length];
            const trophy = position <= 3 ? `<span class="podium-trophy">${trophies[position-1]}</span>` : '';
            
            return `
                <div class="race-lane ${laneClass}" data-racer-index="${index}">
                    <div class="race-lane-track"></div>
                    <div class="racer-position ${positionClass}">${position}</div>
                    <div class="racer-car-container">
                        <span class="racer-car" id="qaCar${index}">${car}</span>
                        <div class="speed-lines">
                            <div class="speed-line" style="width: 15px;"></div>
                            <div class="speed-line" style="width: 20px;"></div>
                            <div class="speed-line" style="width: 12px;"></div>
                        </div>
                    </div>
                    <div class="racer-info">
                        <div class="racer-name">${racer.name}${trophy}</div>
                        <div class="racer-stats">${racer.statsText}</div>
                    </div>
                    <div class="finish-name" id="qaFinish${index}">${racer.name} üèÅ</div>
                    <div class="racer-score">${racer.score} pts</div>
                </div>
            `;
        }).join('');
        
        document.getElementById('qaTrackLanes').innerHTML = lanesHtml || 
            '<p style="text-align:center;color:#94a3b8;padding:2rem">No QA data available</p>';
        
        // Update podium display
        const podiumHtml = qaRacers.slice(0, 3).map((racer, index) => {
            const spotClass = index === 0 ? 'first' : index === 1 ? 'second' : 'third';
            const firstName = racer.name.split(' ')[0];
            return `
                <div class="podium-spot ${spotClass}">
                    <div class="podium-block">${trophies[index]}</div>
                    <div class="podium-name">${firstName}</div>
                </div>
            `;
        }).join('');
        
        document.getElementById('qaPodium').innerHTML = podiumHtml;
        
        // Reset race state
        document.getElementById('qaWinnerCelebration').classList.remove('show');
        document.getElementById('qaRaceStatus').innerHTML = '<span>‚è∏Ô∏è</span> Ready';
        document.getElementById('qaRaceStatus').className = 'race-status';
    }
    
    function startQARace() {
        if (qaRacers.length === 0) return;
        
        // Reset positions
        qaRacers.forEach(r => {
            r.position = 0;
            r.finished = false;
        });
        
        // Update UI
        document.getElementById('qaRaceStart').disabled = true;
        document.getElementById('qaRaceStop').disabled = false;
        document.getElementById('qaRaceStatus').innerHTML = '<span>üèÅ</span> Racing...';
        document.getElementById('qaRaceStatus').className = 'race-status racing';
        document.getElementById('qaWinnerCelebration').classList.remove('show');
        
        // Add racing class to cars and lanes, hide finish names
        qaRacers.forEach((_, i) => {
            const car = document.getElementById(`qaCar${i}`);
            const lane = document.querySelector(`#qaTrackLanes [data-racer-index="${i}"]`);
            const finishName = document.getElementById(`qaFinish${i}`);
            if (car) {
                car.classList.add('racing');
                car.style.left = '0%';
            }
            if (lane) lane.classList.add('racing-active');
            if (finishName) finishName.classList.remove('show');
        });
        
        // Calculate speeds based on scores - make differences MORE pronounced
        const maxScore = Math.max(...qaRacers.map(r => r.score));
        const minScore = Math.min(...qaRacers.map(r => r.score));
        const scoreRange = maxScore - minScore || 1;
        
        // Speed formula: normalize score to 0.3-1.0 range (faster cars are 3x faster than slowest)
        const speeds = qaRacers.map(r => {
            const normalized = (r.score - minScore) / scoreRange; // 0 to 1
            return 0.3 + (normalized * 0.7); // 0.3 to 1.0
        });
        
        // Start animation
        qaRaceInterval = setInterval(() => {
            let allFinished = true;
            
            qaRacers.forEach((racer, index) => {
                if (racer.position < 100) {
                    // Small random variation (¬±10% of base speed) for excitement
                    const randomFactor = 0.9 + (Math.random() * 0.2);
                    racer.position = Math.min(100, racer.position + (speeds[index] * randomFactor));
                    
                    // Update car position visually - move across full container width
                    const car = document.getElementById(`qaCar${index}`);
                    const container = car?.parentElement;
                    if (car && container) {
                        const containerWidth = container.offsetWidth - 40; // Leave room for car emoji
                        car.style.left = `${(racer.position / 100) * containerWidth}px`;
                    }
                    
                    // Show finish name when car reaches 90%
                    if (racer.position >= 90 && !racer.finished) {
                        racer.finished = true;
                        const finishName = document.getElementById(`qaFinish${index}`);
                        if (finishName) finishName.classList.add('show');
                    }
                    
                    if (racer.position < 100) allFinished = false;
                }
            });
            
            // Check if race is complete
            if (allFinished) {
                finishQARace();
            }
        }, 30); // Faster interval for smoother animation
    }
    
    function stopQARace() {
        if (qaRaceInterval) {
            clearInterval(qaRaceInterval);
            qaRaceInterval = null;
        }
        
        document.getElementById('qaRaceStart').disabled = false;
        document.getElementById('qaRaceStop').disabled = true;
        document.getElementById('qaRaceStatus').innerHTML = '<span>‚èπÔ∏è</span> Stopped';
        document.getElementById('qaRaceStatus').className = 'race-status';
        
        // Remove racing class
        qaRacers.forEach((_, i) => {
            const car = document.getElementById(`qaCar${i}`);
            const lane = document.querySelector(`#qaTrackLanes [data-racer-index="${i}"]`);
            if (car) car.classList.remove('racing');
            if (lane) lane.classList.remove('racing-active');
        });
    }
    
    function finishQARace() {
        clearInterval(qaRaceInterval);
        qaRaceInterval = null;
        
        // Update status
        document.getElementById('qaRaceStatus').innerHTML = '<span>üèÜ</span> Finished!';
        document.getElementById('qaRaceStatus').className = 'race-status finished';
        
        // Mark cars as finished, remove racing-active from lanes
        qaRacers.forEach((_, i) => {
            const car = document.getElementById(`qaCar${i}`);
            const lane = document.querySelector(`#qaTrackLanes [data-racer-index="${i}"]`);
            if (car) {
                car.classList.remove('racing');
                car.classList.add('finished');
            }
            if (lane) lane.classList.remove('racing-active');
        });
        
        // Show winner celebration with FULL NAMES
        const trophies = ['ü•á', 'ü•à', 'ü•â'];
        const podiumHtml = qaRacers.slice(0, 3).map((racer, i) => `
            <div class="winner-spot ${i === 0 ? 'first' : i === 1 ? 'second' : 'third'}">
                <div class="medal">${trophies[i]}</div>
                <div class="name">${racer.name}</div>
            </div>
        `).join('');
        
        document.getElementById('qaWinnerPodium').innerHTML = podiumHtml;
        
        // Add confetti
        const celebration = document.getElementById('qaWinnerCelebration');
        const colors = ['#fbbf24', '#22c55e', '#3b82f6', '#ef4444', '#a855f7'];
        for (let i = 0; i < 30; i++) {
            const confetti = document.createElement('div');
            confetti.className = 'confetti';
            confetti.style.left = `${Math.random() * 100}%`;
            confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
            confetti.style.animationDelay = `${Math.random() * 2}s`;
            confetti.style.animationDuration = `${2 + Math.random() * 2}s`;
            celebration.appendChild(confetti);
        }
        
        celebration.classList.add('show');
        
        // Auto restart after 5 seconds
        setTimeout(() => {
            // Remove confetti
            celebration.querySelectorAll('.confetti').forEach(c => c.remove());
            celebration.classList.remove('show');
            
            // Reset cars and hide finish names
            qaRacers.forEach((racer, i) => {
                racer.position = 0;
                racer.finished = false;
                const car = document.getElementById(`qaCar${i}`);
                const finishName = document.getElementById(`qaFinish${i}`);
                if (car) {
                    car.style.left = '0px';
                    car.classList.remove('finished');
                }
                if (finishName) finishName.classList.remove('show');
            });
            
            document.getElementById('qaRaceStart').disabled = false;
            document.getElementById('qaRaceStop').disabled = true;
            document.getElementById('qaRaceStatus').innerHTML = '<span>‚è∏Ô∏è</span> Ready';
            document.getElementById('qaRaceStatus').className = 'race-status';
        }, 5000);
    }
    
    /*
    ============================================================================
    SECTION: UTILITY FUNCTIONS
    ============================================================================
    Helper functions used throughout the dashboard.
    */
    
    /*
    formatDate(date)
    ----------------
    PURPOSE: Converts Date object to YYYY-MM-DD string for input fields
    */
    function formatDate(date) {
        return date.toISOString().split('T')[0];
    }
    
    /*
    getUniqueByKey(dataArray)
    -------------------------
    PURPOSE: Removes duplicate rows based on the Key column
    
    HOW IT WORKS:
    - Uses a Set to track which Keys have been seen
    - Only keeps the first occurrence of each Key
    - Handles different column name variations (Key, key, KEY)
    
    PARAMETERS:
    - dataArray: Array of row objects to deduplicate
    
    RETURNS: New array with duplicates removed
    
    WHY NEEDED:
    - Jira exports can include the same issue multiple times
      (e.g., if an issue appears in multiple sprints)
    - Without deduplication, counts would be inflated
    */
    function getUniqueByKey(dataArray) {
        const seenKeys = new Set();
        return dataArray.filter(row => {
            const key = row.Key || row.key || row.KEY;
            if (!key) return true; // Keep rows without keys
            if (seenKeys.has(key)) return false; // Skip duplicate
            seenKeys.add(key);
            return true;
        });
    }
    
    /*
    toggleFullscreen()
    ------------------
    PURPOSE: Toggles browser fullscreen mode
    */
    function toggleFullscreen() {
        if (!document.fullscreenElement) {
            document.documentElement.requestFullscreen();
        } else {
            document.exitFullscreen();
        }
    }
    
    /*
    toggleFilters()
    ---------------
    PURPOSE: Expands/collapses the main filters section
    */
    function toggleFilters() {
        document.getElementById('filtersWrapper').classList.toggle('collapsed');
    }
    
    /*
    ============================================================================
    SECTION: THEME TOGGLE (DARK/LIGHT MODE)
    ============================================================================
    */
    
    /*
    toggleTheme()
    -------------
    PURPOSE: Switches between dark and light mode
    */
    function toggleTheme() {
        const body = document.body;
        const themeIcon = document.getElementById('themeIcon');
        const themeLabel = document.getElementById('themeLabel');
        
        body.classList.toggle('light-mode');
        
        const isLightMode = body.classList.contains('light-mode');
        
        // Update button appearance
        themeIcon.textContent = isLightMode ? '‚òÄÔ∏è' : 'üåô';
        themeLabel.textContent = isLightMode ? 'Light' : 'Dark';
        
        // Save preference to localStorage
        localStorage.setItem('dashboard-theme', isLightMode ? 'light' : 'dark');
        
        // Update charts with new colors
        updateChartsTheme();
    }
    
    /*
    initTheme()
    -----------
    PURPOSE: Loads saved theme preference on page load
    */
    function initTheme() {
        const savedTheme = localStorage.getItem('dashboard-theme');
        const themeIcon = document.getElementById('themeIcon');
        const themeLabel = document.getElementById('themeLabel');
        
        if (savedTheme === 'light') {
            document.body.classList.add('light-mode');
            themeIcon.textContent = '‚òÄÔ∏è';
            themeLabel.textContent = 'Light';
        }
    }
    
    /*
    updateChartsTheme()
    -------------------
    PURPOSE: Updates chart colors when theme changes
    */
    function updateChartsTheme() {
        const isLightMode = document.body.classList.contains('light-mode');
        const textColor = isLightMode ? '#64748b' : '#94a3b8';
        const gridColor = isLightMode ? 'rgba(100,116,139,0.15)' : 'rgba(148,163,184,0.1)';
        
        // Update all charts with new colors
        Object.values(charts).forEach(chart => {
            if (chart && chart.options) {
                if (chart.options.scales) {
                    if (chart.options.scales.x) {
                        chart.options.scales.x.ticks = { ...chart.options.scales.x.ticks, color: textColor };
                        chart.options.scales.x.grid = { ...chart.options.scales.x.grid, color: gridColor };
                    }
                    if (chart.options.scales.y) {
                        chart.options.scales.y.ticks = { ...chart.options.scales.y.ticks, color: textColor };
                        chart.options.scales.y.grid = { ...chart.options.scales.y.grid, color: gridColor };
                    }
                }
                if (chart.options.plugins && chart.options.plugins.legend && chart.options.plugins.legend.labels) {
                    chart.options.plugins.legend.labels.color = textColor;
                }
                chart.update();
            }
        });
    }
    
    // Initialize theme on page load
    initTheme();
    
    /*
    toggleFilterSection(sectionId)
    ------------------------------
    PURPOSE: Expands/collapses individual filter sections
    */
    function toggleFilterSection(sectionId) {
        document.getElementById(sectionId).classList.toggle('collapsed');
    }
    
    /*
    toggleGroup(groupId, headerRow)
    -------------------------------
    PURPOSE: Expands/collapses collapsible table rows
    
    PARAMETERS:
    - groupId: CSS class of detail rows to toggle
    - headerRow: The clicked header row element
    */
    function toggleGroup(groupId, headerRow) {
        const rows = document.querySelectorAll(`.${groupId}`);
        const isExpanded = headerRow.classList.contains('expanded');
        
        headerRow.classList.toggle('expanded');
        rows.forEach(row => row.classList.toggle('visible', !isExpanded));
    }
    
    function expandAllGroups(tableId) {
        const table = document.getElementById(tableId);
        if (!table) return;
        
        const headers = table.querySelectorAll('.group-header');
        headers.forEach(header => {
            header.classList.add('expanded');
            const onclick = header.getAttribute('onclick') || '';
            const match = onclick.match(/toggleGroup\('([^']+)'/);
            if (match) {
                const groupId = match[1];
                document.querySelectorAll(`.${groupId}`).forEach(row => row.classList.add('visible'));
            }
        });
    }
    
    function collapseAllGroups(tableId) {
        const table = document.getElementById(tableId);
        if (!table) return;
        
        const headers = table.querySelectorAll('.group-header');
        headers.forEach(header => {
            header.classList.remove('expanded');
            const onclick = header.getAttribute('onclick') || '';
            const match = onclick.match(/toggleGroup\('([^']+)'/);
            if (match) {
                const groupId = match[1];
                document.querySelectorAll(`.${groupId}`).forEach(row => row.classList.remove('visible'));
            }
        });
    }
    
    /*
    searchTable(tableId, searchText)
    --------------------------------
    PURPOSE: Search within a collapsible table
    
    HOW IT WORKS:
    - Searches group headers and detail rows
    - Shows matching groups and their details
    - Case-insensitive search
    */
    function searchTable(tableId, searchText) {
        const table = document.getElementById(tableId);
        if (!table) return;
        
        const search = searchText.toLowerCase().trim();
        const tbody = table.querySelector('tbody');
        if (!tbody) return;
        
        const rows = tbody.querySelectorAll('tr');
        
        if (!search) {
            // Show all group headers, hide all detail rows (unless expanded)
            rows.forEach(row => {
                if (row.classList.contains('group-header')) {
                    row.style.display = '';
                } else if (row.classList.contains('detail-row')) {
                    // Keep expanded state
                    if (!row.classList.contains('visible')) {
                        row.style.display = '';
                    }
                }
            });
            return;
        }
        
        // Track which groups have matches
        const groupMatches = new Set();
        let currentGroupId = null;
        
        rows.forEach(row => {
            if (row.classList.contains('group-header')) {
                // Extract group ID from onclick
                const onclick = row.getAttribute('onclick') || '';
                const match = onclick.match(/toggleGroup\('([^']+)'/);
                currentGroupId = match ? match[1] : null;
                
                const headerText = row.textContent.toLowerCase();
                if (headerText.includes(search)) {
                    groupMatches.add(currentGroupId);
                }
            } else if (row.classList.contains('detail-row') && currentGroupId) {
                const rowText = row.textContent.toLowerCase();
                if (rowText.includes(search)) {
                    groupMatches.add(currentGroupId);
                }
            }
        });
        
        // Show/hide rows based on matches
        currentGroupId = null;
        rows.forEach(row => {
            if (row.classList.contains('group-header')) {
                const onclick = row.getAttribute('onclick') || '';
                const match = onclick.match(/toggleGroup\('([^']+)'/);
                currentGroupId = match ? match[1] : null;
                
                if (groupMatches.has(currentGroupId)) {
                    row.style.display = '';
                    // Auto-expand matching groups
                    row.classList.add('expanded');
                } else {
                    row.style.display = 'none';
                    row.classList.remove('expanded');
                }
            } else if (row.classList.contains('detail-row')) {
                // Get group ID from class
                const classes = [...row.classList];
                const groupClass = classes.find(c => c !== 'detail-row' && c !== 'visible');
                
                if (groupClass && groupMatches.has(groupClass)) {
                    row.style.display = '';
                    row.classList.add('visible');
                } else {
                    row.style.display = 'none';
                    row.classList.remove('visible');
                }
            }
        });
    }
    
    /*
    openSheetsModal() / closeSheetsModal()
    --------------------------------------
    PURPOSE: Show/hide the Google Sheets connection dialog
    */
    function openSheetsModal() {
        document.getElementById('sheetsModal').classList.remove('hidden');
    }
    
    function closeSheetsModal() {
        document.getElementById('sheetsModal').classList.add('hidden');
    }
    
    /*
    loadFromConfiguredSheets()
    --------------------------
    PURPOSE: Auto-loads data from pre-configured Google Sheets API
    Called on page load if GOOGLE_SHEET_CONFIG.enabled is true
    
    NOTE: Uses Google Sheets API v4 which returns JSON format
    */
    function loadFromConfiguredSheets() {
        if (!GOOGLE_SHEET_CONFIG.url) return;
        
        document.getElementById('loadingOverlay').classList.remove('hidden');
        
        fetch(GOOGLE_SHEET_CONFIG.url)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                // Google Sheets API returns { values: [[headers], [row1], [row2], ...] }
                rawData = parseGoogleSheetsApiResponse(data);
                onDataLoaded('Google Sheets (Auto)');
            })
            .catch(error => {
                console.error('Auto-load from Sheets failed:', error);
                document.getElementById('loadingOverlay').classList.add('hidden');
                alert('Failed to load data from Google Sheets.\n\nPlease check:\n1. The sheet is shared as "Anyone with the link can view"\n2. The API key is valid\n3. Your internet connection\n\nYou can try the "Refresh Data" button or upload an Excel file.\n\nError: ' + error.message);
            });
    }
    
    /*
    parseGoogleSheetsApiResponse(data)
    ----------------------------------
    PURPOSE: Converts Google Sheets API response to array of objects
    
    INPUT FORMAT (from API):
    {
      "range": "Sheet1!A1:Z1000",
      "majorDimension": "ROWS",
      "values": [
        ["Key", "Issue Type", "Summary", ...],  // Headers
        ["PROJ-1", "Bug", "Fix login", ...],    // Data row 1
        ["PROJ-2", "Story", "Add feature", ...] // Data row 2
      ]
    }
    
    OUTPUT FORMAT:
    [
      { "Key": "PROJ-1", "Issue Type": "Bug", "Summary": "Fix login", ... },
      { "Key": "PROJ-2", "Issue Type": "Story", "Summary": "Add feature", ... }
    ]
    */
    function parseGoogleSheetsApiResponse(data) {
        if (!data.values || data.values.length < 2) {
            console.warn('No data found in Google Sheets response');
            return [];
        }
        
        const headers = data.values[0]; // First row is headers
        const rows = data.values.slice(1); // Rest are data rows
        
        return rows.map(row => {
            const obj = {};
            headers.forEach((header, index) => {
                obj[header] = row[index] !== undefined ? row[index] : '';
            });
            return processRow(obj);
        });
    }
    
    /*
    refreshFromSheets()
    -------------------
    PURPOSE: Manually refreshes data from the configured Google Sheets API
    Called when user clicks "Refresh Data" button
    */
    function refreshFromSheets() {
        if (!GOOGLE_SHEET_CONFIG.url) {
            alert('Google Sheets URL is not configured.');
            return;
        }
        
        document.getElementById('loadingOverlay').classList.remove('hidden');
        
        fetch(GOOGLE_SHEET_CONFIG.url)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                // Google Sheets API returns { values: [[headers], [row1], [row2], ...] }
                rawData = parseGoogleSheetsApiResponse(data);
                onDataLoaded('Google Sheets');
                
                // Show brief success notification
                showNotification('‚úÖ Data refreshed successfully!', 'success');
            })
            .catch(error => {
                console.error('Refresh from Sheets failed:', error);
                document.getElementById('loadingOverlay').classList.add('hidden');
                showNotification('‚ùå Failed to refresh: ' + error.message, 'error');
            });
    }
    
    /*
    showNotification(message, type)
    -------------------------------
    PURPOSE: Shows a brief notification message
    */
    function showNotification(message, type = 'info') {
        // Remove existing notification if any
        const existing = document.querySelector('.notification-toast');
        if (existing) existing.remove();
        
        const toast = document.createElement('div');
        toast.className = 'notification-toast ' + type;
        toast.innerHTML = message;
        toast.style.cssText = `
            position: fixed;
            top: 80px;
            right: 20px;
            padding: 12px 20px;
            background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#6366f1'};
            color: white;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.9rem;
            z-index: 10000;
            animation: slideIn 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        `;
        document.body.appendChild(toast);
        
        // Auto remove after 3 seconds
        setTimeout(() => {
            toast.style.animation = 'slideOut 0.3s ease';
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }
    
    // Set up auto-refresh if configured
    if (GOOGLE_SHEET_CONFIG.autoRefreshInterval > 0) {
        setInterval(() => {
            console.log('Auto-refreshing data from Google Sheets...');
            refreshFromSheets();
        }, GOOGLE_SHEET_CONFIG.autoRefreshInterval);
    }
    
    // AUTO-LOAD: Fetch data from Google Sheets when page loads
    window.addEventListener('DOMContentLoaded', () => {
        console.log('Page loaded - auto-fetching data from Google Sheets...');
        refreshFromSheets();
        
        // Initialize tooltips with fixed positioning
        initTooltips();
    });
    
    // Tooltip system with fixed positioning (no clipping)
    function initTooltips() {
        // Create tooltip element if it doesn't exist
        let tooltipEl = document.getElementById('globalTooltip');
        if (!tooltipEl) {
            tooltipEl = document.createElement('div');
            tooltipEl.id = 'globalTooltip';
            tooltipEl.className = 'tooltip-text';
            document.body.appendChild(tooltipEl);
        }
        
        // Event delegation for all tooltips
        document.addEventListener('mouseenter', function(e) {
            if (e.target.classList.contains('info-tooltip')) {
                const tooltip = e.target.getAttribute('data-tooltip');
                if (tooltip) {
                    tooltipEl.textContent = tooltip;
                    tooltipEl.classList.add('visible');
                    
                    // Position tooltip
                    const rect = e.target.getBoundingClientRect();
                    const tooltipRect = tooltipEl.getBoundingClientRect();
                    
                    let left = rect.left + (rect.width / 2) - (tooltipEl.offsetWidth / 2);
                    let top = rect.top - tooltipEl.offsetHeight - 8;
                    
                    // Keep within viewport
                    if (left < 10) left = 10;
                    if (left + tooltipEl.offsetWidth > window.innerWidth - 10) {
                        left = window.innerWidth - tooltipEl.offsetWidth - 10;
                    }
                    if (top < 10) {
                        top = rect.bottom + 8; // Show below if not enough space above
                    }
                    
                    tooltipEl.style.left = left + 'px';
                    tooltipEl.style.top = top + 'px';
                }
            }
        }, true);
        
        document.addEventListener('mouseleave', function(e) {
            if (e.target.classList.contains('info-tooltip')) {
                tooltipEl.classList.remove('visible');
            }
        }, true);
    }
    
    // Keyboard shortcut: F11 for fullscreen
    document.addEventListener('keydown', e => {
        if (e.key === 'F11') {
            e.preventDefault();
            toggleFullscreen();
        }
    });
    
    /*
    ============================================================================
    END OF JAVASCRIPT
    ============================================================================
    
    TROUBLESHOOTING TIPS:
    
    1. Open browser Developer Tools (F12) to see error messages
    2. Check Console tab for JavaScript errors
    3. Check Network tab if data isn't loading
    4. Verify column names in your Excel match exactly
    
    COMMON ISSUES:
    
    - "Cannot read property of undefined" - Column name doesn't match
    - Charts not showing - Check if filteredData has any rows
    - Dates not filtering - Ensure dates are proper Date objects
    - Team not matching - Check lowercase spelling in team arrays
    
    ============================================================================
    */
    </script>
</body>
</html>
